<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Critical Theme Flash Prevention -->
    <script>
    (function(){
        var t=localStorage.getItem("selectedTheme")||"professional";
        var h=document.documentElement;
        
        h.classList.add(t+"-mode");
        
        // Load theme CSS immediately
        var existingTheme = document.querySelector('link[data-theme-css]');
        if(existingTheme) existingTheme.remove();
        
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/css/themes/' + t + '.css';
        link.setAttribute('data-theme-css', t);
        document.head.appendChild(link);
        // Add body class when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if(document.body) document.body.classList.add(t+"-mode");
        });
        
        if(t==="classic"){h.style.backgroundColor="#008080";}
        else if(t==="modern"){h.style.background="linear-gradient(135deg,#667eea 0%,#764ba2 100%)";}
        else if(t==="professional"){h.style.background="linear-gradient(-45deg,#f8fafc,#e2e8f0,#cbd5e1,#94a3b8)";}
        else{h.style.background="linear-gradient(-45deg,#059669,#10b981,#34d399,#a7f3d0)";}
        h.style.visibility="hidden";
        setTimeout(function(){h.style.visibility="visible";h.style.transition="opacity 0.2s";h.style.opacity="1";},50);
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reports - SyncedUp Insurance Agent</title>
    <link rel="stylesheet" href="/agent/agent-global.css">
    
    <!-- Auth Guard Script - Must be loaded in HEAD before content renders -->
    <script>
        (function () {
          const token = localStorage.getItem('syncedup_token');
          const u = JSON.parse(localStorage.getItem('syncedup_user') || '{}');
          const normalize = r => ({'super-admin':'super_admin','customer-service':'customer_service'}[r] || r);
          const role = normalize(u.role || '');
          const allowed = ['agent','manager','admin','super_admin'];
          if (!token || !role || !allowed.includes(role)) { window.location.href = '/login'; return; }
        })();
    </script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Sales Reports</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span id="userDisplay">Loading...</span>
            <button class="btn" onclick="logout()">
                <i data-lucide="log-out" class="icon"></i>
                Logout
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <a href="/agent" class="nav-link">
            <i data-lucide="layout-dashboard" class="icon"></i>
            Dashboard
        </a>
        <a href="/agent/quotes" class="nav-link">
            <i data-lucide="calculator" class="icon"></i>
            Quote Products
        </a>
        <a href="/agent/commissions" class="nav-link">
            <i data-lucide="dollar-sign" class="icon"></i>
            My Commissions
        </a>
        <a href="/agent/settings" class="nav-link">
            <i data-lucide="settings" class="icon"></i>
            Settings
        </a>
        <a href="/global-leaderboard" class="nav-link">
            <i data-lucide="trophy" class="icon"></i>
            Global Leaderboard
        </a>
    </div>

    <div class="container">
        <!-- Agent Notice -->
        <div class="agent-notice">
            <h3><i data-lucide="trending-up"></i> Sales Performance</h3>
            <p>Track your sales performance, analyze trends, and manage your sales pipeline effectively.</p>
        </div>
        
        <!-- Sales Summary Stats -->
        <div class="grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSales">0</div>
                <div class="stat-label">Total Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlySales">0</div>
                <div class="stat-label">This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="salesRevenue">$0</div>
                <div class="stat-label">Sales Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>

        <!-- Sales Performance Chart -->
        <div class="card">
            <h3><i data-lucide="bar-chart" class="card-icon"></i>Sales Performance</h3>
            <div style="height: 300px; margin-top: 1rem; position: relative;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Record New Sale -->
        <div class="card">
            <h3><i data-lucide="plus-circle" class="card-icon"></i>Record New Sale</h3>
            
            <form id="recordSaleForm">
                <div class="grid" style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" id="customerName" class="form-input" placeholder="Enter customer name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Email</label>
                        <input type="email" id="customerEmail" class="form-input" placeholder="customer@email.com" required>
                    </div>
                </div>

                <div class="grid" style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Product</label>
                        <select id="productId" class="form-select" required>
                            <option value="">Select Product</option>
                            <option value="health_premium">Health Plan Premium</option>
                            <option value="life_gold">Life Insurance Gold</option>
                            <option value="auto_plus">Auto Coverage Plus</option>
                            <option value="home_protection">Home Protection Plan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Amount</label>
                        <input type="number" id="saleAmount" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="grid" style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Commission Rate (%)</label>
                        <input type="number" id="commissionRate" class="form-input" value="10" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Commission Amount</label>
                        <input type="text" id="commissionAmount" class="form-input" readonly placeholder="$0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="saleNotes" class="form-input" rows="3" placeholder="Additional notes about this sale..."></textarea>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save"></i>
                        Record Sale
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearSaleForm()">
                        <i data-lucide="x"></i>
                        Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Recent Sales -->
        <div class="card">
            <h3><i data-lucide="list" class="card-icon"></i>Recent Sales</h3>
            
            <div style="margin-bottom: 1rem;">
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="loadSalesData()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh
                    </button>
                    <button class="btn btn-warning" onclick="exportSales()">
                        <i data-lucide="download"></i>
                        Export Sales
                    </button>
                </div>
            </div>

            <div id="salesList">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Amount</th>
                            <th>Commission</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">
                                <div class="loading"></div>
                                Loading sales data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Analytics -->
        <div class="grid">
            <div class="card">
                <h3><i data-lucide="pie-chart" class="card-icon"></i>Product Mix</h3>
                <div style="height: 250px; margin-top: 1rem; position: relative;">
                    <canvas id="productMixChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3><i data-lucide="calendar" class="card-icon"></i>Monthly Targets</h3>
                <div style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Sales Goal</span>
                        <span id="salesGoalText">0 / 15</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="salesGoalProgress" style="width: 0%"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; margin-top: 1rem;">
                        <span>Revenue Goal</span>
                        <span id="revenueGoalText">$0 / $50,000</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="revenueGoalProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let salesChart = null;
        let productMixChart = null;

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('syncedup_token');
            const user = JSON.parse(localStorage.getItem('syncedup_user') || '{}');
            
            if (!token || !user.email) {
                window.location.href = '/login.html';
                return false;
            }

            // Check if user has agent permissions
            if (!['agent', 'manager', 'admin', 'super-admin'].includes(user.role)) {
                alert('Access denied. Agent permissions required.');
                window.location.href = '/login.html';
                return false;
            }

            document.getElementById('userDisplay').textContent = `${user.firstName} ${user.lastName} (${user.role})`;
            currentUser = user;
            return true;
        }

        // Initialize page
        async function initializePage() {
            if (!checkAuth()) return;
            
            // Load sales data
            await loadSalesData();
            
            // Initialize charts
            initializeCharts();
            
            // Setup form handlers
            setupFormHandlers();
            
            // Initialize Lucide icons
            lucide.createIcons();
        }

        // Setup form handlers
        function setupFormHandlers() {
            // Commission calculation
            document.getElementById('saleAmount').addEventListener('input', calculateCommission);
            document.getElementById('commissionRate').addEventListener('input', calculateCommission);

            // Form submission
            document.getElementById('recordSaleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await recordSale();
            });
        }

        // Calculate commission amount
        function calculateCommission() {
            const saleAmount = parseFloat(document.getElementById('saleAmount').value) || 0;
            const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;
            const commissionAmount = (saleAmount * commissionRate / 100);
            
            document.getElementById('commissionAmount').value = `$${commissionAmount.toFixed(2)}`;
        }

        // Record new sale
        async function recordSale() {
            const saleData = {
                id: `S-${Date.now()}`,
                agentId: currentUser.id,
                customer: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmail').value,
                product: document.getElementById('productId').options[document.getElementById('productId').selectedIndex].text,
                productId: document.getElementById('productId').value,
                amount: parseFloat(document.getElementById('saleAmount').value),
                commission: parseFloat(document.getElementById('commissionAmount').value.replace('$', '')),
                notes: document.getElementById('saleNotes').value,
                createdAt: new Date().toISOString(),
                status: 'completed'
            };

            try {
                // In real implementation, this would make an API call
                console.log('Recording sale:', saleData);
                
                alert('Sale recorded successfully!');
                clearSaleForm();
                await loadSalesData();
                
            } catch (error) {
                console.error('Error recording sale:', error);
                alert('Failed to record sale. Please try again.');
            }
        }

        // Load sales data
        async function loadSalesData() {
            try {
                // Load sales statistics
                await loadSalesStats();
                await loadRecentSales();
                await updateCharts();
                await loadGoalProgress();
            } catch (error) {
                console.error('Error loading sales data:', error);
                loadFallbackData();
            }
        }

        // Load sales statistics
        async function loadSalesStats() {
            try {
                // In real implementation, these would come from API calls
                document.getElementById('totalSales').textContent = '0';
                document.getElementById('monthlySales').textContent = '0';
                document.getElementById('salesRevenue').textContent = '$0';
                document.getElementById('conversionRate').textContent = '0%';
            } catch (error) {
                console.error('Failed to load sales stats:', error);
            }
        }

        // Load recent sales
        async function loadRecentSales() {
            const tableBody = document.getElementById('salesTableBody');
            
            try {
                // Show empty state for now - would connect to API in real implementation
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">
                            No sales recorded yet. Use the form above to record your first sale.
                        </td>
                    </tr>
                `;
            } catch (error) {
                console.error('Failed to load sales:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #ff6b6b; padding: 2rem;">
                            Error loading sales data. Please refresh the page.
                        </td>
                    </tr>
                `;
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Sales performance chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Monthly Sales',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Product mix chart
            const productCtx = document.getElementById('productMixChart').getContext('2d');
            productMixChart = new Chart(productCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Health', 'Life', 'Auto', 'Home'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#34d399',
                            '#60a5fa',
                            '#fbbf24',
                            '#f87171'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
        }

        // Update charts with data
        async function updateCharts() {
            // Update with real data when API is available
            // For now, charts remain with default empty state
        }

        // Load goal progress
        async function loadGoalProgress() {
            try {
                const salesGoal = 15;
                const currentSales = 0;
                const salesProgress = (currentSales / salesGoal) * 100;

                const revenueGoal = 50000;
                const currentRevenue = 0;
                const revenueProgress = (currentRevenue / revenueGoal) * 100;

                document.getElementById('salesGoalText').textContent = `${currentSales} / ${salesGoal}`;
                document.getElementById('salesGoalProgress').style.width = `${salesProgress}%`;
                
                document.getElementById('revenueGoalText').textContent = `$${currentRevenue.toLocaleString()} / $${revenueGoal.toLocaleString()}`;
                document.getElementById('revenueGoalProgress').style.width = `${revenueProgress}%`;
            } catch (error) {
                console.error('Failed to load goals:', error);
            }
        }

        // Clear sale form
        function clearSaleForm() {
            document.getElementById('recordSaleForm').reset();
            document.getElementById('commissionAmount').value = '';
        }

        // Export sales
        function exportSales() {
            // Create sample CSV content for demonstration
            const csvContent = `Date,Customer,Product,Amount,Commission,Status
No sales recorded,,,,$0.00,N/A`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Fallback data for when API fails
        function loadFallbackData() {
            document.getElementById('totalSales').textContent = '0';
            document.getElementById('monthlySales').textContent = '0';
            document.getElementById('salesRevenue').textContent = '$0';
            document.getElementById('conversionRate').textContent = '0%';
        }

        // Logout function
        function logout() {
            // Remove all possible authentication keys
            localStorage.removeItem('syncedup_token');
            localStorage.removeItem('syncedup_user');
            localStorage.removeItem('authToken');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>

    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
    <script src="/assets/session-prod.js"></script>
</body>
</html>