<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Critical Theme Flash Prevention -->
    <script>
    (function(){
        var t=localStorage.getItem("managerTheme")||"professional";
        var h=document.documentElement;
        h.classList.add(t+"-mode");
        
        // Load theme CSS immediately
        var existingTheme = document.querySelector('link[data-theme-css]');
        if(existingTheme) existingTheme.remove();
        
        if(t==="modern"){
            // Load modern base styles (structure only)
            var baseLink = document.createElement('link');
            baseLink.rel = 'stylesheet';
            baseLink.href = '/css/themes/modern-base.css';
            baseLink.setAttribute('data-theme-css', 'modern-base');
            document.head.appendChild(baseLink);
            // Manager portal orange colors are in manager-global.css
        } else {
            // Load traditional theme CSS
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/css/themes/' + t + '.css';
            link.setAttribute('data-theme-css', t);
            document.head.appendChild(link);
        }
        
        // Add body class when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if(document.body) document.body.classList.add(t+"-mode");
        });
        
        // Set background for immediate visual feedback
        if(t==="classic"){h.style.backgroundColor="#008080";}
        else if(t==="modern"){h.style.background="linear-gradient(135deg,#667eea 0%,#764ba2 100%)";}
        else if(t==="professional"){h.style.background="linear-gradient(-45deg,#f8fafc,#e2e8f0,#cbd5e1,#94a3b8)";}
        else{h.style.background="linear-gradient(-45deg,#059669,#10b981,#34d399,#a7f3d0)";}
        
        h.style.visibility="hidden";
        setTimeout(function(){h.style.visibility="visible";h.style.transition="opacity 0.2s";h.style.opacity="1";},50);
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Performance - Manager Dashboard</title>
    <link rel="stylesheet" href="/manager/manager-global.css">
    <link rel="stylesheet" href="/css/themes/professional.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- shared-nav.js removed - using global header components instead -->
    <script src="/manager/components/navigation.js"></script>
    <script src="/manager/components/global-header.js"></script>
    <!-- Manager Portal Theme Override -->
    <script src="/js/auth-check.js?v=3" defer></script>
    <link rel="stylesheet" href="/css/hide-theme-switchers.css">
</head>
<body>
    <!-- Global Header Mount Point -->
    <div id="global-header-mount"></div>
    
    <div class="container">
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="trending-up" class="card-icon"></i>
                Team Performance Viewer
            </h3>
            <div class="restricted-notice">
                <i data-lucide="info" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                Manager access allows you to view team sales performance and premium volumes.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="agentSelect">Select Team Member</label>
                    <select id="agentSelect">
                        <option value="">Choose an agent...</option>
                        <option value="ALL">ðŸŒŸ All Team Members</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeframe">Time Period</label>
                    <select id="timeframe">
                        <option value="thisweek">This Week</option>
                        <option value="lastweek">Last Week</option>
                        <option value="thismonth">This Month</option>
                        <option value="lastmonth">Last Month</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="loadTeamPerformance()">Load Performance Data</button>
                </div>
            </div>
        </div>
        
        <div id="performanceData">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSales">0</div>
                    <div class="stat-label">Total Sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPremium">$0</div>
                    <div class="stat-label">Premium Volume</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conversionRate">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSale">$0</div>
                    <div class="stat-label">Average Sale</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ðŸ“Š Recent Sales Activity</h3>
                <div id="salesTableContainer">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Agent</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Premium</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="export-section">
                <button class="btn btn-success" onclick="exportData('csv')">ðŸ“Š Export Sales Data</button>
                <button class="btn btn-warning" onclick="generateReport()">ðŸ“„ Generate Team Report</button>
                <button class="btn" onclick="refreshData()">ðŸ”„ Refresh Data</button>
            </div>
        </div>
        
        <div id="noDataMessage" class="card no-data">
            Select a team member and time period to view performance analytics.
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedAgent = null;
        let currentTimeframe = 'thismonth';
        
        // No hardcoded agent data - will be loaded from API
        const agents = [];
        
        // Sales data will be loaded from API - no fake data
        let salesData = [];
        
        // Initialize user display
        // Initialize user display (now handled by ManagerHeader)
        function initializeUserDisplay() {
            // User display is now handled by ManagerHeader
            // ManagerHeader.refreshUserData() will be called automatically
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global header
            ManagerHeader.init({
                pageTitle: 'Team Performance',
                showRoleSwitcher: false
            });
            
            // Server-side portal-guard already verified access
            // initializeUserDisplay(); // Now handled by ManagerHeader
            
            populateAgentSelect();
            
            // Initialize Lucide icons
            lucide.createIcons();
        });
        
        function populateAgentSelect() {
            const agentSelect = document.getElementById('agentSelect');
            
            // Clear existing options (except first two)
            agentSelect.innerHTML = '<option value="">Choose an agent...</option><option value="ALL">ðŸŒŸ All Team Members</option>';
            
            // Add agents
            agents.filter(agent => agent.active).forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = `${agent.name} (${agent.id})`;
                agentSelect.appendChild(option);
            });
        }
        
        async function loadTeamPerformance() {
            const agentId = document.getElementById('agentSelect').value;
            const timeframe = document.getElementById('timeframe').value;
            
            if (!agentId) {
                alert('Please select a team member first');
                return;
            }
            
            selectedAgent = agentId;
            currentTimeframe = timeframe;
            
            try {
                // Use the manager-specific team performance API
                let apiUrl = `/api/manager/team-performance?timeframe=${timeframe}`;
                if (agentId !== 'ALL') {
                    apiUrl += `&agent_id=${agentId}`;
                }
                
                const response = await fetch(apiUrl);
                const performanceData = await response.json();
                
                displayPerformanceData(performanceData, agentId);
                displaySalesTable(agentId);
                
            } catch (error) {
                console.error('Failed to load performance data:', error);
                displayMockData(agentId);
            }
        }
        
        function displayPerformanceData(data, agentId) {
            // Use the new API response structure
            const teamSummary = data.team_summary || {};
            const agentDetail = data.agent_detail;
            
            if (agentDetail) {
                // Show individual agent performance
                document.getElementById('totalSales').textContent = agentDetail.metrics.sales_count || 0;
                document.getElementById('totalPremium').textContent = `$${(agentDetail.metrics.total_sales || 0).toLocaleString()}`;
                document.getElementById('avgSale').textContent = `$${(agentDetail.metrics.avg_premium || 0).toLocaleString()}`;
            } else {
                // Show team totals
                document.getElementById('totalSales').textContent = teamSummary.total_sales_count || 0;
                document.getElementById('totalPremium').textContent = `$${(teamSummary.total_sales || 0).toLocaleString()}`;
                document.getElementById('avgSale').textContent = `$${(teamSummary.avg_sales_per_agent || 0).toLocaleString()}`;
            }
            
            document.getElementById('performanceData').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
        }
        
        function displayMockData(agentId) {
            // TODO: Remove this function - use real API data only
            let totalSales = 0;
            let totalPremium = 0;
            let avgSale = 0;
            
            if (agentId === 'ALL') {
                const activeAgents = agents.filter(a => a.active).length;
                totalSales *= activeAgents;
                totalPremium *= activeAgents;
            }
            
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalPremium').textContent = `$${totalPremium.toLocaleString()}`;
            document.getElementById('avgSale').textContent = `$${avgSale.toLocaleString()}`;
            
            // Calculate conversion rate (mock calculation)
            const conversionRate = Math.round((totalSales / (totalSales + 3)) * 100); // Assume some leads didn't convert
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            
            document.getElementById('performanceData').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
            
            displaySalesTable(agentId);
        }
        
        function displaySalesTable(agentId) {
            const tableBody = document.getElementById('salesTableBody');
            tableBody.innerHTML = '';
            
            // Filter sales data based on selected agent
            let salesToShow = salesData;
            if (agentId !== 'ALL') {
                salesToShow = salesData.filter(sale => sale.agentId === agentId);
            }
            
            if (salesToShow.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No sales data available for selected agent and time period.</td></tr>';
                return;
            }
            
            salesToShow.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(sale.date).toLocaleDateString()}</td>
                    <td><strong>${sale.agentName}</strong><br><small>${sale.agentId}</small></td>
                    <td>${sale.customer}</td>
                    <td>${sale.product}</td>
                    <td class="premium-amount">$${sale.premium.toFixed(2)}</td>
                    <td><span class="status-${sale.status.toLowerCase()}">${sale.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function exportData(format) {
            if (!selectedAgent) {
                alert('Please load performance data first');
                return;
            }
            
            const agentName = selectedAgent === 'ALL' ? 'All-Team-Members' : 
                agents.find(a => a.id === selectedAgent)?.name.replace(' ', '-') || 'Agent';
            
            if (format === 'csv') {
                exportToCSV(agentName);
            }
        }
        
        function exportToCSV(agentName) {
            // Manager export includes sales and premium data
            let csvContent = 'Date,Agent ID,Agent Name,Customer,Product,Premium,Status\\n';
            
            const salesToExport = selectedAgent === 'ALL' ? salesData : 
                salesData.filter(sale => sale.agentId === selectedAgent);
            
            salesToExport.forEach(sale => {
                csvContent += `${sale.date},${sale.agentId},${sale.agentName},${sale.customer},${sale.product},${sale.premium},${sale.status}\\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${agentName}-sales-${currentTimeframe}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateReport() {
            if (!selectedAgent) {
                alert('Please load performance data first');
                return;
            }
            
            alert('Team report generation would be implemented here. This would create a comprehensive sales and performance report.');
        }
        
        function refreshData() {
            if (selectedAgent) {
                loadTeamPerformance();
            }
        }
        
        // Logout function is now handled by ManagerHeader.logout()
        // function logout() {
        //     clearAuthCookies();
        //     window.location.href = '/login';
        // }
        
    </script>
    
    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
</body>
</html>