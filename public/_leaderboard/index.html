<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sales Leaderboard - SyncedUp Insurance</title>
    <link rel="stylesheet" href="/leaderboard/css/leaderboard-base.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Authentication Helper -->
    <script src="/js/auth-helper.js"></script>
    
    <!-- Auth Guard Script -->
    <script>
        (function () {
          try {
            // Global leaderboard is accessible to all authenticated users
            // Simply check if we can get current user
            console.log('Checking authentication for global leaderboard...');
            
            // We'll verify auth when making API calls
            // The API will use cookies automatically with credentials: 'include'
            console.log('Global leaderboard ready - auth will be verified on API calls');
            
          } catch (error) {
            console.error('Auth initialization error:', error);
            // Don't redirect here - let the API calls handle auth
          }
        })();
    </script>
    
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="leaderboard-header">
            <h1 class="leaderboard-title">Global Sales Leaderboard</h1>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="competition" title="Dark theme with neon accents and animations">
                    <span class="theme-icon">üèÜ</span>
                    <span class="theme-name">Competition</span>
                </button>
                <button class="theme-btn" data-theme="analytics" title="Clean design focused on data visualization">
                    <span class="theme-icon">üìä</span>
                    <span class="theme-name">Analytics</span>
                </button>
                <button class="theme-btn" data-theme="gaming" title="Retro arcade aesthetic with 8-bit styling">
                    <span class="theme-icon">üéÆ</span>
                    <span class="theme-name">Gaming</span>
                </button>
            </div>
            <div class="system-status">
                <span class="status-indicator"></span>
                <span>Live Updates Active</span>
            </div>
        </header>
        
        <!-- Controls -->
        <div class="leaderboard-controls">
            <div class="leaderboard-tabs">
                <a href="/global-leaderboard" class="leaderboard-tab active">
                    <i data-lucide="trophy"></i>
                    Overall Rankings
                </a>
                <a href="/leaderboard/monthly" class="leaderboard-tab">
                    <i data-lucide="calendar"></i>
                    Monthly Leaders
                </a>
                <a href="/leaderboard/teams" class="leaderboard-tab">
                    <i data-lucide="users"></i>
                    Team Rankings
                </a>
            </div>
            
            <div class="leaderboard-filters">
                <select class="filter-select" id="office-filter">
                    <option value="all">All Offices</option>
                    <option value="my-office">My Office</option>
                </select>
                
                <select class="filter-select" id="period-filter">
                    <option value="current">Current Period</option>
                    <option value="last-month">Last Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>
        
        <!-- Metrics -->
        <div class="leaderboard-metrics">
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Active Agents</div>
                <div class="leaderboard-metric-value" id="active-agents">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Total Sales</div>
                <div class="leaderboard-metric-value" id="total-sales">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Commissions Paid</div>
                <div class="leaderboard-metric-value" id="commissions-paid">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Offices Competing</div>
                <div class="leaderboard-metric-value" id="offices-competing">--</div>
            </div>
        </div>
        
        <!-- Rankings -->
        <div class="rankings-container">
            <!-- Top 3 Podium -->
            <div class="rankings-podium">
                <div class="podium-place gold">
                    <div class="podium-medal">1</div>
                    <div class="podium-name" id="first-place-name">Loading...</div>
                    <div class="podium-office" id="first-place-office">--</div>
                    <div class="podium-amount" id="first-place-amount">$0</div>
                </div>
                
                <div class="podium-place silver">
                    <div class="podium-medal">2</div>
                    <div class="podium-name" id="second-place-name">Loading...</div>
                    <div class="podium-office" id="second-place-office">--</div>
                    <div class="podium-amount" id="second-place-amount">$0</div>
                </div>
                
                <div class="podium-place bronze">
                    <div class="podium-medal">3</div>
                    <div class="podium-name" id="third-place-name">Loading...</div>
                    <div class="podium-office" id="third-place-office">--</div>
                    <div class="podium-amount" id="third-place-amount">$0</div>
                </div>
            </div>
            
            <!-- Full Rankings Table -->
            <table class="data-table rankings-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Agent</th>
                        <th>Office</th>
                        <th>Sales</th>
                        <th>Policies</th>
                        <th>Commission</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="rankings-tbody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            Loading rankings data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Load leaderboard theme system -->
    <script src="/leaderboard/js/leaderboard-theme.js"></script>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Load leaderboard data
        async function loadLeaderboardData() {
            try {
                // Server-side portal-guard already verified access
                // Use cookies for authentication

                const response = await fetch('/api/leaderboard/global', {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Leaderboard data loaded:', data);
                    updateMetrics(data.metrics || {});
                    updatePodium(data.topThree || []);
                    updateRankingsTable(data.rankings || []);
                } else if (response.status === 401) {
                    console.error('Authentication failed');
                    showErrorState('Please log in to view the leaderboard.');
                    setTimeout(() => window.location.href = '/login', 2000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load leaderboard data`);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showErrorState(error.message);
            }
        }
        
        function updateMetrics(metrics) {
            document.getElementById('active-agents').textContent = metrics.activeAgents || '0';
            document.getElementById('total-sales').textContent = `$${(metrics.totalSales || 0).toLocaleString()}`;
            document.getElementById('commissions-paid').textContent = `$${(metrics.commissionsPaid || 0).toLocaleString()}`;
            document.getElementById('offices-competing').textContent = metrics.officesCompeting || '0';
        }
        
        function updatePodium(topThree) {
            if (topThree.length >= 1) {
                document.getElementById('first-place-name').textContent = topThree[0].name || '--';
                document.getElementById('first-place-office').textContent = topThree[0].office || '--';
                document.getElementById('first-place-amount').textContent = `$${(topThree[0].sales || 0).toLocaleString()}`;
            }
            
            if (topThree.length >= 2) {
                document.getElementById('second-place-name').textContent = topThree[1].name || '--';
                document.getElementById('second-place-office').textContent = topThree[1].office || '--';
                document.getElementById('second-place-amount').textContent = `$${(topThree[1].sales || 0).toLocaleString()}`;
            }
            
            if (topThree.length >= 3) {
                document.getElementById('third-place-name').textContent = topThree[2].name || '--';
                document.getElementById('third-place-office').textContent = topThree[2].office || '--';
                document.getElementById('third-place-amount').textContent = `$${(topThree[2].sales || 0).toLocaleString()}`;
            }
        }
        
        function updateRankingsTable(rankings) {
            const tbody = document.getElementById('rankings-tbody');
            
            if (rankings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No rankings data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = rankings.map((agent, index) => `
                <tr>
                    <td>
                        <span class="rank-badge ${index < 3 ? ['gold', 'silver', 'bronze'][index] : ''}">
                            ${index + 1}
                        </span>
                    </td>
                    <td>${agent.name || '--'}</td>
                    <td>${agent.office || '--'}</td>
                    <td>$${(agent.sales || 0).toLocaleString()}</td>
                    <td>${agent.policies || 0}</td>
                    <td>$${(agent.commission || 0).toLocaleString()}</td>
                    <td>
                        <span class="trend-indicator trend-${agent.trend || 'flat'}">
                            <i data-lucide="${getTrendIcon(agent.trend)}"></i>
                            ${agent.trendPercent || '0'}%
                        </span>
                    </td>
                </tr>
            `).join('');
            
            // Re-initialize icons for new content
            lucide.createIcons();
        }
        
        function getTrendIcon(trend) {
            switch (trend) {
                case 'up': return 'trending-up';
                case 'down': return 'trending-down';
                default: return 'minus';
            }
        }
        
        function showErrorState(message = 'Error loading rankings data. Please refresh the page.') {
            document.getElementById('rankings-tbody').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--error);">
                        ${message}
                    </td>
                </tr>
            `;
            
            // Also show error in metrics
            document.getElementById('active-agents').textContent = '--';
            document.getElementById('total-sales').textContent = '--';
            document.getElementById('commissions-paid').textContent = '--';
            document.getElementById('offices-competing').textContent = '--';
        }
        
        function refreshData() {
            loadLeaderboardData();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadLeaderboardData();
            
            // Theme system debugging and fallback
            console.log('DOM loaded, checking theme system...');
            console.log('Current page URL:', window.location.href);
            console.log('Current pathname:', window.location.pathname);
            
            setTimeout(() => {
                const hasThemeClass = document.body.className.includes('lb-') && document.body.className.includes('-mode');
                console.log('Theme system status:', {
                    hasThemeClass,
                    bodyClasses: document.body.className,
                    themeSystem: window.leaderboardTheme ? 'loaded' : 'not loaded'
                });
                
                if (!hasThemeClass) {
                    console.warn('Theme not applied, forcing competition theme...');
                    document.body.classList.add('lb-competition-mode');
                    
                    // Also try to load the CSS manually
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = '/leaderboard/css/themes/competition.css';
                    document.head.appendChild(link);
                    console.log('Manually loaded competition theme CSS');
                }
                
                // Extra debug info
                console.log('Authentication info:', {
                    user: window.currentUser,
                    token: !!window.authToken
                });
            }, 1000);
            
            // Theme system is auto-initialized by leaderboard-theme.js
            // Listen for theme changes to update display if needed
            window.addEventListener('leaderboardThemeChange', (e) => {
                console.log('Theme changed to:', e.detail.theme);
                // Re-initialize Lucide icons after theme change
                setTimeout(() => lucide.createIcons(), 100);
            });
        });
        
        // Theme System Implementation
        function initializeThemeSystem() {
            const themeButtons = document.querySelectorAll('.theme-btn');
            
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const theme = button.getAttribute('data-theme');
                    applyTheme(theme);
                    
                    // Update active state
                    themeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });
            
            // Always default to competition theme
            const savedTheme = 'competition';
            applyTheme(savedTheme);
            
            // Set active button
            const activeBtn = document.querySelector(`[data-theme="${savedTheme}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }
        
        function applyTheme(theme) {
            const container = document.querySelector('.dashboard-container');
            
            // Remove all theme classes
            container.classList.remove('theme-competition', 'theme-analytics', 'theme-gaming');
            
            // Add new theme class
            container.classList.add(`theme-${theme}`);
            
            // Save preference (but competition is always default on load)
            localStorage.setItem('leaderboard-theme', theme);
            
            // Apply theme-specific styles
            switch(theme) {
                case 'competition':
                    document.body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
                    break;
                case 'analytics':
                    document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                    break;
                case 'gaming':
                    document.body.style.background = 'linear-gradient(135deg, #2d1b69 0%, #0f3443 100%)';
                    break;
            }
            
            // Fire event for other components
            window.dispatchEvent(new CustomEvent('leaderboardThemeChange', { detail: { theme } }));
        }
        
        // Logout function
        function logout() {
            if (typeof SyncedUpAuth !== 'undefined') {
                SyncedUpAuth.logout();
            } else {
                // Fallback logout
                document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>