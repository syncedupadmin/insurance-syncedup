<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Management - Manager Portal</title>
    <link rel="stylesheet" href="/manager/manager-global.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Team Management</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span id="userDisplay">Loading...</span>
            <button class="btn" onclick="logout()">
                <i data-lucide="log-out" class="icon"></i>
                Logout
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <a href="/manager" class="nav-link">
            <i data-lucide="layout-dashboard" class="icon"></i>
            Dashboard
        </a>
        <a href="/manager/leads" class="nav-link">
            <i data-lucide="user-plus" class="icon"></i>
            Leads
        </a>
        <a href="/manager/team-management" class="nav-link active">
            <i data-lucide="users" class="icon"></i>
            Team Management
        </a>
        <a href="/manager/performance" class="nav-link">
            <i data-lucide="trending-up" class="icon"></i>
            Team Performance
        </a>
        <a href="/manager/reports" class="nav-link">
            <i data-lucide="file-text" class="icon"></i>
            Reports
        </a>
        <a href="/manager/goals" class="nav-link">
            <i data-lucide="target" class="icon"></i>
            Goals
        </a>
        <a href="/manager/vendors" class="nav-link">
            <i data-lucide="building-2" class="icon"></i>
            Vendors
        </a>
        <a href="/manager/settings" class="nav-link">
            <i data-lucide="settings" class="icon"></i>
            Settings
        </a>
        <a href="/manager/convoso.html" class="nav-link">
            <i data-lucide="phone-call" class="icon"></i>
            Convoso
        </a>
        <a href="/global-leaderboard" class="nav-link">
            <i data-lucide="trophy" class="icon"></i>
            Global Leaderboard
        </a>
    </div>
    
    <div class="container">
        <div class="manager-notice">
            <h3><i data-lucide="users"></i> Team Management Center</h3>
            <p>Manage your team members, track their activity, and optimize team performance.</p>
        </div>
        
        <div class="grid">
            <div class="stat-card">
                <div class="stat-value" id="totalAgents">0</div>
                <div class="stat-label">Total Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeAgents">0</div>
                <div class="stat-label">Active This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newHires">0</div>
                <div class="stat-label">New This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="topPerformers">0</div>
                <div class="stat-label">Top Performers</div>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="btn" onclick="addNewAgent()">
                <i data-lucide="user-plus"></i>
                Add New Agent
            </button>
            <button class="btn btn-success" onclick="bulkActions()">
                <i data-lucide="users-2"></i>
                Bulk Actions
            </button>
            <button class="btn btn-warning" onclick="exportTeamData()">
                <i data-lucide="download"></i>
                Export Team Data
            </button>
            <button class="btn btn-secondary" onclick="refreshTeamData()">
                <i data-lucide="refresh-cw"></i>
                Refresh
            </button>
        </div>
        
        <!-- Team Directory -->
        <div class="card">
            <h3><i data-lucide="users-2"></i> Team Directory</h3>
            <div class="form-row">
                <div class="form-group">
                    <input type="text" id="searchAgents" placeholder="Search agents..." onkeyup="filterAgents()">
                </div>
                <div class="form-group">
                    <select id="statusFilter" onchange="filterAgents()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>
            <table id="agentsTable">
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Contact Info</th>
                        <th>Hire Date</th>
                        <th>Status</th>
                        <th>This Month</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agentsTableBody">
                    <tr><td colspan="6" style="text-align: center;">Loading team data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Recent Team Activity -->
        <div class="card">
            <h3><i data-lucide="activity"></i> Recent Team Activity</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Agent</th>
                        <th>Activity</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="recentActivityTable">
                    <tr><td colspan="4" style="text-align: center;">Loading activity...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add Agent Modal -->
    <div id="addAgentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3><i data-lucide="user-plus"></i> Add New Agent</h3>
            <div class="form-group">
                <label for="agentName">Full Name</label>
                <input type="text" id="agentName" required>
            </div>
            <div class="form-group">
                <label for="agentEmail">Email</label>
                <input type="email" id="agentEmail" required>
            </div>
            <div class="form-group">
                <label for="agentPhone">Phone</label>
                <input type="tel" id="agentPhone" required>
            </div>
            <div class="form-group">
                <label for="agentCode">Agent Code</label>
                <input type="text" id="agentCode" required>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="saveNewAgent()">
                    <i data-lucide="check"></i>
                    Add Agent
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i data-lucide="x"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let teamData = [];
        
        // Team data will be loaded from API - no fake data
        let recentActivity = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const userData = localStorage.getItem('syncedup_user');
            if (userData) {
                currentUser = JSON.parse(userData);
                
                // Allow managers and admin to access this page
                if (!['manager', 'admin', 'super-admin'].includes(currentUser.role)) {
                    window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
                    return;
                }
                
                loadTeamManagement();
            } else {
                window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        async function loadTeamManagement() {
            showLoadingState();
            try {
                // No API configured - show empty team
                const agents = [];
                teamData = agents.map(agent => ({
                    ...agent,
                    hireDate: agent.hireDate || new Date().toISOString(),
                    salesThisMonth: agent.salesThisMonth || 0,
                    premiumThisMonth: agent.premiumThisMonth || 0
                }));
                console.log('Team data loaded from API');
            } catch (error) {
                console.log('Error loading team data:', error);
                teamData = [];
            }
            
            displayTeamStats();
            displayTeamTable();
            displayRecentActivity();
            hideLoadingState();
            
            // Set up auto-refresh every 5 minutes
            setInterval(refreshTeamData, 5 * 60 * 1000);
        }
        
        function displayTeamStats() {
            const activeAgents = teamData.filter(agent => agent.status === 'active').length;
            const newHires = teamData.filter(agent => {
                const hireDate = new Date(agent.hireDate);
                const thisMonth = new Date();
                return hireDate.getMonth() === thisMonth.getMonth() && 
                       hireDate.getFullYear() === thisMonth.getFullYear();
            }).length;
            const topPerformers = teamData.filter(agent => agent.salesThisMonth > 10).length;
            
            document.getElementById('totalAgents').textContent = teamData.length;
            document.getElementById('activeAgents').textContent = activeAgents;
            document.getElementById('newHires').textContent = newHires;
            document.getElementById('topPerformers').textContent = topPerformers;
        }
        
        function displayTeamTable() {
            const tableBody = document.getElementById('agentsTableBody');
            tableBody.innerHTML = '';
            
            teamData.forEach(agent => {
                const row = document.createElement('tr');
                const statusClass = agent.status === 'active' ? 'status-active' : 
                                   agent.status === 'inactive' ? 'status-inactive' : 'status-pending';
                
                row.innerHTML = `
                    <td>
                        <strong>${agent.name}</strong><br>
                        <small>${agent.id}</small>
                    </td>
                    <td>
                        ${agent.email}<br>
                        <small>${agent.phone}</small>
                    </td>
                    <td>${new Date(agent.hireDate).toLocaleDateString()}</td>
                    <td><span class="${statusClass}">${agent.status.charAt(0).toUpperCase() + agent.status.slice(1)}</span></td>
                    <td>
                        <strong>${agent.salesThisMonth} sales</strong><br>
                        <span class="premium-amount">$${agent.premiumThisMonth.toLocaleString()}</span>
                    </td>
                    <td>
                        <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0.1rem;" 
                                onclick="viewAgentDetail('${agent.id}')">
                                <i data-lucide="eye"></i> View
                        </button>
                        <button class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0.1rem;" 
                                onclick="editAgent('${agent.id}')">
                                <i data-lucide="edit"></i> Edit
                        </button>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0.1rem;" 
                                onclick="contactAgent('${agent.id}')">
                                <i data-lucide="message-circle"></i> Contact
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function displayRecentActivity() {
            const tableBody = document.getElementById('recentActivityTable');
            tableBody.innerHTML = '';
            
            recentActivity.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td><strong>${activity.agent}</strong></td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function filterAgents() {
            const searchTerm = document.getElementById('searchAgents').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredData = teamData;
            
            if (searchTerm) {
                filteredData = filteredData.filter(agent => 
                    agent.name.toLowerCase().includes(searchTerm) ||
                    agent.id.toLowerCase().includes(searchTerm) ||
                    agent.email.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredData = filteredData.filter(agent => agent.status === statusFilter);
            }
            
            // Temporarily store original data and update display
            const originalData = teamData;
            teamData = filteredData;
            displayTeamTable();
            teamData = originalData;
        }
        
        function addNewAgent() {
            document.getElementById('addAgentModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('addAgentModal').style.display = 'none';
            
            // Reset modal to create mode
            document.querySelector('.modal-content h3').innerHTML = '<i data-lucide="user-plus"></i> Add New Agent';
            document.querySelector('.modal-content .btn-success').innerHTML = '<i data-lucide="check"></i> Add Agent';
            document.querySelector('.modal-content .btn-success').onclick = saveNewAgent;
            
            // Clear form
            document.getElementById('agentName').value = '';
            document.getElementById('agentEmail').value = '';
            document.getElementById('agentPhone').value = '';
            document.getElementById('agentCode').value = '';
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        async function saveNewAgent() {
            const name = document.getElementById('agentName').value;
            const email = document.getElementById('agentEmail').value;
            const phone = document.getElementById('agentPhone').value;
            const team = document.getElementById('agentCode').value;
            
            if (!name || !email || !phone || !team) {
                alert('Please fill in all fields');
                return;
            }
            
            // Show loading state
            const saveButton = document.querySelector('.modal-content .btn-success');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<div class="loading"></div> Adding...';
            saveButton.disabled = true;
            
            try {
                const user = JSON.parse(sessionStorage.getItem('syncedup:user') || '{}');
                const agent = {
                    id: `agent-${Date.now()}`,
                    name,
                    email,
                    phone,
                    team,
                    status: 'active',
                    performance: 0,
                    agencyId: user.agencyId,
                    isDemoData: user.isDemoAccount || false,
                    hireDate: new Date().toISOString(),
                    salesThisMonth: 0,
                    premiumThisMonth: 0
                };
                
                // No API configured - cannot add agents
                console.log('API not configured - cannot add agent:', agent);
                throw new Error('API endpoints not configured');
                
                if (response.ok) {
                    teamData.unshift(agent);
                    displayTeamStats();
                    displayTeamTable();
                    alert(`Agent ${name} added successfully!`);
                    closeModal();
                } else {
                    alert('Failed to add agent');
                }
            } catch (error) {
                console.error('Error saving agent:', error);
                alert('Error adding agent. Please try again.');
            }
            
            // Reset button
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
        
        function bulkActions() {
            const selectedAgents = Array.from(document.querySelectorAll('input[name="agentSelect"]:checked'));
            
            if (selectedAgents.length === 0) {
                alert('Please select agents first by adding checkboxes to the table.');
                return;
            }
            
            const actions = [
                'Send bulk email',
                'Update status (activate/deactivate)',
                'Generate performance reports',
                'Assign to territory',
                'Set monthly goals',
                'Schedule team meeting'
            ];
            
            const action = prompt(`Bulk actions available for ${selectedAgents.length} agents:\n\n${actions.map((a, i) => `${i+1}. ${a}`).join('\n')}\n\nEnter action number (1-${actions.length}):`);
            
            if (action && action >= 1 && action <= actions.length) {
                alert(`"${actions[action-1]}" would be executed for ${selectedAgents.length} selected agents. This feature will be fully implemented in production.`);
            }
        }
        
        function exportTeamData() {
            // Create CSV content
            let csvContent = 'Agent ID,Name,Email,Phone,Hire Date,Status,Sales This Month,Premium This Month\\n';
            
            teamData.forEach(agent => {
                csvContent += `${agent.id},${agent.name},${agent.email},${agent.phone},${agent.hireDate},${agent.status},${agent.salesThisMonth},${agent.premiumThisMonth}\\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function refreshTeamData() {
            loadTeamManagement();
        }
        
        function viewAgentDetail(agentId) {
            window.location.href = `https://insurance.syncedupsolutions.com/manager/performance.html?agent=${agentId}`;
        }
        
        async function editAgent(agentId) {
            const agent = teamData.find(a => a.id === agentId);
            
            // Pre-fill the modal with existing agent data
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentEmail').value = agent.email;
            document.getElementById('agentPhone').value = agent.phone;
            document.getElementById('agentCode').value = agent.id;
            
            // Change modal title and button text
            document.querySelector('.modal-content h3').innerHTML = '<i data-lucide="user-edit"></i> Edit Agent';
            document.querySelector('.modal-content .btn-success').innerHTML = '<i data-lucide="check"></i> Update Agent';
            document.querySelector('.modal-content .btn-success').onclick = function() { updateAgent(agentId); };
            
            document.getElementById('addAgentModal').style.display = 'block';
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        async function updateAgent(agentId) {
            const name = document.getElementById('agentName').value;
            const email = document.getElementById('agentEmail').value;
            const phone = document.getElementById('agentPhone').value;
            const code = document.getElementById('agentCode').value;
            
            if (!name || !email || !phone || !code) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/user-management/${agentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    body: JSON.stringify({
                        full_name: name,
                        email,
                        phone,
                        agent_code: code
                    })
                });
                
                if (response.ok) {
                    // Update local data
                    const agent = teamData.find(a => a.id === agentId);
                    agent.name = name;
                    agent.email = email;
                    agent.phone = phone;
                    
                    displayTeamStats();
                    displayTeamTable();
                    alert('Agent updated successfully!');
                    closeModal();
                } else {
                    throw new Error('API update failed');
                }
            } catch (error) {
                console.error('Error updating agent:', error);
                
                // Fallback: Update local data for demo
                const agent = teamData.find(a => a.id === agentId);
                agent.name = name;
                agent.email = email;
                agent.phone = phone;
                
                displayTeamStats();
                displayTeamTable();
                alert('Agent updated successfully! (Demo mode)');
                closeModal();
            }
        }
        
        function contactAgent(agentId) {
            const agent = teamData.find(a => a.id === agentId);
            alert(`Contact options for ${agent.name} would appear here (email, phone, message).`);
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
        }
        
        function showLoadingState() {
            const tableBody = document.getElementById('agentsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="loading"></div> Loading team data...</td></tr>';
            
            const activityTableBody = document.getElementById('recentActivityTable');
            activityTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;"><div class="loading"></div> Loading activity...</td></tr>';
        }
        
        function hideLoadingState() {
            // Loading states will be replaced by actual data
        }
        
        async function refreshTeamData() {
            console.log('Refreshing team data...');
            await loadTeamManagement();
        }
        
        async function assignTerritory(agentId) {
            const agent = teamData.find(a => a.id === agentId);
            const territories = [
                'North Region',
                'South Region', 
                'East Region',
                'West Region',
                'Downtown',
                'Suburbs',
                'Remote/Online Only'
            ];
            
            const territory = prompt(`Assign territory for ${agent.name}:\n\n${territories.map((t, i) => `${i+1}. ${t}`).join('\n')}\n\nEnter territory number (1-${territories.length}):`);
            
            if (territory && territory >= 1 && territory <= territories.length) {
                try {
                    // This would make an API call to update territory assignment
                    alert(`${agent.name} assigned to ${territories[territory-1]} territory successfully!`);
                } catch (error) {
                    alert(`Territory assignment for ${agent.name}: ${territories[territory-1]} (Demo mode)`);
                }
            }
        }
        
        async function setAgentGoals(agentId) {
            const agent = teamData.find(a => a.id === agentId);
            const salesGoal = prompt(`Set monthly sales goal for ${agent.name}:`, '15');
            
            if (salesGoal && !isNaN(salesGoal) && salesGoal > 0) {
                try {
                    // This would create a goal via the goals API
                    const goalData = {
                        title: `Monthly Sales Goal - ${agent.name}`,
                        agent_id: agentId,
                        category: 'sales',
                        target_value: parseFloat(salesGoal),
                        unit: 'sales',
                        start_date: new Date().toISOString().split('T')[0],
                        due_date: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0],
                        status: 'active'
                    };
                    
                    alert(`Monthly sales goal of ${salesGoal} set for ${agent.name}!`);
                } catch (error) {
                    alert(`Goal setting for ${agent.name}: ${salesGoal} sales (Demo mode)`);
                }
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addAgentModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    
    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
    <script src="/assets/session-prod.js"></script>
</body>
</html>