<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Products - SyncedUp Insurance Agent</title>
    <link rel="stylesheet" href="agent-global.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Quote Products</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span id="userDisplay">Loading...</span>
            <button class="btn" onclick="logout()">
                <i data-lucide="log-out" class="icon"></i>
                Logout
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav">
        <a href="/agent" class="nav-link">
            <i data-lucide="layout-dashboard" class="icon"></i>
            Dashboard
        </a>
        <a href="/agent/quotes" class="nav-link active">
            <i data-lucide="calculator" class="icon"></i>
            Quote Products
        </a>
        <a href="/agent/commissions" class="nav-link">
            <i data-lucide="dollar-sign" class="icon"></i>
            My Commissions
        </a>
        <a href="/agent/customers" class="nav-link">
            <i data-lucide="users" class="icon"></i>
            My Customers
        </a>
        <a href="/agent/sales" class="nav-link">
            <i data-lucide="trending-up" class="icon"></i>
            Sales Reports
        </a>
        <a href="/agent/settings" class="nav-link">
            <i data-lucide="settings" class="icon"></i>
            Settings
        </a>
        <a href="/leaderboard" class="nav-link">
            <i data-lucide="trophy" class="icon"></i>
            Global Leaderboard
        </a>
    </div>

    <div class="container">
        <!-- Quote Generator -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="calculator" class="card-icon"></i>
                Generate Insurance Quote
            </h3>

            <form id="quoteForm">
                <!-- Customer Information -->
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Customer Information</h4>
                    
                    <div class="grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" id="customerFirstName" class="form-input" placeholder="John" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" id="customerLastName" class="form-input" placeholder="Smith" required>
                        </div>
                    </div>

                    <div class="grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="customerEmail" class="form-input" placeholder="john@example.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="customerPhone" class="form-input" placeholder="(555) 123-4567" required>
                        </div>
                    </div>

                    <div class="grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" id="customerDOB" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">State</label>
                            <select id="customerState" class="form-select" required>
                                <option value="">Select State</option>
                                <option value="CA">California</option>
                                <option value="TX">Texas</option>
                                <option value="FL">Florida</option>
                                <option value="NY">New York</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="IL">Illinois</option>
                                <option value="OH">Ohio</option>
                                <option value="GA">Georgia</option>
                                <option value="NC">North Carolina</option>
                                <option value="MI">Michigan</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Product Selection -->
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Product Selection</h4>
                    
                    <div class="grid" id="productGrid">
                        <!-- Products will be loaded here -->
                        <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                            Loading available products...
                        </div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;" id="additionalOptions" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Additional Options</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Coverage Amount</label>
                        <select id="coverageAmount" class="form-select">
                            <option value="50000">$50,000</option>
                            <option value="100000" selected>$100,000</option>
                            <option value="250000">$250,000</option>
                            <option value="500000">$500,000</option>
                            <option value="1000000">$1,000,000</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Deductible</label>
                        <select id="deductible" class="form-select">
                            <option value="500">$500</option>
                            <option value="1000" selected>$1,000</option>
                            <option value="2500">$2,500</option>
                            <option value="5000">$5,000</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Special Notes</label>
                        <textarea id="specialNotes" class="form-input" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="calculator" class="icon"></i>
                        Generate Quote
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        <i data-lucide="x" class="icon"></i>
                        Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Quote Results -->
        <div id="quoteResults" class="card" style="display: none;">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="file-text" class="card-icon"></i>
                Quote Results
            </h3>
            
            <div id="quoteResultsContent">
                <!-- Quote results will be displayed here -->
            </div>
        </div>

        <!-- Recent Quotes -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="history" class="card-icon"></i>
                Recent Quotes
            </h3>

            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="loadRecentQuotes()">
                    <i data-lucide="refresh-cw" class="icon"></i>
                    Refresh
                </button>
                <button class="btn btn-warning" onclick="exportQuotes()">
                    <i data-lucide="download" class="icon"></i>
                    Export Quotes
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Premium</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentQuotesTable">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <div class="loading"></div>
                            Loading recent quotes...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentUser = null;
        let availableProducts = [];
        let selectedProduct = null;

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('syncedup_token');
            const user = JSON.parse(localStorage.getItem('syncedup_user') || '{}');
            
            if (!token || !user.email) {
                window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
                return false;
            }

            if (!['agent', 'manager', 'admin', 'super-admin'].includes(user.role)) {
                alert('Access denied. Agent permissions required.');
                window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
                return false;
            }

            document.getElementById('userDisplay').textContent = `${user.firstName} ${user.lastName} (${user.role})`;
            currentUser = user;
            return true;
        }

        // Initialize page
        async function initializePage() {
            if (!checkAuth()) return;
            
            await loadProducts();
            await loadRecentQuotes();
            setupFormHandlers();
            
            lucide.createIcons();
        }

        // Load available products
        async function loadProducts() {
            try {
                // Mock products - replace with API call
                availableProducts = [
                    {
                        id: 'health_premium',
                        name: 'Health Plan Premium',
                        description: 'Comprehensive health coverage with low deductibles',
                        basePrice: 149.99,
                        commission: 15.00
                    },
                    {
                        id: 'life_gold',
                        name: 'Life Insurance Gold',
                        description: 'Term life insurance with flexible coverage amounts',
                        basePrice: 87.50,
                        commission: 8.75
                    },
                    {
                        id: 'auto_plus',
                        name: 'Auto Coverage Plus',
                        description: 'Full coverage auto insurance with roadside assistance',
                        basePrice: 234.00,
                        commission: 23.40
                    },
                    {
                        id: 'home_protection',
                        name: 'Home Protection Plan',
                        description: 'Comprehensive homeowners insurance coverage',
                        basePrice: 189.99,
                        commission: 19.00
                    }
                ];

                displayProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productGrid').innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Error loading products. Please refresh the page.</p>';
            }
        }

        // Display products
        function displayProducts() {
            const productGrid = document.getElementById('productGrid');
            
            const productsHTML = availableProducts.map(product => `
                <div class="product-card" onclick="selectProduct('${product.id}')">
                    <h4 style="margin-bottom: 0.5rem; font-size: 1.1rem;">${product.name}</h4>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-size: 0.9rem;">${product.description}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="premium-amount">$${product.basePrice}/mo</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Commission: $${product.commission}</div>
                    </div>
                </div>
            `).join('');

            productGrid.innerHTML = productsHTML;
        }

        // Select product
        function selectProduct(productId) {
            // Remove previous selection
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Select new product
            event.target.closest('.product-card').classList.add('selected');
            selectedProduct = availableProducts.find(p => p.id === productId);
            
            // Show additional options
            document.getElementById('additionalOptions').style.display = 'block';
        }

        // Setup form handlers
        function setupFormHandlers() {
            document.getElementById('quoteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await generateQuote();
            });
        }

        // Generate quote
        async function generateQuote() {
            if (!selectedProduct) {
                alert('Please select a product first.');
                return;
            }

            const firstName = document.getElementById('customerFirstName').value;
            const lastName = document.getElementById('customerLastName').value;
            const email = document.getElementById('customerEmail').value;
            const phone = document.getElementById('customerPhone').value;
            const dob = document.getElementById('customerDOB').value;
            const state = document.getElementById('customerState').value;
            
            if (!firstName || !lastName || !email || !phone || !dob || !state) {
                alert('Please complete all fields');
                return;
            }

            try {
                // Show loading
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading"></div> Generating Quote...';
                submitBtn.disabled = true;

                const user = JSON.parse(sessionStorage.getItem('syncedup:user') || '{}');
                
                // Calculate quote (simple logic)
                const basePrice = selectedProduct.basePrice;
                const coverageAmount = document.getElementById('coverageAmount').value;
                const deductible = document.getElementById('deductible').value;
                const coverageMultiplier = parseInt(coverageAmount) / 100000;
                const deductibleDiscount = (5000 - parseInt(deductible)) / 5000 * 0.1;
                
                const finalPrice = basePrice * coverageMultiplier * (1 - deductibleDiscount);
                const commission = finalPrice * 0.10; // 10% commission

                const quote = {
                    id: `Q-${Date.now()}`,
                    agentId: user.id,
                    firstName,
                    lastName,
                    email,
                    phone,
                    dob,
                    state,
                    productType: selectedProduct.name,
                    coverageAmount,
                    deductible,
                    monthlyPremium: finalPrice.toFixed(2),
                    annualPremium: (finalPrice * 12).toFixed(2),
                    commission: commission.toFixed(2),
                    specialNotes: document.getElementById('specialNotes').value,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                const response = await __api('/quotes', {
                    method: 'POST',
                    body: JSON.stringify(quote)
                });
                
                if (response.ok) {
                    displayQuoteResults(quote);
                    alert('Quote generated successfully!');
                    clearForm();
                    await loadRecentQuotes();
                } else {
                    alert('Failed to generate quote');
                }

                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

            } catch (error) {
                console.error('Error generating quote:', error);
                alert('Error generating quote. Please try again.');
                
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.innerHTML = 'Generate Quote';
                submitBtn.disabled = false;
            }
        }

        // Display quote results
        function displayQuoteResults(data) {
            const resultsContainer = document.getElementById('quoteResultsContent');
            
            resultsContainer.innerHTML = `
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Quote #${data.id}</h4>
                        <span style="color: rgba(255,255,255,0.8);">Valid until: ${new Date(data.validUntil).toLocaleDateString()}</span>
                    </div>
                    
                    <div class="grid" style="margin-bottom: 1rem;">
                        <div>
                            <strong>Customer:</strong><br>
                            ${data.firstName} ${data.lastName}<br>
                            ${data.email}<br>
                            ${data.phone}
                        </div>
                        <div>
                            <strong>Product:</strong><br>
                            ${data.productType}<br>
                            Coverage: $${parseInt(data.coverageAmount).toLocaleString()}<br>
                            Deductible: $${parseInt(data.deductible).toLocaleString()}
                        </div>
                    </div>
                    
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Monthly Premium:</span>
                            <span class="premium-amount">$${data.monthlyPremium}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Annual Premium:</span>
                            <span class="premium-amount">$${data.annualPremium}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Your Commission:</span>
                            <span style="color: #34d399; font-weight: 600;">$${data.commission}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="btn btn-success" onclick="convertToSale('${data.id}')">
                            <i data-lucide="handshake" class="icon"></i>
                            Convert to Sale
                        </button>
                        <button class="btn btn-warning" onclick="emailQuote('${data.id}')">
                            <i data-lucide="mail" class="icon"></i>
                            Email to Customer
                        </button>
                        <button class="btn btn-secondary" onclick="printQuote('${data.id}')">
                            <i data-lucide="printer" class="icon"></i>
                            Print Quote
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('quoteResults').style.display = 'block';
            document.getElementById('quoteResults').scrollIntoView({ behavior: 'smooth' });
            
            lucide.createIcons();
        }

        // Load recent quotes
        async function loadRecentQuotes() {
            const tableBody = document.getElementById('recentQuotesTable');
            
            try {
                const user = JSON.parse(sessionStorage.getItem('syncedup:user') || '{}');
                const quotes = await __api(`/quotes?agentId=${user.id}&_limit=10&_sort=createdAt&_order=desc`);

                let quotesHTML;
                if (quotes.length === 0) {
                    quotesHTML = `<tr><td colspan="6" style="text-align: center; color: #666; padding: 2rem;">No quotes found</td></tr>`;
                } else {
                    quotesHTML = quotes.map(quote => `
                        <tr>
                            <td>${new Date(quote.createdAt).toLocaleDateString()}</td>
                            <td>${quote.firstName} ${quote.lastName}</td>
                            <td>${quote.productType}</td>
                            <td class="premium-amount">$${quote.monthlyPremium}</td>
                            <td><span class="status-${quote.status.toLowerCase()}">${quote.status}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewQuote('${quote.id}')">
                                    <i data-lucide="eye" style="width: 12px; height: 12px;"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                tableBody.innerHTML = quotesHTML;
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load quotes:', error);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #666; padding: 2rem;">Error loading quotes</td></tr>`;
            }
        }

        // View quote details
        async function viewQuote(quoteId) {
            try {
                const quote = await __api(`/quotes/${quoteId}`);
                displayQuoteResults(quote);
            } catch (error) {
                console.error('Failed to load quote:', error);
                alert('Error loading quote details');
            }
        }

        // Convert to sale
        async function convertToSale(quoteId) {
            if (!confirm('Convert this quote to a sale?')) return;
            
            try {
                const user = JSON.parse(sessionStorage.getItem('syncedup:user') || '{}');
                const quote = await __api(`/quotes/${quoteId}`);
                
                const sale = {
                    id: `S-${Date.now()}`,
                    agentId: user.id,
                    quoteId: quoteId,
                    customer: `${quote.firstName} ${quote.lastName}`,
                    product: quote.productType,
                    amount: parseFloat(quote.annualPremium),
                    commission: parseFloat(quote.commission),
                    createdAt: new Date().toISOString()
                };
                
                const response = await __api('/sales', {
                    method: 'POST',
                    body: JSON.stringify(sale)
                });
                
                if (response.ok) {
                    alert('Quote converted to sale successfully!');
                    setTimeout(() => {
                        window.location.href = 'sales.html';
                    }, 1500);
                } else {
                    alert('Failed to convert quote to sale');
                }
            } catch (error) {
                console.error('Error converting to sale:', error);
                alert('Error converting quote to sale');
            }
        }

        // Email quote
        function emailQuote(quoteId) {
            alert(`Quote ${quoteId} emailed to customer successfully!`);
            // In real implementation, would make API call to send email
        }

        // Print quote
        function printQuote(quoteId) {
            window.print();
        }

        // Clear form
        function clearForm() {
            document.getElementById('quoteForm').reset();
            selectedProduct = null;
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('additionalOptions').style.display = 'none';
            document.getElementById('quoteResults').style.display = 'none';
        }

        // Export quotes
        function exportQuotes() {
            // Generate CSV from real quotes data (no fake data)
            if (quotes.length === 0) {
                alert('No quotes to export');
                return;
            }
            
            const csvHeader = 'Date,Customer,Product,Premium,Status\n';
            const csvRows = quotes.map(quote => 
                `${quote.date},${quote.customer},${quote.product},${quote.premium},${quote.status}`
            ).join('\n');
            const csvContent = csvHeader + csvRows;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quotes-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = 'https://insurance.syncedupsolutions.com/login.html';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>

    <!-- Classic Mode Toggle System -->
    <script src="/js/classic-mode.js"></script>
    <script src="/assets/session-prod.js"></script>
</body>
</html>