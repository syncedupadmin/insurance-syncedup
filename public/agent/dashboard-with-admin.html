<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncedUp Insurance Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        /* Glass Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .card-icon.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-icon.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .card-icon.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .card-icon.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .card-icon.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .card-icon svg {
            width: 24px;
            height: 24px;
        }

        .card h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        /* Product List */
        .product-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            padding-right: 0.5rem;
        }

        .product-list::-webkit-scrollbar {
            width: 8px;
        }

        .product-list::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .product-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .product-item {
            background: rgba(102, 126, 234, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .product-item.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #667eea;
        }

        .product-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .product-type {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 0.5rem;
        }

        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Add-on Cards */
        .addon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .addon-item {
            background: rgba(102, 126, 234, 0.05);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .addon-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .addon-item.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #667eea;
        }

        .addon-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .addon-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
        }

        /* Cost Breakdown */
        .cost-breakdown {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: #4a5568;
        }

        .cost-item.total {
            border-top: 2px solid rgba(102, 126, 234, 0.2);
            padding-top: 0.75rem;
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        /* Split Sale Toggle */
        .split-sale-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #cbd5e0;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Success/Error Messages */
        #saleResult, #performanceResult {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            border: 2px solid #48bb78;
            color: #22543d;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(252, 129, 129, 0.1) 0%, rgba(245, 101, 101, 0.1) 100%);
            border: 2px solid #fc8181;
            color: #742a2a;
        }

        /* Admin Controls */
        .admin-controls {
            background: linear-gradient(135deg, rgba(237, 137, 54, 0.1) 0%, rgba(221, 107, 32, 0.1) 100%);
            border: 2px solid #ed8936;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .admin-controls h4 {
            color: #dd6b20;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .agent-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(237, 137, 54, 0.2);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .agent-option {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .agent-option:hover {
            background: rgba(237, 137, 54, 0.1);
        }

        .agent-option.selected {
            background: rgba(237, 137, 54, 0.2);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SyncedUp Insurance Portal</h1>
            <p id="headerSubtitle">Agent Dashboard</p>
        </div>

        <div class="grid">
            <!-- Quote Products Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <h2>Quote Products</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="stateSelect">Select State</label>
                        <select id="stateSelect">
                            <option value="">Choose a state...</option>
                            <option value="AL">Alabama</option>
                            <option value="AR">Arkansas</option>
                            <option value="AZ">Arizona</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="MS">Mississippi</option>
                            <option value="NC">North Carolina</option>
                            <option value="NV">Nevada</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="SC">South Carolina</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="VA">Virginia</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="coverageType">Coverage Type</label>
                        <select id="coverageType">
                            <option value="">Choose type...</option>
                            <option value="individual">Individual</option>
                            <option value="family">Family</option>
                            <option value="individual_spouse">Individual + Spouse</option>
                            <option value="individual_children">Individual + Children</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="getProductsBtn" onclick="getProducts()">Get Available Products</button>
                
                <div id="productList" class="product-list" style="display: none;">
                    <!-- Products will be populated here -->
                </div>
                
                <div id="addonSection" style="display: none; margin-top: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Available Add-ons</label>
                    <div class="addon-grid" id="addonList">
                        <!-- Add-ons will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Record Sale Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon success">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <h2 id="recordSaleTitle">Record Sale</h2>
                </div>
                
                <!-- Admin Controls for Recording Sales for Other Agents -->
                <div id="adminSaleControls" class="admin-controls" style="display: none;">
                    <h4>👑 Admin: Record Sale for Agent</h4>
                    <div class="form-group">
                        <label for="adminAgentSelect">Select Agent</label>
                        <select id="adminAgentSelect" onchange="updateSaleAgent()">
                            <option value="">Record for myself</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="split-sale-toggle">
                    <div class="toggle-switch" id="splitSaleToggle" onclick="toggleSplitSale()">
                        <div class="toggle-slider"></div>
                    </div>
                    <label style="margin: 0; cursor: pointer;" onclick="toggleSplitSale()">Split Sale (Different payment months)</label>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input type="text" id="customerName" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Customer Email</label>
                        <input type="email" id="customerEmail" placeholder="john@email.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="selectedProduct">Selected Health Plan</label>
                    <input type="text" id="selectedProduct" readonly placeholder="Click a product from Quote Products">
                    <input type="hidden" id="productPrice" value="0">
                </div>
                
                <div class="form-group" id="healthPostDateGroup">
                    <label for="healthPostDate">Health Plan Effective Date</label>
                    <input type="date" id="healthPostDate">
                </div>
                
                <div class="form-group">
                    <label for="selectedAddon">Selected Add-on</label>
                    <input type="text" id="selectedAddon" readonly placeholder="Click an add-on (optional)">
                    <input type="hidden" id="addonPrice" value="0">
                </div>
                
                <div class="form-group" id="addonPostDateGroup" style="display: none;">
                    <label for="addonPostDate">Add-on Effective Date</label>
                    <input type="date" id="addonPostDate">
                </div>
                
                <div class="cost-breakdown" id="costBreakdown">
                    <div class="cost-item">
                        <span>Health Plan Premium:</span>
                        <span id="healthPremiumDisplay">$0.00</span>
                    </div>
                    <div class="cost-item">
                        <span>Add-on Premium:</span>
                        <span id="addonPremiumDisplay">$0.00</span>
                    </div>
                    <div class="cost-item">
                        <span>Enrollment Fee:</span>
                        <span>$25.00</span>
                    </div>
                    <div class="cost-item total">
                        <span>Total Monthly Premium:</span>
                        <span id="totalPremiumDisplay">$25.00</span>
                    </div>
                    <div class="cost-item" style="color: #059669; font-weight: 600;">
                        <span>Agent Commission (30%):</span>
                        <span id="commissionDisplay">$0.00</span>
                    </div>
                </div>
                
                <button class="btn success" onclick="recordSale()">Record Sale</button>
                
                <div id="saleResult"></div>
            </div>

            <!-- Agent Performance Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                    </div>
                    <h2>Performance Analytics</h2>
                </div>
                
                <!-- Admin Controls for Viewing Agent Performance -->
                <div id="adminPerfControls" class="admin-controls" style="display: none;">
                    <h4>👑 Admin: View Agent Performance</h4>
                    <div class="form-group">
                        <label for="adminPerfAgentSelect">Select Agent</label>
                        <select id="adminPerfAgentSelect" onchange="updatePerformanceAgent()">
                            <option value="">My Performance</option>
                            <option value="ALL">🌟 All Agents Combined</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="timeframe">Time Period</label>
                    <select id="timeframe">
                        <option value="thisweek">This Week</option>
                        <option value="lastweek">Last Week</option>
                        <option value="thismonth">This Month</option>
                        <option value="lastmonth">Last Month</option>
                    </select>
                </div>
                
                <button class="btn info" onclick="getAgentPerformance()">View Performance</button>
                
                <div id="performanceDashboard" style="display: none;">
                    <div class="dashboard-stats" style="margin-top: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-number" id="totalSales">0</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalPremium">$0</div>
                            <div class="stat-label">Premium</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCommission">$0</div>
                            <div class="stat-label">Commission</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgSale">$0</div>
                            <div class="stat-label">Avg Sale</div>
                        </div>
                    </div>
                </div>
                
                <div id="performanceResult"></div>
            </div>

            <!-- Admin Tools Card (Only visible to admins) -->
            <div class="card" id="adminToolsCard" style="display: none;">
                <div class="card-header">
                    <div class="card-icon warning">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1l3 6 6 1-3 6-6 1-3-6-6-1 3-6 6-1z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </div>
                    <h2>👑 Admin Tools</h2>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAgents">0</div>
                        <div class="stat-label">Active Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTeamSales">0</div>
                        <div class="stat-label">Team Sales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTeamRevenue">$0</div>
                        <div class="stat-label">Team Revenue</div>
                    </div>
                </div>
                
                <button class="btn warning" onclick="exportAllData()">📊 Export All Sales Data</button>
                <button class="btn info" onclick="viewTeamLeaderboard()">🏆 View Team Leaderboard</button>
                <button class="btn danger" onclick="manageAgents()">👥 Manage Agents</button>
                
                <div id="adminResults"></div>
            </div>
        </div>
    </div>

    <script>
        // Get agent info from session/localStorage
        let currentAgent = null;
        let isAdmin = false;
        let selectedAgentForSale = null;
        let selectedAgentForPerformance = null;
        
        // Agent data will be loaded from API - no fake data
        let agentsData = [];
        
        // Check for logged in user on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get agent data from localStorage (set during login)
            const userData = localStorage.getItem('syncedup_user');
            if (userData) {
                currentAgent = JSON.parse(userData);
                console.log('Logged in as:', currentAgent.name, '- ID:', currentAgent.id);
                
                // Check if user is admin
                isAdmin = currentAgent.role === 'admin' || currentAgent.role === 'super-admin';
                
                if (isAdmin) {
                    setupAdminInterface();
                }
            } else {
                // Redirect to login if not authenticated
                window.location.href = '/login.html';
            }
        });

        // Setup admin interface
        function setupAdminInterface() {
            console.log('Setting up admin interface for:', currentAgent.name);
            
            // Update header
            document.getElementById('headerSubtitle').textContent = '👑 Admin Dashboard';
            
            // Show admin controls
            document.getElementById('adminSaleControls').style.display = 'block';
            document.getElementById('adminPerfControls').style.display = 'block';
            document.getElementById('adminToolsCard').style.display = 'block';
            
            // Populate agent dropdowns
            populateAgentDropdowns();
            
            // Load admin stats
            loadAdminStats();
        }

        // Populate agent dropdowns with real agent data
        function populateAgentDropdowns() {
            const saleSelect = document.getElementById('adminAgentSelect');
            const perfSelect = document.getElementById('adminPerfAgentSelect');
            
            // Clear existing options (except first one)
            saleSelect.innerHTML = '<option value="">Record for myself</option>';
            perfSelect.innerHTML = '<option value="">My Performance</option><option value="ALL">🌟 All Agents Combined</option>';
            
            // Add agents from mock data (in production, this would come from API)
            agentsData.filter(agent => agent.active).forEach(agent => {
                const saleOption = document.createElement('option');
                saleOption.value = agent.id;
                saleOption.textContent = `${agent.name} (${agent.id})`;
                saleSelect.appendChild(saleOption);
                
                const perfOption = document.createElement('option');
                perfOption.value = agent.id;
                perfOption.textContent = `${agent.name} (${agent.id})`;
                perfSelect.appendChild(perfOption);
            });
        }

        // Update sale agent selection
        function updateSaleAgent() {
            const selectedAgentId = document.getElementById('adminAgentSelect').value;
            selectedAgentForSale = selectedAgentId || null;
            
            const title = document.getElementById('recordSaleTitle');
            if (selectedAgentId) {
                const agent = agentsData.find(a => a.id === selectedAgentId);
                title.textContent = `Record Sale for ${agent?.name || 'Agent'}`;
            } else {
                title.textContent = 'Record Sale';
            }
        }

        // Update performance agent selection
        function updatePerformanceAgent() {
            const selectedAgentId = document.getElementById('adminPerfAgentSelect').value;
            selectedAgentForPerformance = selectedAgentId || null;
        }

        // Load admin statistics
        function loadAdminStats() {
            // Mock data - in production this would come from API
            document.getElementById('totalAgents').textContent = agentsData.filter(a => a.active).length;
            document.getElementById('totalTeamSales').textContent = '156';
            document.getElementById('totalTeamRevenue').textContent = '$468K';
        }

        // Export all sales data (admin function)
        function exportAllData() {
            if (!isAdmin) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            console.log('Exporting all sales data...');
            
            // Mock export functionality
            const csvData = [
                'Agent ID,Agent Name,Customer,Product,Premium,Commission,Date',
                'AGENT001,John Smith,John Doe,Health Plan A,$295.00,$88.50,2025-08-30',
                'AGENT002,Jane Doe,Mary Johnson,Health Plan B,$425.00,$127.50,2025-08-29',
                'AGENT003,Mike Johnson,Bob Wilson,Health Plan C,$355.00,$106.50,2025-08-28'
            ].join('\\n');
            
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all-sales-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAdminResult('✅ Sales data exported successfully!', 'success');
        }

        // View team leaderboard
        function viewTeamLeaderboard() {
            if (!isAdmin) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const leaderboardData = [
                { name: 'John Smith', sales: 45, revenue: '$134,500' },
                { name: 'Jane Doe', sales: 38, revenue: '$114,200' },
                { name: 'Mike Johnson', sales: 32, revenue: '$96,800' },
                { name: 'David Brown', sales: 28, revenue: '$84,400' }
            ];
            
            let html = '<h4 style="margin: 1rem 0;">🏆 Team Leaderboard (This Month)</h4>';
            html += '<div style="max-height: 200px; overflow-y: auto;">';
            
            leaderboardData.forEach((agent, index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; margin-bottom: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                        <span><strong>#${index + 1}</strong> ${agent.name}</span>
                        <span>${agent.sales} sales • ${agent.revenue}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            showAdminResult(html, 'info');
        }

        // Manage agents
        function manageAgents() {
            if (!isAdmin) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            let html = '<h4 style="margin: 1rem 0;">👥 Agent Management</h4>';
            html += '<div style="max-height: 250px; overflow-y: auto;">';
            
            agentsData.forEach(agent => {
                const statusColor = agent.active ? '#48bb78' : '#f56565';
                const statusText = agent.active ? 'Active' : 'Inactive';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                        <div>
                            <strong>${agent.name}</strong><br>
                            <small>${agent.email} • ${agent.id}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span><br>
                            <button onclick="toggleAgentStatus('${agent.id}')" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; background: ${statusColor}; color: white; cursor: pointer;">
                                ${agent.active ? 'Deactivate' : 'Activate'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            showAdminResult(html, 'info');
        }

        // Toggle agent status
        function toggleAgentStatus(agentId) {
            const agent = agentsData.find(a => a.id === agentId);
            if (agent) {
                agent.active = !agent.active;
                populateAgentDropdowns(); // Refresh dropdowns
                manageAgents(); // Refresh the management view
                showAdminResult(`✅ ${agent.name} status updated to ${agent.active ? 'Active' : 'Inactive'}`, 'success');
            }
        }

        // Show admin result messages
        function showAdminResult(message, type) {
            const resultDiv = document.getElementById('adminResults');
            resultDiv.className = type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'info';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Product database with real FirstEnroll products
        const products = {
            'AL': {
                'individual': [
                    { id: 'good-health-ind-al', name: 'Good Health Distribution Partner', type: 'Individual', price: 339 },
                    { id: 'summit-100-ind-al', name: 'Summit Plan 100', type: 'Individual', price: 232 },
                    { id: 'summit-200-ind-al', name: 'Summit Plan 200', type: 'Individual', price: 270 },
                    { id: 'sigma-plus-100-ind-al', name: 'Sigma Care PLUS 100', type: 'Individual', price: 214 }
                ],
                'family': [
                    { id: 'good-health-fam-al', name: 'Good Health Distribution Partner', type: 'Family', price: 569 },
                    { id: 'summit-100-fam-al', name: 'Summit Plan 100', type: 'Family', price: 453 },
                    { id: 'summit-200-fam-al', name: 'Summit Plan 200', type: 'Family', price: 510 },
                    { id: 'sigma-plus-100-fam-al', name: 'Sigma Care PLUS 100', type: 'Family', price: 428 }
                ]
            },
            'AZ': {
                'individual': [
                    { id: 'good-health-ind-az', name: 'Good Health Distribution Partner', type: 'Individual', price: 339 },
                    { id: 'summit-100-ind-az', name: 'Summit Plan 100', type: 'Individual', price: 232 },
                    { id: 'access-health-trad-az', name: 'Access Health Traditional STM', type: 'Individual', price: 125 },
                    { id: 'access-health-lite-az', name: 'Access Health Lite STM', type: 'Individual', price: 89 }
                ],
                'family': [
                    { id: 'good-health-fam-az', name: 'Good Health Distribution Partner', type: 'Family', price: 569 },
                    { id: 'summit-100-fam-az', name: 'Summit Plan 100', type: 'Family', price: 453 },
                    { id: 'access-health-trad-fam-az', name: 'Access Health Traditional STM', type: 'Family', price: 285 }
                ]
            }
            // Add more states and products as needed
        };

        const addons = [
            { id: 'dental-vision', name: 'Dental & Vision', price: 49 },
            { id: 'accident', name: 'Accident Protection', price: 35 },
            { id: 'critical-illness', name: 'Critical Illness', price: 65 },
            { id: 'life-50k', name: 'Life Insurance $50K', price: 25 },
            { id: 'telemedicine', name: 'Telemedicine', price: 15 }
        ];

        let selectedProduct = null;
        let selectedAddon = null;
        let splitSale = false;

        function getProducts() {
            const state = document.getElementById('stateSelect').value;
            const coverage = document.getElementById('coverageType').value;
            
            if (!state || !coverage) {
                alert('Please select both state and coverage type');
                return;
            }
            
            const stateProducts = products[state];
            if (!stateProducts || !stateProducts[coverage]) {
                alert('No products available for this selection');
                return;
            }
            
            const productList = document.getElementById('productList');
            const addonSection = document.getElementById('addonSection');
            productList.innerHTML = '';
            
            stateProducts[coverage].forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.onclick = () => selectProduct(product);
                item.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-type">${product.type} Coverage</div>
                    <div class="product-price">${product.price}/month</div>
                `;
                productList.appendChild(item);
            });
            
            // Show add-ons
            const addonList = document.getElementById('addonList');
            addonList.innerHTML = '';
            addons.forEach(addon => {
                const item = document.createElement('div');
                item.className = 'addon-item';
                item.onclick = () => selectAddon(addon);
                item.innerHTML = `
                    <div class="addon-name">${addon.name}</div>
                    <div class="addon-price">${addon.price}</div>
                `;
                addonList.appendChild(item);
            });
            
            productList.style.display = 'block';
            addonSection.style.display = 'block';
        }

        function selectProduct(product) {
            selectedProduct = product;
            document.getElementById('selectedProduct').value = `${product.name} - ${product.type}`;
            document.getElementById('productPrice').value = product.price;
            
            // Update UI
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateCostBreakdown();
        }

        function selectAddon(addon) {
            selectedAddon = addon;
            document.getElementById('selectedAddon').value = addon.name;
            document.getElementById('addonPrice').value = addon.price;
            
            // Update UI
            document.querySelectorAll('.addon-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateCostBreakdown();
        }

        function toggleSplitSale() {
            splitSale = !splitSale;
            const toggle = document.getElementById('splitSaleToggle');
            const addonDateGroup = document.getElementById('addonPostDateGroup');
            
            if (splitSale) {
                toggle.classList.add('active');
                addonDateGroup.style.display = 'block';
            } else {
                toggle.classList.remove('active');
                addonDateGroup.style.display = 'none';
            }
        }

        function updateCostBreakdown() {
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            const addonPrice = parseFloat(document.getElementById('addonPrice').value) || 0;
            const enrollmentFee = 25;
            const total = productPrice + addonPrice;
            const commission = total * 0.30;
            
            document.getElementById('healthPremiumDisplay').textContent = `${productPrice.toFixed(2)}`;
            document.getElementById('addonPremiumDisplay').textContent = `${addonPrice.toFixed(2)}`;
            document.getElementById('totalPremiumDisplay').textContent = `${(total + enrollmentFee).toFixed(2)}`;
            document.getElementById('commissionDisplay').textContent = `${commission.toFixed(2)}`;
        }

        function recordSale() {
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            
            if (!customerName || !customerEmail || !selectedProduct) {
                alert('Please fill in all required fields and select a product');
                return;
            }
            
            // Determine which agent this sale is for
            const saleAgentId = selectedAgentForSale || currentAgent?.id || 'AGENT001';
            const saleAgentName = selectedAgentForSale ? 
                agentsData.find(a => a.id === selectedAgentForSale)?.name || 'Unknown Agent' : 
                currentAgent?.name || 'Unknown Agent';
            
            const saleData = {
                agentId: saleAgentId,
                agentName: saleAgentName,
                recordedBy: isAdmin ? currentAgent.name : saleAgentName,
                customerName,
                customerEmail,
                product: selectedProduct,
                addon: selectedAddon,
                splitSale,
                healthEffectiveDate: document.getElementById('healthPostDate').value,
                addonEffectiveDate: splitSale ? document.getElementById('addonPostDate').value : document.getElementById('healthPostDate').value,
                timestamp: new Date().toISOString()
            };
            
            // Here you would send to your API
            console.log('Recording sale:', saleData);
            
            const resultDiv = document.getElementById('saleResult');
            resultDiv.className = 'success-message';
            resultDiv.style.display = 'block';
            
            const adminNote = selectedAgentForSale ? `<br><small>👑 Recorded by admin for ${saleAgentName}</small>` : '';
            
            resultDiv.innerHTML = `
                <strong>✓ Sale Recorded Successfully!</strong><br>
                Agent: ${saleAgentName}<br>
                Customer: ${customerName}<br>
                Product: ${selectedProduct.name}<br>
                ${selectedAddon ? `Add-on: ${selectedAddon.name}<br>` : ''}
                Commission: ${((selectedProduct.price + (selectedAddon?.price || 0)) * 0.30).toFixed(2)}
                ${adminNote}
            `;
            
            // Reset form after 3 seconds
            setTimeout(() => {
                clearSaleForm();
                resultDiv.style.display = 'none';
            }, 3000);
        }

        function clearSaleForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('selectedProduct').value = '';
            document.getElementById('selectedAddon').value = '';
            document.getElementById('productPrice').value = '0';
            document.getElementById('addonPrice').value = '0';
            document.getElementById('healthPostDate').value = '';
            document.getElementById('addonPostDate').value = '';
            selectedProduct = null;
            selectedAddon = null;
            updateCostBreakdown();
        }

        async function getAgentPerformance() {
            const timeframe = document.getElementById('timeframe').value;
            
            // Determine which agent's performance to view
            let agentId, displayName;
            
            if (selectedAgentForPerformance === 'ALL') {
                agentId = 'ALL';
                displayName = 'All Agents Combined';
            } else if (selectedAgentForPerformance) {
                agentId = selectedAgentForPerformance;
                const agent = agentsData.find(a => a.id === selectedAgentForPerformance);
                displayName = agent ? agent.name : 'Unknown Agent';
            } else {
                agentId = currentAgent?.id || 'AGENT001';
                displayName = currentAgent?.name || 'My';
            }
            
            try {
                // Call API with selected agent's ID
                const response = await fetch(`/api/dashboard?agentId=${agentId}&timeframe=${timeframe}`);
                const performanceData = await response.json();
                
                // Adjust data if viewing all agents
                let multiplier = 1;
                if (agentId === 'ALL') {
                    multiplier = agentsData.filter(a => a.active).length; // Simulate combined data
                }
                
                document.getElementById('totalSales').textContent = (performanceData.totalSales || 12) * multiplier;
                document.getElementById('totalPremium').textContent = `${((performanceData.totalPremium || 28500) * multiplier).toLocaleString()}`;
                document.getElementById('totalCommission').textContent = `${((performanceData.totalCommission || 8550) * multiplier).toLocaleString()}`;
                document.getElementById('avgSale').textContent = `${(performanceData.averageSale || 2375).toLocaleString()}`;
                
                document.getElementById('performanceDashboard').style.display = 'block';
                
                // Show whose performance is being displayed
                if (isAdmin && (selectedAgentForPerformance || agentId === 'ALL')) {
                    const resultDiv = document.getElementById('performanceResult');
                    resultDiv.className = 'info';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `👑 Viewing performance data for: <strong>${displayName}</strong>`;
                    
                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Performance API error:', error);
                // Show empty state when API fails - no fake data
                document.getElementById('totalSales').textContent = '0';
                document.getElementById('totalPremium').textContent = '$0';
                document.getElementById('totalCommission').textContent = '$0';
                document.getElementById('avgSale').textContent = '$0';
                
                document.getElementById('performanceDashboard').style.display = 'block';
            }
        }
    </script>
    <script src="/assets/session-prod.js"></script>
</body>
</html>