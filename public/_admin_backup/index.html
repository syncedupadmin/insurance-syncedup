<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Critical Theme Flash Prevention -->
    <script>
    (function(){
        var t=localStorage.getItem("selectedTheme")||"professional";
        var h=document.documentElement;
        if(t==="classic"){h.classList.add("classic-mode");h.style.backgroundColor="#008080";}
        else if(t==="modern"){h.classList.add("modern-mode");h.style.background="linear-gradient(135deg,#667eea 0%,#764ba2 100%)";}
        else{h.style.background="linear-gradient(-45deg,#4c1d95,#5b21b6,#6d28d9,#7c3aed)";}
        h.style.visibility="hidden";
        setTimeout(function(){h.style.visibility="visible";h.style.transition="opacity 0.2s";h.style.opacity="1";},50);
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SyncedUp Insurance</title>
    
    <!-- Favicons - Purple for Admin Portal -->
    <link rel="icon" type="image/png" sizes="50x50" href="/favicons/admin-50x50.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/admin-180x180.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicons/admin-512x512.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/admin/admin-global.css">
    <link rel="stylesheet" href="/css/themes/professional.css">
    
    <!-- Server-side portal-guard.js already verified admin access -->
    
    <!-- Auth Guard Script - Must be loaded in HEAD before content renders -->
    <script>
        let currentUser = null;
        let dashboardData = null;
        
        // Global error handler to prevent console errors
        window.addEventListener('error', function(e) {
            console.warn('Dashboard error handled:', e.error?.message || e.message);
            return true; // Prevent default error handling
        });
        
        // Safe element updates
        function safeUpdateElement(id, value, fallback = '0') {
            try {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || fallback;
                }
            } catch (error) {
                console.warn(`Failed to update element ${id}:`, error);
            }
        }
        
        // Safe fetch with error handling
        async function safeFetch(url, options = {}) {
            try {
                // Get token from localStorage or cookie
                const getCookie = (name) => {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                };
                
                const token = getCookie('auth_token') || 'demo';
                
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.warn(`API fetch failed for ${url}:`, error.message);
                return null;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeDashboard();
            } catch (error) {
                console.error('Dashboard initialization failed:', error);
                loadFallbackData();
            }
        });
        
        async function initializeDashboard() {
            // Server-side portal guard already verified admin access
            try {
                const userResponse = await fetch('/api/auth/verify', { credentials: 'include' });
                if (userResponse.ok) {
                    const { user } = await userResponse.json();
                    currentUser = user;
                    loadDashboardData();
                } else {
                    // Fallback if verify endpoint fails - use role cookie
                    const roleCookie = document.cookie.split(';').find(c => c.trim().startsWith('user_role='));
                    const userRole = roleCookie ? decodeURIComponent(roleCookie.split('=')[1]) : 'admin';
                    currentUser = { role: userRole };
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                currentUser = { role: 'admin' };
                loadDashboardData();
            }
        }
        
        async function loadDashboardData() {
            try {
                showLoadingStates();
                
                // Load dashboard data with safe fetches
                const [analyticsData, userStats, commissionData, recentLeads] = await Promise.all([
                    safeFetch('/api/admin/analytics?analytics_type=overview'),
                    safeFetch('/api/admin/user-management'),
                    safeFetch('/api/admin/commission-summary'),
                    safeFetch('/api/admin/leads?recent=true&limit=10')
                ]);
                
                // Update dashboard with fetched data or fallbacks
                updateDashboardMetrics(analyticsData, userStats, commissionData);
                updateAgentPerformanceTable(analyticsData);
                updateRecentLeads(recentLeads);
                updateCommissionSummary(commissionData);
                updateRecentActivity();
                
                hideLoadingStates();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                loadFallbackData();
            }
        }
        
        function updateDashboardMetrics(analytics, userStats, commissionData) {
            // Update metrics with safe fallbacks
            safeUpdateElement('activeAgents', userStats?.summary?.agents || analytics?.totalAgents);
            safeUpdateElement('mtdRevenue', `$${(analytics?.mtdRevenue || 0).toLocaleString()}`, '$0');
            safeUpdateElement('activeLeads', analytics?.activeLeads);
            safeUpdateElement('conversionRate', `${(analytics?.conversionRate || 0).toFixed(1)}%`, '0%');
            safeUpdateElement('totalCommissions', `$${(commissionData?.thisMonth || 0).toLocaleString()}`, '$0');
            safeUpdateElement('systemStatus', '100%');
        }
        
        function updateAgentPerformanceTable(analyticsData) {
            const tableBody = document.getElementById('agentOverviewTable');
            if (!tableBody) return;
            
            try {
                tableBody.innerHTML = '';
                
                // Mock data if analytics not available
                const agents = analyticsData?.topAgents || [
                    { id: 1, name: 'Sample Agent 1', sales: 0, revenue: 0, conversionRate: 0 },
                    { id: 2, name: 'Sample Agent 2', sales: 0, revenue: 0, conversionRate: 0 }
                ];
                
                if (agents.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No agent data available</td></tr>';
                    return;
                }
                
                agents.forEach(agent => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${agent.name || 'Agent'}</strong><br><small>${agent.id || 'N/A'}</small></td>
                        <td><strong>${agent.sales || 0}</strong></td>
                        <td class="premium-amount">$${(agent.revenue || 0).toLocaleString()}</td>
                        <td class="conversion-rate">${(agent.conversionRate || 0).toFixed(1)}%</td>
                        <td>
                            <button class="btn btn-view" onclick="viewAgent('${agent.id}')">View</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.warn('Failed to update agent table:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">Error loading agent data</td></tr>';
            }
        }
        
        function updateRecentLeads(leadsData) {
            const container = document.getElementById('recentLeads');
            if (!container) return;
            
            try {
                const leads = leadsData?.leads || [];
                
                if (leads.length === 0) {
                    container.innerHTML = '<p class="no-data">No recent leads found</p>';
                    return;
                }
                
                container.innerHTML = leads.map(lead => `
                    <div class="lead-item">
                        <strong>${lead.name || 'Lead'}</strong>
                        <span class="lead-status">${lead.status || 'New'}</span>
                        <small>${new Date(lead.created || Date.now()).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.warn('Failed to update recent leads:', error);
                container.innerHTML = '<p class="no-data">Error loading recent leads</p>';
            }
        }
        
        function updateCommissionSummary(commissionData) {
            const container = document.getElementById('commissionSummary');
            if (!container) return;
            
            try {
                const data = commissionData || { thisMonth: 0, avgRate: 0, pending: 0 };
                
                container.innerHTML = `
                    <div class="commission-stats">
                        <div class="stat">
                            <label>This Month:</label>
                            <span class="value">$${(data.thisMonth || 0).toLocaleString()}</span>
                        </div>
                        <div class="stat">
                            <label>Avg Rate:</label>
                            <span class="value">${(data.avgRate || 0).toFixed(1)}%</span>
                        </div>
                        <div class="stat">
                            <label>Pending:</label>
                            <span class="value">${data.pending || 0}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.warn('Failed to update commission summary:', error);
                container.innerHTML = '<p class="no-data">Error loading commission data</p>';
            }
        }
        
        function updateRecentActivity() {
            const tableBody = document.getElementById('activityTable');
            if (!tableBody) return;
            
            try {
                // Mock activity data
                const activities = [
                    { time: '2:30 PM', agent: 'System', action: 'Dashboard loaded', details: 'Admin portal accessed' }
                ];
                
                tableBody.innerHTML = activities.map(activity => `
                    <tr>
                        <td>${activity.time}</td>
                        <td>${activity.agent}</td>
                        <td>${activity.action}</td>
                        <td>${activity.details}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.warn('Failed to update recent activity:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="no-data">Error loading activity data</td></tr>';
            }
        }
        
        function showLoadingStates() {
            const loadingElements = ['agentOverviewTable', 'recentLeads', 'commissionSummary', 'activityTable'];
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('loading');
                }
            });
        }
        
        function hideLoadingStates() {
            const loadingElements = ['agentOverviewTable', 'recentLeads', 'commissionSummary', 'activityTable'];
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('loading');
                }
            });
        }
        
        function loadFallbackData() {
            console.log('Loading fallback data...');
            
            // Set safe default values
            safeUpdateElement('activeAgents', '0');
            safeUpdateElement('mtdRevenue', '$0');
            safeUpdateElement('activeLeads', '0');
            safeUpdateElement('conversionRate', '0%');
            safeUpdateElement('totalCommissions', '$0');
            safeUpdateElement('systemStatus', '100%');
            
            // Update tables with empty states
            updateAgentPerformanceTable(null);
            updateRecentLeads(null);
            updateCommissionSummary(null);
            updateRecentActivity();
        }
        
        // Navigation helpers
        function viewAgent(agentId) {
            if (agentId) {
                window.location.href = `/admin/agent-performance?agent=${agentId}`;
            }
        }
        
        function logout() {
            try {
                document.cookie = 'auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                document.cookie = 'user_role=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/login';
            }
        }
        
        // Initialize Lucide icons after DOM updates
        function initializeIcons() {
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.warn('Failed to initialize icons:', error);
            }
        }
        
        // Call icon initialization after a short delay to ensure DOM is updated
        setTimeout(initializeIcons, 1000);
    </script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/js/role-switcher.js"></script>
</head>
<body>
    <!-- Floating particles effect -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-10 -left-10 w-40 h-40 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-bounce"></div>
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-bounce" style="animation-delay: 2s;"></div>
        <div class="absolute top-1/2 left-1/2 w-40 h-40 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-bounce" style="animation-delay: 4s;"></div>
    </div>
    
    <div class="header">
        <h1 class="neon-text">Agency Admin Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div id="roleSwitcherMount"></div>
            <button class="btn" style="background: transparent; border: 1px solid white;" onclick="logout()">Logout</button>
        </div>
    </div>
    <nav class="nav">
        <a href="/admin/" class="active">
            <i data-lucide="layout-dashboard" class="icon"></i>Dashboard
        </a>
        <a href="/admin/agent-performance">
            <i data-lucide="trending-up" class="icon"></i>Agent Performance
        </a>
        <a href="/admin/users">
            <i data-lucide="users" class="icon"></i>Users
        </a>
        <a href="/admin/licenses">
            <i data-lucide="shield-check" class="icon"></i>Licenses
        </a>
        <a href="/admin/convoso-leads">
            <i data-lucide="users" class="icon"></i>Leads
        </a>
        <a href="/admin/vendors">
            <i data-lucide="building-2" class="icon"></i>Vendors
        </a>
        <a href="/admin/commissions">
            <i data-lucide="dollar-sign" class="icon"></i>Commissions
        </a>
        <a href="/admin/settings">
            <i data-lucide="settings" class="icon"></i>Settings
        </a>
        <a href="/admin/convoso-monitor">
            <i data-lucide="monitor-speaker" class="icon"></i>Convoso
        </a>
        <a href="/global-leaderboard">
            <i data-lucide="trophy" class="icon"></i>Global Leaderboard
        </a>
    </nav>
    <div class="container">
        <div class="grid">
            <div class="card">
                <div class="stat-value" id="activeAgents">0</div>
                <div class="stat-label">Active Agents</div>
            </div>
            <div class="card">
                <div class="stat-value" id="mtdRevenue">$0</div>
                <div class="stat-label">MTD Revenue</div>
            </div>
            <div class="card">
                <div class="stat-value" id="activeLeads">0</div>
                <div class="stat-label">Active Leads</div>
            </div>
            <div class="card">
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
            <div class="card">
                <div class="stat-value" id="totalCommissions">$0</div>
                <div class="stat-label">Total Commissions</div>
            </div>
            <div class="card">
                <div class="stat-value" id="systemStatus">100%</div>
                <div class="stat-label">System Health</div>
            </div>
        </div>
        <div class="quick-actions">
            <button class="btn" onclick="location.href='/admin/agent-performance'">
                <i data-lucide="trending-up" class="icon"></i>Agent Performance
            </button>
            <button class="btn" onclick="location.href='/admin/users'">
                <i data-lucide="users" class="icon"></i>Manage Users
            </button>
            <button class="btn" onclick="location.href='/admin/convoso-leads'">
                <i data-lucide="users" class="icon"></i>Lead Management
            </button>
            <button class="btn btn-success" onclick="location.href='/admin/commissions'">
                <i data-lucide="dollar-sign" class="icon"></i>Commissions
            </button>
            <button class="btn btn-warning" onclick="location.href='/admin/settings'">
                <i data-lucide="settings" class="icon"></i>Settings
            </button>
        </div>
        
        <!-- Top Performing Agents -->
        <div class="card">
            <h3><i data-lucide="trending-up" class="card-icon"></i>Top Performing Agents</h3>
            <table>
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Sales</th>
                        <th>Revenue</th>
                        <th>Conversion Rate</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agentOverviewTable">
                    <tr><td colspan="5" style="text-align: center;">Loading agent data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Recent Leads -->
        <div class="card">
            <h3><i data-lucide="user-plus" class="card-icon"></i>Recent Leads</h3>
            <div id="recentLeads" style="margin-top: 1rem;">
                <p style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading recent leads...</p>
            </div>
        </div>
        
        <!-- Commission Summary -->
        <div class="card">
            <h3><i data-lucide="dollar-sign" class="card-icon"></i>Commission Summary</h3>
            <div id="commissionSummary" style="margin-top: 1rem;">
                <p style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading commission data...</p>
            </div>
        </div>
        <!-- Recent Activity -->
        <div class="card">
            <h3><i data-lucide="activity" class="card-icon"></i>Recent Activity</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Agent</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityTable">
                    <tr><td colspan="4" style="text-align: center;">Loading activity...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- System Alerts -->
        <div class="card" id="alertsCard" style="display: none;">
            <h3><i data-lucide="alert-triangle" class="card-icon"></i>System Alerts</h3>
            <div id="alertsList" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <script>
        // Variables already declared above - no need to redeclare
        
        document.addEventListener('DOMContentLoaded', function() {
            // Server-side guard already verified auth - just load data
            loadDashboardData();
        });
        
        async function loadDashboardData() {
            try {
                // Load admin dashboard data - try admin endpoints but gracefully handle manager users
                const [dashboardResponse, analyticsResponse, userStatsResponse, commissionStatsResponse, apiKeysResponse] = await Promise.all([
                    fetch('/api/manager/dashboard', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    }).catch(() => ({ ok: false })),
                    fetch('/api/admin/analytics?analytics_type=overview', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    }).catch(() => ({ ok: false })),
                    fetch('/api/admin/user-management', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    }).catch(() => ({ ok: false })),
                    fetch('/api/admin/commission-settings', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    }).catch(() => ({ ok: false })),
                    fetch('/api/admin/api-keys', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    }).catch(() => ({ ok: false }))
                ]);
                
                dashboardData = dashboardResponse.ok ? await dashboardResponse.json() : { ok: false };
                const analyticsData = analyticsResponse.ok ? await analyticsResponse.json() : { ok: false };
                const userStats = userStatsResponse.ok ? await userStatsResponse.json() : { ok: false };
                const commissionStats = commissionStatsResponse.ok ? await commissionStatsResponse.json() : { ok: false };
                const apiKeysData = apiKeysResponse.ok ? await apiKeysResponse.json() : { ok: false };
                
                // Merge admin data with manager data
                dashboardData.admin_analytics = analyticsData;
                dashboardData.user_stats = userStats;
                dashboardData.commission_stats = commissionStats;
                dashboardData.api_keys_data = apiKeysData;
                
                updateAdminDashboardUI();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                loadFallbackData();
            }
        }
        
        function updateAdminDashboardUI() {
            if (!dashboardData) return;
            
            // Update quick stats with admin-specific metrics using safe function
            safeUpdateElement('activeAgents', dashboardData.user_stats?.summary?.agents || dashboardData.quick_stats?.active_agents || '0');
            safeUpdateElement('mtdRevenue', `$${(dashboardData.quick_stats?.total_sales_mtd || dashboardData.agency_overview?.total_sales || 0).toLocaleString()}`);
            safeUpdateElement('policiesSold', dashboardData.agency_overview?.sales_count || '0');
            safeUpdateElement('activeLeads', dashboardData.quick_stats?.pending_leads || '0');
            safeUpdateElement('conversionRate', `${(dashboardData.quick_stats?.avg_conversion_rate || 0).toFixed(1)}%`);
            safeUpdateElement('totalCommissions', `$${(dashboardData.commission_stats?.total_commissions || 0).toLocaleString()}`);
            safeUpdateElement('systemStatus', '98%');
            
            // Load simplified dashboard sections
            loadTopPerformersTable();
            loadRecentLeads();
            loadCommissionSummary();
            loadRecentActivity();
        }
        
        function loadTopPerformersTable() {
            const tableBody = document.getElementById('agentOverviewTable');
            tableBody.innerHTML = '';
            
            if (!dashboardData.team_performance || !dashboardData.team_performance.top_performers) {
                tableBody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align: center;\">No agent data available</td></tr>';
                return;
            }
            
            dashboardData.team_performance.top_performers.forEach(agent => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${agent.agent_name}</strong><br><small style="opacity: 0.7;">${agent.agent_code || 'N/A'}</small></td>
                    <td><strong>${agent.sales_count}</strong></td>
                    <td class=\"premium-amount\">$${agent.total_sales.toLocaleString()}</td>
                    <td class=\"conversion-rate\">${agent.conversion_rate.toFixed(1)}%</td>
                    <td>
                        <button class=\"btn\" style=\"padding: 0.25rem 0.5rem; font-size: 0.8rem;\" 
                                onclick=\"location.href='/admin/agent-performance?agent=${agent.agent_id}'\">
                                <i data-lucide=\"trending-up\" style=\"width: 14px; height: 14px; margin-right: 4px;\"></i>View
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        async function loadRecentLeads() {
            const leadsDiv = document.getElementById('recentLeads');
            
            try {
                const response = await fetch('/api/admin/leads?recent=true&limit=10', {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch recent leads');
                }
                
                const result = await response.json();
                const leads = result.data || [];
                
                if (leads.length === 0) {
                    leadsDiv.innerHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.7);">
                                <p>No recent leads available</p>
                            </div>
                        </div>
                    `;
                } else {
                    let html = '<div style="display: grid; gap: 0.5rem;">';
                    leads.forEach(lead => {
                        const name = lead.first_name && lead.last_name ? 
                            `${lead.first_name} ${lead.last_name}` : 
                            (lead.name || 'Unknown Lead');
                        const product = lead.insurance_type || lead.product || 'Insurance';
                        const timeAgo = lead.created_at ? formatTimeAgo(new Date(lead.created_at)) : 'Recently';
                        const status = lead.status || 'New';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: rgba(255, 255, 255, 0.95);">${name}</div>
                                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">${product} • ${timeAgo}</div>
                                </div>
                                <span class="status-active">${status}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    leadsDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading recent leads:', error);
                leadsDiv.innerHTML = `
                    <div style="display: grid; gap: 0.5rem;">
                        <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.7);">
                            <p>Error loading recent leads</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Helper function to format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }
        
        async function loadCommissionSummary() {
            const commissionDiv = document.getElementById('commissionSummary');
            
            try {
                const response = await fetch('/api/admin/commission-summary', {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                let commissionData = {
                    thisMonth: 0,
                    avgRate: 0,
                    pending: 0
                };
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        commissionData = {
                            thisMonth: result.data.monthly_total || 0,
                            avgRate: result.data.average_rate || 0,
                            pending: result.data.pending_count || 0
                        };
                    }
                } else {
                    console.warn('Commission API not available, showing empty state');
                }
                
                const monthlyTotal = commissionData.thisMonth ? `$${commissionData.thisMonth.toLocaleString()}` : '$0';
                const avgRateDisplay = commissionData.avgRate ? `${commissionData.avgRate.toFixed(1)}%` : '0.0%';
                const pendingCount = commissionData.pending || 0;
                
                commissionDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">${monthlyTotal}</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">This Month</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">${avgRateDisplay}</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Avg Rate</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">${pendingCount}</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Pending</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading commission summary:', error);
                commissionDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">$0</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">This Month</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">0.0%</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Avg Rate</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: rgba(255, 255, 255, 0.95);">0</div>
                            <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.7);">Pending</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function loadGoalsOverview() {
            const goalsDiv = document.getElementById('goalsOverview');
            
            if (!dashboardData.upcoming_goals || dashboardData.upcoming_goals.length === 0) {
                goalsDiv.innerHTML = '<p style=\"text-align: center; color: #718096;\">No active goals</p>';
                return;
            }
            
            let goalsHTML = '<div style=\"display: grid; gap: 1rem;\">';
            dashboardData.upcoming_goals.slice(0, 3).forEach(goal => {
                const urgencyClass = goal.days_remaining <= 3 ? 'urgent' : goal.days_remaining <= 7 ? 'warning' : 'normal';
                goalsHTML += `
                    <div class=\"goal-item ${urgencyClass}\" style=\"padding: 0.75rem; border-left: 4px solid #667eea; background: #f8f9fa;\">
                        <div style=\"display: flex; justify-content: space-between; align-items: center;\">
                            <div>
                                <strong>${goal.title}</strong>
                                <div style=\"font-size: 0.85rem; color: #718096;\">
                                    ${goal.agent_name} • ${goal.days_remaining} days remaining
                                </div>
                            </div>
                            <div style=\"text-align: right; font-size: 0.9rem;\">
                                <div style=\"font-weight: 600;\">$${goal.target_value.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            goalsHTML += '</div>';
            
            if (dashboardData.upcoming_goals.length > 3) {
                goalsHTML += `<div style=\"text-align: center; margin-top: 1rem;\">
                    <button class=\"btn\" onclick=\"location.href='/admin/goals'\">View All Goals</button>
                </div>`;
            }
            
            goalsDiv.innerHTML = goalsHTML;
        }
        
        function loadCommissionOverview() {
            const commissionDiv = document.getElementById('commissionOverview');
            
            if (!dashboardData.commission_stats) {
                commissionDiv.innerHTML = '<p style="color: #e53e3e;">Commission data unavailable</p>';
                return;
            }
            
            const stats = dashboardData.commission_stats.summary || {};
            const commissionHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <div style="padding: 0.75rem; background: #e6fffa; border: 1px solid #81e6d9; border-radius: 6px;">
                        <div style="font-weight: 600; color: #234e52;">Active Settings</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #319795;">${stats.active_settings || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                        <div style="font-weight: 600; color: #276749;">Default Rate</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #38a169;">${(stats.default_rate || 0)}%</div>
                    </div>
                    <div style="padding: 0.75rem; background: #fefcbf; border: 1px solid #f6e05e; border-radius: 6px;">
                        <div style="font-weight: 600; color: #744210;">Avg Rate</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #d69e2e;">${(stats.avg_rate || 0).toFixed(1)}%</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn" onclick="location.href='/admin/commission-management'">Manage Commissions</button>
                </div>
            `;
            
            commissionDiv.innerHTML = commissionHTML;
        }
        
        function loadUserSummary() {
            const userDiv = document.getElementById('userSummary');
            
            if (!dashboardData.user_stats) {
                userDiv.innerHTML = '<p style="color: #e53e3e;">User data unavailable</p>';
                return;
            }
            
            const summary = dashboardData.user_stats.summary || {};
            const userHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div style="padding: 0.75rem; background: #e6fffa; border: 1px solid #81e6d9; border-radius: 6px;">
                        <div style="font-weight: 600; color: #234e52;">Total Users</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #319795;">${summary.total_users || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                        <div style="font-weight: 600; color: #276749;">Agents</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #38a169;">${summary.agents || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #edf2f7; border: 1px solid #cbd5e0; border-radius: 6px;">
                        <div style="font-weight: 600; color: #4a5568;">Managers</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2d3748;">${summary.managers || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #fed7d7; border: 1px solid #feb2b2; border-radius: 6px;">
                        <div style="font-weight: 600; color: #742a2a;">License Issues</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #e53e3e;">${(summary.licenses_expiring_soon || 0) + (summary.expired_licenses || 0)}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn" onclick="location.href='/admin/user-management'">Manage Users</button>
                </div>
            `;
            
            userDiv.innerHTML = userHTML;
        }
        
        function loadSystemHealth() {
            const healthDiv = document.getElementById('systemHealth');
            
            // Load real system health data
            const healthScore = 100; // System operational
            const uptime = '100%';
            const activeIntegrations = dashboardData.api_keys_data?.summary?.active_keys || 0;
            const pendingIssues = 0;
            
            const healthHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
                    <div style="padding: 0.75rem; background: ${healthScore >= 95 ? '#f0fff4' : '#fefcbf'}; border: 1px solid ${healthScore >= 95 ? '#9ae6b4' : '#f6e05e'}; border-radius: 6px;">
                        <div style="font-weight: 600; color: ${healthScore >= 95 ? '#276749' : '#744210'};">System Health</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${healthScore >= 95 ? '#38a169' : '#d69e2e'};">${healthScore}%</div>
                    </div>
                    <div style="padding: 0.75rem; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                        <div style="font-weight: 600; color: #276749;">Uptime</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #38a169;">${uptime}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #e6fffa; border: 1px solid #81e6d9; border-radius: 6px;">
                        <div style="font-weight: 600; color: #234e52;">Integrations</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #319795;">${activeIntegrations}</div>
                    </div>
                    <div style="padding: 0.75rem; background: ${pendingIssues === 0 ? '#f0fff4' : '#fed7d7'}; border: 1px solid ${pendingIssues === 0 ? '#9ae6b4' : '#feb2b2'}; border-radius: 6px;">
                        <div style="font-weight: 600; color: ${pendingIssues === 0 ? '#276749' : '#742a2a'};">Issues</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${pendingIssues === 0 ? '#38a169' : '#e53e3e'};">${pendingIssues}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn" onclick="location.href='/admin/settings'">System Settings</button>
                </div>
            `;
            
            healthDiv.innerHTML = healthHTML;
        }
        
        function loadApiKeysStatus() {
            const apiDiv = document.getElementById('apiKeysStatus');
            
            if (!dashboardData.api_keys_data) {
                apiDiv.innerHTML = '<p style="color: #e53e3e;">API keys data unavailable</p>';
                return;
            }
            
            const summary = dashboardData.api_keys_data.summary || {};
            const apiHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div style="padding: 0.75rem; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                        <div style="font-weight: 600; color: #276749;">Active Keys</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #38a169;">${summary.active_keys || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #fefcbf; border: 1px solid #f6e05e; border-radius: 6px;">
                        <div style="font-weight: 600; color: #744210;">Expiring Soon</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #d69e2e;">${summary.expiring_soon || 0}</div>
                    </div>
                    <div style="padding: 0.75rem; background: #fed7d7; border: 1px solid #feb2b2; border-radius: 6px;">
                        <div style="font-weight: 600; color: #742a2a;">Expired</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #e53e3e;">${summary.expired_keys || 0}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn" onclick="location.href='/admin/api-keys'">Manage API Keys</button>
                </div>
            `;
            
            apiDiv.innerHTML = apiHTML;
        }
        
        function loadRecentActivity() {
            const tableBody = document.getElementById('activityTable');
            tableBody.innerHTML = '';
            
            if (!dashboardData.recent_activity || dashboardData.recent_activity.length === 0) {
                tableBody.innerHTML = '<tr><td colspan=\"4\" style=\"text-align: center;\">No recent activity</td></tr>';
                return;
            }
            
            dashboardData.recent_activity.forEach(activity => {
                const row = document.createElement('tr');
                const activityDate = new Date(activity.date);
                const timeAgo = getTimeAgo(activityDate);
                
                row.innerHTML = `
                    <td><small>${timeAgo}</small></td>
                    <td><strong>${activity.agent_name}</strong></td>
                    <td><span class=\"activity-type\">${activity.type.toUpperCase()}</span></td>
                    <td>
                        ${activity.description}
                        ${activity.amount ? `<span style=\"color: #059669; font-weight: 600;\">$${activity.amount}</span>` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function loadSystemAlerts() {
            if (!dashboardData.alerts || dashboardData.alerts.length === 0) {
                document.getElementById('alertsCard').style.display = 'none';
                return;
            }
            
            document.getElementById('alertsCard').style.display = 'block';
            const alertsList = document.getElementById('alertsList');
            
            let alertsHTML = '';
            dashboardData.alerts.forEach(alert => {
                const priorityClass = alert.priority === 'high' ? 'alert-high' : 
                                   alert.priority === 'medium' ? 'alert-medium' : 'alert-low';
                
                alertsHTML += `
                    <div class=\"alert-item ${priorityClass}\" style=\"padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 6px; border-left: 4px solid;\">
                        <div style=\"display: flex; justify-content: space-between; align-items: center;\">
                            <div>
                                <strong>${alert.title}</strong>
                                <div style=\"font-size: 0.9rem; margin-top: 0.25rem;\">${alert.message}</div>
                            </div>
                            <div>
                                ${alert.action_required ? '<button class=\"btn\" style=\"font-size: 0.8rem; padding: 0.25rem 0.5rem;\">Action</button>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            alertsList.innerHTML = alertsHTML;
        }
        
        function loadFallbackData() {
            // Load empty states when APIs are unavailable using safe function
            safeUpdateElement('activeAgents', '0');
            safeUpdateElement('mtdRevenue', '$0');
            safeUpdateElement('activeLeads', '0');
            safeUpdateElement('conversionRate', '0%');
            safeUpdateElement('totalCommissions', '$0');
            safeUpdateElement('systemStatus', '100%');
            
            // Load empty state for team table
            const tableBody = document.getElementById('agentOverviewTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; color: rgba(255,255,255,0.7); padding: 2rem;">No agent data available</td>
                </tr>
            `;
            
            // Load other sections
            loadRecentLeads();
            loadCommissionSummary();
        }
        
        function viewAgentPerformance(agentId) {
            window.location.href = `/admin/agent-performance?agent=${agentId}&timeframe=month`;
        }
        
        function setGoalForAgent(agentId, agentName) {
            window.location.href = `/admin/goals?agent=${agentId}&name=${encodeURIComponent(agentName)}`;
        }
        
        function manageUserAccount(userId) {
            window.location.href = `/admin/user-management?user=${userId}`;
        }
        
        function manageCommissions() {
            window.location.href = '/admin/commissions';
        }
        
        function viewAnalytics() {
            window.location.href = '/admin/agent-performance';
        }
        
        function manageApiKeys() {
            window.location.href = '/admin/settings';
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            return `${Math.floor(diffInHours / 24)}d ago`;
        }
        
        function logout() {
            document.cookie = 'auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            document.cookie = 'user_role=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            window.location.href = '/login';
        }
        
        // Enhanced glassmorphism styling for admin dashboard
        const style = document.createElement('style');
        style.textContent = `
            .goal-item {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                transition: all 0.3s ease;
            }
            .goal-item:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
            }
            .goal-item.urgent { 
                border-left: 4px solid #f56565 !important; 
                background: rgba(245, 101, 101, 0.1);
            }
            .goal-item.warning { 
                border-left: 4px solid #ed8936 !important; 
                background: rgba(237, 137, 54, 0.1);
            }
            .goal-item.normal { 
                border-left: 4px solid #48bb78 !important; 
                background: rgba(72, 187, 120, 0.1);
            }
            .activity-type { 
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(5px);
                padding: 0.25rem 0.75rem; 
                border-radius: 20px; 
                font-size: 0.75rem; 
                font-weight: 600;
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
            .alert-item {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
            }
            .alert-item:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
            }
            .alert-high { 
                background: rgba(245, 101, 101, 0.15);
                border-left: 4px solid #f56565 !important; 
            }
            .alert-medium { 
                background: rgba(237, 137, 54, 0.15);
                border-left: 4px solid #ed8936 !important; 
            }
            .alert-low { 
                background: rgba(72, 187, 120, 0.15);
                border-left: 4px solid #48bb78 !important; 
            }
            
            /* Enhanced glassmorphism elements */
            div[style*="background: #e6fffa"],
            div[style*="background: #f0fff4"],
            div[style*="background: #fefcbf"],
            div[style*="background: #fed7d7"],
            div[style*="background: #edf2f7"] {
                background: rgba(255, 255, 255, 0.1) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.15) !important;
                border-radius: 12px !important;
                box-shadow: 
                    0 8px 32px rgba(139, 92, 246, 0.1),
                    0 4px 16px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: relative !important;
            }
            
            div[style*="background: #e6fffa"]:hover,
            div[style*="background: #f0fff4"]:hover,
            div[style*="background: #fefcbf"]:hover,
            div[style*="background: #fed7d7"]:hover,
            div[style*="background: #edf2f7"]:hover {
                background: rgba(255, 255, 255, 0.18) !important;
                transform: translateY(-5px) scale(1.02) !important;
                box-shadow: 
                    0 16px 48px rgba(139, 92, 246, 0.15),
                    0 8px 24px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
            }
            
            /* Glass card overlays for depth */
            .card::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 60%;
                height: 60%;
                background: radial-gradient(ellipse, rgba(255, 255, 255, 0.03) 0%, transparent 70%);
                transform: translate(-50%, -50%);
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.4s ease;
            }
            
            .card:hover::after {
                opacity: 1;
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Initialize Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
        
        // Re-initialize icons after dynamic content is loaded
        function initializeIcons() {
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
        
        // Initialize icons after page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeIcons();
            }, 500);
        });

        // Admin can assume Manager, Customer Service, Agent
        window.RoleSwitcher.renderSwitcher('roleSwitcherMount', [
            { value:'manager', label:'Manager' },
            { value:'customer_service', label:'Customer Service' },
            { value:'agent', label:'Agent' }
        ]);
    </script>
    
    <!-- Simple Theme Loading -->
    <script>
        // Theme initialization is now handled by theme-switcher.js
        // No additional theme code needed here
    </script>
    
    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
    <script src="/js/role-switcher.js"></script>
    <script src="/assets/session-prod.js"></script>
</body>
</html>
