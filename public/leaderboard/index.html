<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sales Leaderboard - SyncedUp Insurance</title>
    <link rel="stylesheet" href="/leaderboard/css/leaderboard-base.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Auth Guard Script -->
    <script>
        (function () {
          try {
            // Check multiple possible token keys
            const tokenKeys = ['syncedup_token', 'authToken', 'token'];
            const userKeys = ['syncedup_user', 'user', 'currentUser'];
            
            let token = null;
            let userStr = null;
            
            // Try different token keys
            for (const key of tokenKeys) {
              const t = localStorage.getItem(key);
              if (t) {
                token = t;
                console.log('Auth check - Found token with key:', key);
                break;
              }
            }
            
            // Try different user keys
            for (const key of userKeys) {
              const u = localStorage.getItem(key);
              if (u) {
                userStr = u;
                console.log('Auth check - Found user with key:', key);
                break;
              }
            }
            
            console.log('Auth check - Token exists:', !!token);
            console.log('Auth check - User data exists:', !!userStr);
            
            if (!token) {
              console.log('No token found, redirecting to login');
              alert('Authentication required. Please login first.');
              window.location.href = '/login';
              return;
            }
            
            if (!userStr) {
              console.log('No user data found, redirecting to login');
              alert('User data missing. Please login again.');
              window.location.href = '/login';
              return;
            }
            
            const u = JSON.parse(userStr);
            console.log('Auth check - Full user object:', u);
            
            const role = u.role || '';
            // Allow both formats and be more flexible
            const allowed = ['agent','manager','admin','super_admin','customer_service','super-admin','customer-service'];
            
            console.log('Auth check - User role:', role);
            console.log('Auth check - Email:', u.email);
            console.log('Auth check - Role allowed:', allowed.includes(role));
            
            if (!role || !allowed.includes(role)) {
              console.log('Invalid role, redirecting to login. Role was:', role);
              alert(`Access denied. Your role "${role}" is not authorized for the leaderboard.`);
              window.location.href = '/login';
              return;
            }
            
            console.log('Auth check passed for user:', u.email, 'with role:', role);
            
            // Store user info globally for debugging
            window.currentUser = u;
            window.authToken = token;
            
          } catch (error) {
            console.error('Auth check error:', error);
            alert('Authentication error: ' + error.message);
            window.location.href = '/login';
          }
        })();
    </script>
    
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="leaderboard-header">
            <h1 class="leaderboard-title">Global Sales Leaderboard</h1>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="competition" title="Dark theme with neon accents and animations">
                    <span class="theme-icon">üèÜ</span>
                    <span class="theme-name">Competition</span>
                </button>
                <button class="theme-btn" data-theme="analytics" title="Clean design focused on data visualization">
                    <span class="theme-icon">üìä</span>
                    <span class="theme-name">Analytics</span>
                </button>
                <button class="theme-btn" data-theme="gaming" title="Retro arcade aesthetic with 8-bit styling">
                    <span class="theme-icon">üéÆ</span>
                    <span class="theme-name">Gaming</span>
                </button>
            </div>
            <div class="system-status">
                <span class="status-indicator"></span>
                <span>Live Updates Active</span>
            </div>
        </header>
        
        <!-- Controls -->
        <div class="leaderboard-controls">
            <div class="leaderboard-tabs">
                <a href="/leaderboard/index.html" class="leaderboard-tab active">
                    <i data-lucide="trophy"></i>
                    Overall Rankings
                </a>
                <a href="/leaderboard/monthly.html" class="leaderboard-tab">
                    <i data-lucide="calendar"></i>
                    Monthly Leaders
                </a>
                <a href="/leaderboard/teams.html" class="leaderboard-tab">
                    <i data-lucide="users"></i>
                    Team Rankings
                </a>
            </div>
            
            <div class="leaderboard-filters">
                <select class="filter-select" id="office-filter">
                    <option value="all">All Offices Worldwide</option>
                    <option value="us-east">US East</option>
                    <option value="us-west">US West</option>
                    <option value="europe">Europe</option>
                    <option value="asia">Asia Pacific</option>
                </select>
                
                <select class="filter-select" id="period-filter">
                    <option value="current">Current Period</option>
                    <option value="last-month">Last Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
                
                <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
            </div>
        </div>
        
        <!-- Metrics -->
        <div class="leaderboard-metrics">
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Active Agents</div>
                <div class="leaderboard-metric-value" id="active-agents">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Total Sales</div>
                <div class="leaderboard-metric-value" id="total-sales">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Commissions Paid</div>
                <div class="leaderboard-metric-value" id="commissions-paid">--</div>
            </div>
            <div class="leaderboard-metric">
                <div class="leaderboard-metric-label">Offices Competing</div>
                <div class="leaderboard-metric-value" id="offices-competing">--</div>
            </div>
        </div>
        
        <!-- Rankings -->
        <div class="rankings-container">
            <!-- Top 3 Podium -->
            <div class="rankings-podium">
                <div class="podium-place gold">
                    <div class="podium-medal">1</div>
                    <div class="podium-name" id="first-place-name">Loading...</div>
                    <div class="podium-office" id="first-place-office">--</div>
                    <div class="podium-amount" id="first-place-amount">$0</div>
                </div>
                
                <div class="podium-place silver">
                    <div class="podium-medal">2</div>
                    <div class="podium-name" id="second-place-name">Loading...</div>
                    <div class="podium-office" id="second-place-office">--</div>
                    <div class="podium-amount" id="second-place-amount">$0</div>
                </div>
                
                <div class="podium-place bronze">
                    <div class="podium-medal">3</div>
                    <div class="podium-name" id="third-place-name">Loading...</div>
                    <div class="podium-office" id="third-place-office">--</div>
                    <div class="podium-amount" id="third-place-amount">$0</div>
                </div>
            </div>
            
            <!-- Full Rankings Table -->
            <table class="data-table rankings-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Agent</th>
                        <th>Office</th>
                        <th>Sales</th>
                        <th>Policies</th>
                        <th>Commission</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="rankings-tbody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            Loading rankings data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Load leaderboard theme system -->
    <script src="/leaderboard/js/leaderboard-theme.js"></script>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Load leaderboard data
        async function loadLeaderboardData() {
            try {
                const token = localStorage.getItem('syncedup_token');
                if (!token) {
                    console.error('No authentication token found');
                    showErrorState('Authentication required. Please log in.');
                    return;
                }

                const response = await fetch('/api/leaderboard/global', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Leaderboard data loaded:', data);
                    updateMetrics(data.metrics || {});
                    updatePodium(data.topThree || []);
                    updateRankingsTable(data.rankings || []);
                } else if (response.status === 401) {
                    console.error('Authentication failed - redirecting to login');
                    localStorage.removeItem('syncedup_token');
                    localStorage.removeItem('syncedup_user');
                    window.location.href = '/login';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load leaderboard data`);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showErrorState(error.message);
            }
        }
        
        function updateMetrics(metrics) {
            document.getElementById('active-agents').textContent = metrics.activeAgents || '0';
            document.getElementById('total-sales').textContent = `$${(metrics.totalSales || 0).toLocaleString()}`;
            document.getElementById('commissions-paid').textContent = `$${(metrics.commissionsPaid || 0).toLocaleString()}`;
            document.getElementById('offices-competing').textContent = metrics.officesCompeting || '0';
        }
        
        function updatePodium(topThree) {
            if (topThree.length >= 1) {
                document.getElementById('first-place-name').textContent = topThree[0].name || '--';
                document.getElementById('first-place-office').textContent = topThree[0].office || '--';
                document.getElementById('first-place-amount').textContent = `$${(topThree[0].sales || 0).toLocaleString()}`;
            }
            
            if (topThree.length >= 2) {
                document.getElementById('second-place-name').textContent = topThree[1].name || '--';
                document.getElementById('second-place-office').textContent = topThree[1].office || '--';
                document.getElementById('second-place-amount').textContent = `$${(topThree[1].sales || 0).toLocaleString()}`;
            }
            
            if (topThree.length >= 3) {
                document.getElementById('third-place-name').textContent = topThree[2].name || '--';
                document.getElementById('third-place-office').textContent = topThree[2].office || '--';
                document.getElementById('third-place-amount').textContent = `$${(topThree[2].sales || 0).toLocaleString()}`;
            }
        }
        
        function updateRankingsTable(rankings) {
            const tbody = document.getElementById('rankings-tbody');
            
            if (rankings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No rankings data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = rankings.map((agent, index) => `
                <tr>
                    <td>
                        <span class="rank-badge ${index < 3 ? ['gold', 'silver', 'bronze'][index] : ''}">
                            ${index + 1}
                        </span>
                    </td>
                    <td>${agent.name || '--'}</td>
                    <td>${agent.office || '--'}</td>
                    <td>$${(agent.sales || 0).toLocaleString()}</td>
                    <td>${agent.policies || 0}</td>
                    <td>$${(agent.commission || 0).toLocaleString()}</td>
                    <td>
                        <span class="trend-indicator trend-${agent.trend || 'flat'}">
                            <i data-lucide="${getTrendIcon(agent.trend)}"></i>
                            ${agent.trendPercent || '0'}%
                        </span>
                    </td>
                </tr>
            `).join('');
            
            // Re-initialize icons for new content
            lucide.createIcons();
        }
        
        function getTrendIcon(trend) {
            switch (trend) {
                case 'up': return 'trending-up';
                case 'down': return 'trending-down';
                default: return 'minus';
            }
        }
        
        function showErrorState(message = 'Error loading rankings data. Please refresh the page.') {
            document.getElementById('rankings-tbody').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--error);">
                        ${message}
                    </td>
                </tr>
            `;
            
            // Also show error in metrics
            document.getElementById('active-agents').textContent = '--';
            document.getElementById('total-sales').textContent = '--';
            document.getElementById('commissions-paid').textContent = '--';
            document.getElementById('offices-competing').textContent = '--';
        }
        
        function refreshData() {
            loadLeaderboardData();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadLeaderboardData();
            
            // Theme system debugging and fallback
            console.log('DOM loaded, checking theme system...');
            console.log('Current page URL:', window.location.href);
            console.log('Current pathname:', window.location.pathname);
            
            setTimeout(() => {
                const hasThemeClass = document.body.className.includes('lb-') && document.body.className.includes('-mode');
                console.log('Theme system status:', {
                    hasThemeClass,
                    bodyClasses: document.body.className,
                    themeSystem: window.leaderboardTheme ? 'loaded' : 'not loaded'
                });
                
                if (!hasThemeClass) {
                    console.warn('Theme not applied, forcing competition theme...');
                    document.body.classList.add('lb-competition-mode');
                    
                    // Also try to load the CSS manually
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = '/leaderboard/css/themes/competition.css';
                    document.head.appendChild(link);
                    console.log('Manually loaded competition theme CSS');
                }
                
                // Extra debug info
                console.log('Authentication info:', {
                    user: window.currentUser,
                    token: !!window.authToken
                });
            }, 1000);
            
            // Theme system is auto-initialized by leaderboard-theme.js
            // Listen for theme changes to update display if needed
            window.addEventListener('leaderboardThemeChange', (e) => {
                console.log('Theme changed to:', e.detail.theme);
                // Re-initialize Lucide icons after theme change
                setTimeout(() => lucide.createIcons(), 100);
            });
        });
    </script>
</body>
</html>