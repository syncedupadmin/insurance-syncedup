<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Management - Super Admin</title>
    <link rel="stylesheet" href="super-admin-global.css">
    <script src="/auth-check.js" defer></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">SA</div>
                Super Admin Portal
            </a>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-avatar">SA</div>
                    <div>
                        <div style="font-weight: 600;" id="userDisplay">Super Admin</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">Platform Administrator</div>
                    </div>
                </div>
                <button class="btn" onclick="logout()">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-section">
            <div class="nav-title">Platform Overview</div>
            <a href="index.html" class="nav-link">
                <i data-lucide="layout-dashboard" class="nav-icon"></i>
                Dashboard
            </a>
            <a href="system-analytics.html" class="nav-link">
                <i data-lucide="bar-chart-3" class="nav-icon"></i>
                System Analytics
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Management</div>
            <a href="agency-management.html" class="nav-link">
                <i data-lucide="building-2" class="nav-icon"></i>
                Agency Management
            </a>
            <a href="user-administration.html" class="nav-link">
                <i data-lucide="users" class="nav-icon"></i>
                User Administration
            </a>
            <a href="revenue-management.html" class="nav-link active">
                <i data-lucide="dollar-sign" class="nav-icon"></i>
                Revenue Management
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-title">Configuration</div>
            <a href="settings.html" class="nav-link">
                <i data-lucide="settings" class="nav-icon"></i>
                Settings
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Revenue Management</h1>
                <p class="page-subtitle">Subscription billing, payment tracking, and financial reporting across all agencies</p>
            </div>

            <!-- Revenue KPIs -->
            <div class="grid grid-4">
                <div class="stat-card">
                    <div class="stat-value" id="monthlyRevenue">$0</div>
                    <div class="stat-label">Monthly Recurring Revenue</div>
                    <div class="stat-change positive">
                        <i data-lucide="trend-up" style="width: 12px; height: 12px;"></i>
                        <span id="mrrChange">Loading...</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="annualRevenue">$0</div>
                    <div class="stat-label">Annual Revenue</div>
                    <div class="stat-change positive">
                        <i data-lucide="trending-up" style="width: 12px; height: 12px;"></i>
                        <span id="arrChange">Loading...</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="churnRate">0%</div>
                    <div class="stat-label">Monthly Churn Rate</div>
                    <div class="stat-change positive">
                        <i data-lucide="trend-down" style="width: 12px; height: 12px;"></i>
                        <span id="churnChange">Loading...</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="avgLtv">$0</div>
                    <div class="stat-label">Average LTV</div>
                    <div class="stat-change positive">
                        <i data-lucide="dollar-sign" style="width: 12px; height: 12px;"></i>
                        <span id="ltvChange">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Revenue Charts -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i data-lucide="trending-up" class="card-icon"></i>
                            Revenue Trends
                        </h3>
                        <select class="form-input" style="width: auto; min-width: 120px;" id="revenueTimeframe">
                            <option value="6m">Last 6 Months</option>
                            <option value="12m" selected>Last 12 Months</option>
                            <option value="24m">Last 24 Months</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueTrendsChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i data-lucide="pie-chart" class="card-icon"></i>
                            Revenue by Plan Type
                        </h3>
                        <button class="btn" onclick="exportRevenueBreakdown()">
                            <i data-lucide="download"></i>
                            Export
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="planRevenueChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Subscription Management -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="credit-card" class="card-icon"></i>
                        Subscription Overview
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" style="width: auto; min-width: 120px;" id="subscriptionFilter">
                            <option value="all">All Subscriptions</option>
                            <option value="active">Active</option>
                            <option value="trial">Trial</option>
                            <option value="past_due">Past Due</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn" onclick="refreshSubscriptions()">
                            <i data-lucide="refresh-cw"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-3" style="margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--success);" id="activeSubscriptions">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Subscriptions</div>
                    </div>
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--warning);" id="trialSubscriptions">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Trial Subscriptions</div>
                    </div>
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--error);" id="pastDueSubscriptions">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Past Due</div>
                    </div>
                </div>

                <div id="subscriptionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading subscriptions...
                    </div>
                </div>
            </div>

            <!-- Payment Failures and Dunning -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i data-lucide="alert-circle" class="card-icon"></i>
                            Payment Failures
                        </h3>
                        <button class="btn btn-warning" onclick="retryFailedPayments()">
                            <i data-lucide="refresh-cw"></i>
                            Retry All
                        </button>
                    </div>
                    
                    <div id="paymentFailures">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading payment failures...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i data-lucide="clock" class="card-icon"></i>
                            Dunning Management
                        </h3>
                        <button class="btn" onclick="configureDunning()">
                            <i data-lucide="settings"></i>
                            Configure
                        </button>
                    </div>
                    
                    <div id="dunningStatus">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading dunning status...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Reporting -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="file-text" class="card-icon"></i>
                        Financial Reports
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" style="width: auto; min-width: 120px;" id="reportType">
                            <option value="monthly">Monthly Summary</option>
                            <option value="quarterly">Quarterly Report</option>
                            <option value="annual">Annual Report</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i data-lucide="file-plus"></i>
                            Generate Report
                        </button>
                        <button class="btn" onclick="exportFinancialData()">
                            <i data-lucide="download"></i>
                            Export
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-4" style="margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-gold);" id="totalInvoices">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Invoices</div>
                    </div>
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);" id="paidInvoices">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Paid</div>
                    </div>
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning);" id="pendingInvoices">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Pending</div>
                    </div>
                    <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--error);" id="overdueInvoices">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Overdue</div>
                    </div>
                </div>

                <div id="financialReportTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading financial report...
                    </div>
                </div>
            </div>

            <!-- Commission Tracking (if applicable) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="percent" class="card-icon"></i>
                        Commission Tracking
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="form-input" style="width: auto; min-width: 120px;" id="commissionPeriod">
                            <option value="current">Current Month</option>
                            <option value="last">Last Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                        <button class="btn" onclick="calculateCommissions()">
                            <i data-lucide="calculator"></i>
                            Calculate
                        </button>
                    </div>
                </div>
                
                <div id="commissionTracking">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading commission data...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let revenueTrendsChart, planRevenueChart;

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('syncedup_token');
            const user = await window.SyncedUpAuth?.getCurrentUser() || {};
            
            if (!token || !user.email) {
                window.location.href = '/login.html';
                return false;
            }

            if (user.role !== 'admin' && user.role !== 'super-admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '/login.html';
                return false;
            }

            document.getElementById('userDisplay').textContent = `${user.firstName} ${user.lastName}`;
            return true;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('syncedup_token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Initialize page
        async function initializePage() {
            if (!checkAuth()) return;
            
            await loadRevenueKPIs();
            await initializeCharts();
            await loadSubscriptions();
            await loadPaymentFailures();
            await loadDunningStatus();
            await loadFinancialReport();
            await loadCommissionTracking();
            
            setupEventListeners();
            lucide.createIcons();
        }

        // Load Revenue KPIs
        async function loadRevenueKPIs() {
            try {
                const response = await fetch('/api/super-admin/revenue-kpis', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateRevenueKPIs(data);
                } else {
                    updateRevenueKPIs(getFallbackKPIs());
                }
            } catch (error) {
                console.error('Error loading revenue KPIs:', error);
                updateRevenueKPIs(getFallbackKPIs());
            }
        }

        function getFallbackKPIs() {
            return {
                monthlyRevenue: 0,
                annualRevenue: 0,
                churnRate: 0,
                avgLtv: 0,
                mrrChange: 'No data',
                arrChange: 'No data',
                churnChange: 'No data',
                ltvChange: 'No data'
            };
        }

        function updateRevenueKPIs(data) {
            document.getElementById('monthlyRevenue').textContent = data.monthlyRevenue ? `$${(data.monthlyRevenue / 1000000).toFixed(1)}M` : '$0';
            document.getElementById('annualRevenue').textContent = data.annualRevenue ? `$${(data.annualRevenue / 1000000).toFixed(1)}M` : '$0';
            document.getElementById('churnRate').textContent = data.churnRate ? `${data.churnRate.toFixed(1)}%` : '0%';
            document.getElementById('avgLtv').textContent = data.avgLtv ? `$${data.avgLtv.toLocaleString()}` : '$0';
            document.getElementById('mrrChange').textContent = data.mrrChange || 'No data';
            document.getElementById('arrChange').textContent = data.arrChange || 'No data';
            document.getElementById('churnChange').textContent = data.churnChange || 'No data';
            document.getElementById('ltvChange').textContent = data.ltvChange || 'No data';
        }

        // Initialize Charts
        async function initializeCharts() {
            // Revenue Trends Chart
            const revenueCtx = document.getElementById('revenueTrendsChart').getContext('2d');
            revenueTrendsChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly Revenue',
                        data: [],
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Projected Revenue',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#cccccc' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#cccccc' },
                            grid: { color: '#444444' }
                        },
                        y: {
                            ticks: { 
                                color: '#cccccc',
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: '#444444' }
                        }
                    }
                }
            });

            // Plan Revenue Chart
            const planCtx = document.getElementById('planRevenueChart').getContext('2d');
            planRevenueChart = new Chart(planCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#ffd700',
                            '#10b981',
                            '#3b82f6',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#cccccc',
                                padding: 20
                            }
                        }
                    }
                }
            });

            await loadRevenueChartData();
        }

        // Load Chart Data
        async function loadRevenueChartData() {
            try {
                const timeframe = document.getElementById('revenueTimeframe').value;
                const response = await fetch(`/api/super-admin/revenue-chart-data?timeframe=${timeframe}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let chartData = {
                    revenueData: {
                        labels: [],
                        actual: [],
                        projected: []
                    },
                    planData: {
                        labels: [],
                        values: []
                    }
                };
                
                if (response.ok) {
                    const data = await response.json();
                    chartData = data;
                }
                
                // Update charts
                revenueTrendsChart.data.labels = chartData.revenueData.labels;
                revenueTrendsChart.data.datasets[0].data = chartData.revenueData.actual;
                revenueTrendsChart.data.datasets[1].data = chartData.revenueData.projected;
                revenueTrendsChart.update();
    
                planRevenueChart.data.labels = chartData.planData.labels;
                planRevenueChart.data.datasets[0].data = chartData.planData.values;
                planRevenueChart.update();
                
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Load Subscriptions
        async function loadSubscriptions() {
            try {
                const filter = document.getElementById('subscriptionFilter').value;
                const response = await fetch(`/api/super-admin/subscriptions?filter=${filter}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let subscriptionData = {
                    active: 0,
                    trial: 0,
                    pastDue: 0,
                    subscriptions: []
                };
                
                if (response.ok) {
                    const data = await response.json();
                    subscriptionData = data;
                }
                
                document.getElementById('activeSubscriptions').textContent = subscriptionData.active;
                document.getElementById('trialSubscriptions').textContent = subscriptionData.trial;
                document.getElementById('pastDueSubscriptions').textContent = subscriptionData.pastDue;
                
                renderSubscriptions(subscriptionData.subscriptions);
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                renderSubscriptions([]);
            }
        }

        function renderSubscriptions(subscriptions) {
            if (subscriptions.length === 0) {
                document.getElementById('subscriptionsList').innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No subscriptions found</div>';
                return;
            }
            
            const subscriptionsHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Plan</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Next Billing</th>
                                <th>Payment Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subscriptions.map(sub => `
                                <tr>
                                    <td style="font-weight: 600; color: var(--text-primary);">${sub.agency}</td>
                                    <td>${sub.plan}</td>
                                    <td><span class="status-badge status-${getSubscriptionStatusClass(sub.status)}">${sub.status}</span></td>
                                    <td style="color: var(--accent-gold); font-weight: 600;">$${sub.amount}/mo</td>
                                    <td>${sub.nextBilling}</td>
                                    <td>${sub.method}</td>
                                    <td>
                                        <div style="display: flex; gap: 0.3rem;">
                                            <button class="btn" onclick="viewSubscription('${sub.agency}')" title="View Details" style="padding: 0.4rem;">
                                                <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                            </button>
                                            <button class="btn" onclick="editSubscription('${sub.agency}')" title="Edit" style="padding: 0.4rem;">
                                                <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                                            </button>
                                            ${sub.status === 'past_due' ? `
                                                <button class="btn btn-warning" onclick="retryPayment('${sub.agency}')" title="Retry Payment" style="padding: 0.4rem;">
                                                    <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('subscriptionsList').innerHTML = subscriptionsHtml;
            lucide.createIcons();
        }

        function getSubscriptionStatusClass(status) {
            const statusMap = {
                'active': 'active',
                'trial': 'warning',
                'past_due': 'error',
                'cancelled': 'inactive'
            };
            return statusMap[status] || 'inactive';
        }

        // Load Payment Failures
        async function loadPaymentFailures() {
            try {
                const response = await fetch('/api/super-admin/payment-failures', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let failures = [];
                if (response.ok) {
                    const data = await response.json();
                    failures = data.failures || [];
                }
                
                renderPaymentFailures(failures);
            } catch (error) {
                console.error('Error loading payment failures:', error);
                renderPaymentFailures([]);
            }
        }

        function renderPaymentFailures(failures) {
            if (failures.length === 0) {
                document.getElementById('paymentFailures').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <i data-lucide="check-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                        <div>No payment failures</div>
                    </div>
                `;
                return;
            }

            const failuresHtml = failures.map(failure => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary);">${failure.agency}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${failure.reason} â€¢ ${failure.attempts} attempts</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Last: ${failure.lastAttempt}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--error);">$${failure.amount}</div>
                        <button class="btn btn-warning" onclick="retryPayment('${failure.agency}')" style="padding: 0.4rem; margin-top: 0.5rem;">
                            <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i>
                            Retry
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('paymentFailures').innerHTML = failuresHtml;
            lucide.createIcons();
        }

        // Load Dunning Status
        async function loadDunningStatus() {
            try {
                const response = await fetch('/api/super-admin/dunning-status', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let dunningData = [];
                if (response.ok) {
                    const data = await response.json();
                    dunningData = data.stages || [];
                }
                
                renderDunningStatus(dunningData);
            } catch (error) {
                console.error('Error loading dunning status:', error);
                renderDunningStatus([]);
            }
        }

        function renderDunningStatus(dunningData) {
            if (dunningData.length === 0) {
                document.getElementById('dunningStatus').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--success);"><i data-lucide="check-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><div>No agencies in dunning process</div></div>';
                lucide.createIcons();
                return;
            }
            
            const dunningHtml = dunningData.map(stage => {
                const urgencyColor = stage.agencies > 3 ? 'var(--error)' : stage.agencies > 1 ? 'var(--warning)' : 'var(--info)';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${urgencyColor};">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${stage.stage}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${stage.daysOverdue}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${urgencyColor};">${stage.agencies}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">agencies</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dunningStatus').innerHTML = dunningHtml;
        }

        // Load Financial Report
        async function loadFinancialReport() {
            try {
                const reportType = document.getElementById('reportType').value;
                const response = await fetch(`/api/super-admin/financial-report?type=${reportType}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let reportData = {
                    totalInvoices: 0,
                    paidInvoices: 0,
                    pendingInvoices: 0,
                    overdueInvoices: 0,
                    recentTransactions: []
                };
                
                if (response.ok) {
                    const data = await response.json();
                    reportData = data;
                }
                
                document.getElementById('totalInvoices').textContent = reportData.totalInvoices;
                document.getElementById('paidInvoices').textContent = reportData.paidInvoices;
                document.getElementById('pendingInvoices').textContent = reportData.pendingInvoices;
                document.getElementById('overdueInvoices').textContent = reportData.overdueInvoices;
                
                renderFinancialReport(reportData.recentTransactions);
            } catch (error) {
                console.error('Error loading financial report:', error);
                renderFinancialReport([]);
            }
        }

        function renderFinancialReport(transactions) {
            if (transactions.length === 0) {
                document.getElementById('financialReportTable').innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No financial data found</div>';
                return;
            }
            
            const reportHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Agency</th>
                                <th>Invoice</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.map(tx => `
                                <tr>
                                    <td>${tx.date}</td>
                                    <td>${tx.agency}</td>
                                    <td style="font-family: monospace;">${tx.invoice}</td>
                                    <td style="color: var(--accent-gold); font-weight: 600;">$${tx.amount}</td>
                                    <td><span class="status-badge status-${getInvoiceStatusClass(tx.status)}">${tx.status}</span></td>
                                    <td>
                                        <button class="btn" onclick="viewInvoice('${tx.invoice}')" title="View Invoice" style="padding: 0.4rem;">
                                            <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('financialReportTable').innerHTML = reportHtml;
            lucide.createIcons();
        }

        function getInvoiceStatusClass(status) {
            const statusMap = {
                'paid': 'active',
                'pending': 'warning',
                'overdue': 'error',
                'cancelled': 'inactive'
            };
            return statusMap[status] || 'inactive';
        }

        // Load Commission Tracking
        async function loadCommissionTracking() {
            try {
                const response = await fetch('/api/super-admin/commission-tracking', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}` }
                });
                
                let commissionData = {
                    totalCommissions: 0,
                    thisMonth: 0,
                    commissionRate: 0,
                    topAgencies: []
                };
                
                if (response.ok) {
                    const data = await response.json();
                    commissionData = data;
                }
                
                renderCommissionTracking(commissionData);
            } catch (error) {
                console.error('Error loading commission tracking:', error);
                renderCommissionTracking({
                    totalCommissions: 0,
                    thisMonth: 0,
                    commissionRate: 0,
                    topAgencies: []
                });
            }
        }

        function renderCommissionTracking(data) {
            const commissionHtml = `
                <div style="margin-bottom: 1.5rem;">
                    <div class="grid grid-3">
                        <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-gold);">$${data.totalCommissions.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Commissions</div>
                        </div>
                        <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">$${data.thisMonth.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">This Month</div>
                        </div>
                        <div style="background: var(--bg-elevated); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--info);">${data.commissionRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Commission Rate</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Revenue</th>
                                <th>Commission Rate</th>
                                <th>Commission Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.topAgencies && data.topAgencies.length > 0 ? data.topAgencies.map(agency => `
                                <tr>
                                    <td style="font-weight: 600; color: var(--text-primary);">${agency.agency}</td>
                                    <td style="color: var(--accent-gold);">$${agency.revenue.toLocaleString()}</td>
                                    <td>${agency.rate}%</td>
                                    <td style="color: var(--success); font-weight: 600;">$${agency.commission.toLocaleString()}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">No commission data available</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('commissionTracking').innerHTML = commissionHtml;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('revenueTimeframe').addEventListener('change', loadRevenueChartData);
            document.getElementById('subscriptionFilter').addEventListener('change', loadSubscriptions);
            document.getElementById('reportType').addEventListener('change', loadFinancialReport);
        }

        // Event Handlers
        function refreshSubscriptions() {
            loadSubscriptions();
        }

        function retryFailedPayments() {
            if (confirm('Are you sure you want to retry all failed payments?')) {
                alert('Payment retry process initiated for all failed payments.');
                setTimeout(() => {
                    loadPaymentFailures();
                    loadSubscriptions();
                }, 2000);
            }
        }

        function retryPayment(agency) {
            if (confirm(`Retry payment for ${agency}?`)) {
                alert(`Payment retry initiated for ${agency}.`);
                setTimeout(() => {
                    loadPaymentFailures();
                    loadSubscriptions();
                }, 1000);
            }
        }

        function configureDunning() {
            alert('Dunning configuration modal would be implemented here.');
        }

        function viewSubscription(agency) {
            alert(`Subscription details for ${agency} would be displayed in a modal.`);
        }

        function editSubscription(agency) {
            alert(`Edit subscription for ${agency} would be displayed in a modal.`);
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            alert(`Generating ${reportType} report...`);
        }

        function exportFinancialData() {
            alert('Financial data export functionality would be implemented here.');
        }

        function exportRevenueBreakdown() {
            alert('Revenue breakdown export functionality would be implemented here.');
        }

        function viewInvoice(invoice) {
            alert(`Invoice ${invoice} details would be displayed.`);
        }

        function calculateCommissions() {
            alert('Commission calculation process would be initiated here.');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
    
</body>
</html>