<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication - SyncedUp Insurance</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #764ba2;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Authentication Test Page</h1>

    <div class="section">
        <h2>Test Login</h2>
        <input type="email" id="email" placeholder="Email" style="width: 100%; padding: 8px; margin: 5px 0;">
        <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0;">
        <button onclick="testLogin()">Test Login</button>
        <button onclick="clearSessions()">Clear All Sessions</button>
        <div id="login-result"></div>
    </div>

    <div class="section">
        <h2>Current Session Status</h2>
        <button onclick="checkSession()">Check Session</button>
        <button onclick="checkSupabaseSession()">Check Supabase Session</button>
        <div id="session-status"></div>
    </div>

    <div class="section">
        <h2>Test Protected API</h2>
        <button onclick="testProtectedAPI()">Test Protected API Call</button>
        <div id="api-result"></div>
    </div>

    <div class="section">
        <h2>Debug Info</h2>
        <button onclick="showDebugInfo()">Show Debug Info</button>
        <pre id="debug-info"></pre>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://zgkszwkxibpnxhvlenct.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpna3N6d2t4aWJwbnhodmxlbmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTk3OTMsImV4cCI6MjA3MTg5NTc5M30.1n7a1TYOM2zWiCUfGFhQnfPb8fjvDkDa_ba3CKZEB98';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.testLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');

            resultDiv.innerHTML = '<span class="info">Testing login...</span>';

            try {
                // Test our API endpoint
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                const data = await res.json();

                if (res.ok) {
                    resultDiv.innerHTML = `<span class="success">✓ Login successful!</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Login failed (${res.status})</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Network error: ${error.message}</span>`;
            }
        };

        window.clearSessions = async () => {
            const resultDiv = document.getElementById('login-result');

            // Clear cookies
            document.cookie = 'auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';

            // Clear localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('sb-')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));

            // Sign out from Supabase
            await supabase.auth.signOut();

            resultDiv.innerHTML = '<span class="success">✓ All sessions cleared</span>';
        };

        window.checkSession = async () => {
            const statusDiv = document.getElementById('session-status');
            statusDiv.innerHTML = '<span class="info">Checking session...</span>';

            // Check for auth_token cookie
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});

            const hasAuthToken = !!cookies.auth_token;

            statusDiv.innerHTML = `
                <p>Auth Token Cookie: ${hasAuthToken ? '<span class="success">✓ Present</span>' : '<span class="error">✗ Missing</span>'}</p>
                <p>Cookie Value: ${hasAuthToken ? cookies.auth_token.substring(0, 20) + '...' : 'N/A'}</p>
            `;
        };

        window.checkSupabaseSession = async () => {
            const statusDiv = document.getElementById('session-status');
            statusDiv.innerHTML = '<span class="info">Checking Supabase session...</span>';

            const { data: { session }, error } = await supabase.auth.getSession();

            if (session) {
                statusDiv.innerHTML = `<span class="success">✓ Supabase session active</span><pre>${JSON.stringify({
                    user_id: session.user.id,
                    email: session.user.email,
                    expires_at: new Date(session.expires_at * 1000).toISOString()
                }, null, 2)}</pre>`;
            } else {
                statusDiv.innerHTML = '<span class="error">✗ No Supabase session</span>';
            }
        };

        window.testProtectedAPI = async () => {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<span class="info">Testing protected API...</span>';

            try {
                // Get current Supabase session
                const { data: { session } } = await supabase.auth.getSession();

                const headers = {};
                if (session) {
                    headers['Authorization'] = `Bearer ${session.access_token}`;
                }

                // Test a protected endpoint (adjust the endpoint as needed)
                const res = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers,
                    credentials: 'include'
                });

                if (res.ok) {
                    const data = await res.json();
                    resultDiv.innerHTML = `<span class="success">✓ API call successful</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const text = await res.text();
                    resultDiv.innerHTML = `<span class="error">✗ API call failed (${res.status})</span><pre>${text}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Network error: ${error.message}</span>`;
            }
        };

        window.showDebugInfo = async () => {
            const debugDiv = document.getElementById('debug-info');

            // Get all cookies
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key) acc[key] = value;
                return acc;
            }, {});

            // Get localStorage items
            const localStorageItems = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('sb-')) {
                    localStorageItems[key] = localStorage.getItem(key).substring(0, 50) + '...';
                }
            }

            // Get Supabase session
            const { data: { session } } = await supabase.auth.getSession();

            debugDiv.textContent = JSON.stringify({
                cookies,
                localStorage: localStorageItems,
                supabaseSession: session ? {
                    user_id: session.user.id,
                    email: session.user.email,
                    expires_at: new Date(session.expires_at * 1000).toISOString()
                } : null,
                currentUrl: window.location.href,
                timestamp: new Date().toISOString()
            }, null, 2);
        };

        // Check session on load
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });
    </script>
</body>
</html>