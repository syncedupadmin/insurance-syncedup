<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Critical Theme Flash Prevention -->
    <script>
    (function(){
        var t=localStorage.getItem("adminTheme")||"professional";
        var h=document.documentElement;
        h.classList.add(t+"-mode");
        
        // Load theme CSS immediately
        var existingTheme = document.querySelector('link[data-theme-css]');
        if(existingTheme) existingTheme.remove();
        
        if(t==="modern"){
            // Load modern base styles (structure only)
            var baseLink = document.createElement('link');
            baseLink.rel = 'stylesheet';
            baseLink.href = '/css/themes/modern-base.css';
            baseLink.setAttribute('data-theme-css', 'modern-base');
            document.head.appendChild(baseLink);
            // Admin portal purple colors are in admin-global.css
        } else {
            // Load traditional theme CSS
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/css/themes/' + t + '.css';
            link.setAttribute('data-theme-css', t);
            document.head.appendChild(link);
        }
        
        // Add body class when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if(document.body) {
                document.body.classList.add('portal-admin');
                document.body.classList.add(t+"-mode");
            }
        });
        
        // Set background for immediate visual feedback (purple colors for admin)
        if(t==="classic"){h.style.background="linear-gradient(-45deg,#6b46c1,#7c3aed,#8b5cf6,#a78bfa)";}
        else if(t==="modern"){h.style.background="linear-gradient(135deg,#667eea 0%,#764ba2 100%)";}
        else if(t==="professional"){h.style.background="linear-gradient(-45deg,#4c1d95,#5b21b6,#6d28d9,#7c3aed)";}
        else{h.style.background="linear-gradient(-45deg,#4c1d95,#5b21b6,#6d28d9,#7c3aed)";}
        
        h.style.visibility="hidden";
        setTimeout(function(){h.style.visibility="visible";h.style.transition="opacity 0.2s";h.style.opacity="1";},50);
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - SyncedUp Insurance Admin</title>
    <link rel="stylesheet" href="/admin/admin-global.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/admin/components/navigation.js"></script>
    <script src="/admin/components/global-header.js"></script>
    <script src="/js/auth-check.js?v=3" defer></script>
    <link rel="stylesheet" href="/css/hide-theme-switchers.css">
</head>
<body>
    <!-- Global Header Mount Point -->
    <div id="global-header-mount"></div>

    <div class="container">
        <!-- User Statistics -->
        <div class="grid">
            <div class="card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="card">
                <div class="stat-value" id="activeAgents">0</div>
                <div class="stat-label">Active Agents</div>
            </div>
            <div class="card">
                <div class="stat-value" id="totalManagers">0</div>
                <div class="stat-label">Managers</div>
            </div>
            <div class="card">
                <div class="stat-value" id="pendingUsers">0</div>
                <div class="stat-label">Pending Activation</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i data-lucide="user-plus" class="icon"></i>Add New User
            </button>
            <button class="btn btn-success" onclick="showBulkActionsModal()">
                <i data-lucide="users" class="icon"></i>Bulk Actions
            </button>
            <button class="btn" onclick="exportUsersData()">
                <i data-lucide="download" class="icon"></i>Export Users
            </button>
            <button class="btn" onclick="refreshUsersList()">
                <i data-lucide="refresh-cw" class="icon"></i>Refresh
            </button>
        </div>

        <!-- Filters and Search -->
        <div class="card">
            <h3><i data-lucide="filter" class="card-icon"></i>Filters & Search</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label class="form-label">Search Users</label>
                    <input type="text" class="form-input" id="searchUsers" placeholder="Search by name, email, or ID..." onkeyup="filterUsers()">
                </div>
                <div>
                    <label class="form-label">Role Filter</label>
                    <select class="form-select" id="roleFilter" onchange="filterUsers()">
                        <option value="all">All Roles</option>
                        <option value="agent">Agents</option>
                        <option value="manager">Managers</option>
                        <option value="customer_service">Customer Service</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Status Filter</label>
                    <select class="form-select" id="statusFilter" onchange="filterUsers()">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Team Filter</label>
                    <select class="form-select" id="teamFilter" onchange="filterUsers()">
                        <option value="all">All Teams</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <h3><i data-lucide="users" class="card-icon"></i>Users Directory</h3>
            <div style="overflow-x: auto;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="selectAllUsers()">
                            </th>
                            <th>User</th>
                            <th>Role</th>
                            <th>Team</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Performance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8" class="text-center loading">
                            <div class="spinner"></div>Loading users...
                        </td></tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 1rem; display: flex; justify-content: between; align-items: center;">
                <div id="tableInfo" style="color: rgba(255,255,255,0.7); font-size: 0.9rem;"></div>
                <div id="pagination" style="display: flex; gap: 0.5rem; margin-left: auto;"></div>
            </div>
        </div>

        <!-- Team Assignment Interface -->
        <div class="card">
            <h3><i data-lucide="git-branch" class="card-icon"></i>Team Management</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <h4 style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">Sales Team Alpha</h4>
                    <div id="teamAlpha" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; min-height: 100px;">
                        <div class="loading"><div class="spinner"></div>Loading team...</div>
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">Sales Team Beta</h4>
                    <div id="teamBeta" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; min-height: 100px;">
                        <div class="loading"><div class="spinner"></div>Loading team...</div>
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">Management</h4>
                    <div id="teamManagement" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; min-height: 100px;">
                        <div class="loading"><div class="spinner"></div>Loading team...</div>
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom: 1rem; color: rgba(255,255,255,0.9);">Unassigned</h4>
                    <div id="teamUnassigned" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; min-height: 100px;">
                        <div class="loading"><div class="spinner"></div>Loading unassigned...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content card" style="max-width: 600px; margin: 5% auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 0;" id="userModalTitle">Create New User</h3>
                <button class="btn" onclick="closeUserModal()" style="padding: 0.5rem;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="userForm" onsubmit="submitUser(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-input" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-input" id="lastName" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" id="email" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-select" id="role" required onchange="handleRoleChange()">
                            <option value="">Select Role...</option>
                            <option value="agent">Agent</option>
                            <option value="manager">Manager</option>
                            <option value="customer_service">Customer Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team</label>
                        <select class="form-select" id="team">
                            <option value="">No Team</option>
                            <option value="alpha">Sales Team Alpha</option>
                            <option value="beta">Sales Team Beta</option>
                            <option value="management">Management</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="licenseGroup" style="display: none;">
                    <label class="form-label">License Information</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" class="form-input" id="licenseNumber" placeholder="License Number">
                        <input type="date" class="form-input" id="licenseExpiry" placeholder="Expiry Date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="notes" placeholder="Additional notes or comments..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitUserBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkModal" class="modal hidden">
        <div class="modal-content card" style="max-width: 500px; margin: 10% auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 0;">Bulk Actions</h3>
                <button class="btn" onclick="closeBulkModal()" style="padding: 0.5rem;">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div id="selectedUsersInfo" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <span id="selectedCount">0</span> users selected
            </div>
            
            <div style="display: grid; gap: 1rem;">
                <button class="btn btn-success" onclick="bulkActivateUsers()">
                    <i data-lucide="user-check" class="icon"></i>Activate Selected
                </button>
                <button class="btn btn-warning" onclick="bulkDeactivateUsers()">
                    <i data-lucide="user-x" class="icon"></i>Deactivate Selected
                </button>
                <button class="btn" onclick="bulkAssignTeam()">
                    <i data-lucide="git-branch" class="icon"></i>Assign to Team
                </button>
                <button class="btn btn-danger" onclick="bulkDeleteUsers()">
                    <i data-lucide="trash" class="icon"></i>Delete Selected
                </button>
            </div>
        </div>
    </div>

    <script>
        let usersData = [];
        let filteredUsers = [];
        let selectedUsers = [];
        let currentUser = null;
        let editingUserId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global header
            AdminHeader.init({
                pageTitle: 'User Management'
            });
            
            // Server-side portal-guard already verified access
            initializePage();
        });

        async function initializePage() {
            // Initialize Lucide icons with delay to allow navigation to load
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                    console.log('Lucide icons initialized successfully');
                } else {
                    console.warn('Lucide library not loaded');
                }
            }, 200);
            
            // Load all data
            await Promise.all([
                loadUsersData(),
                loadTeamsData()
            ]);
            
            updateUI();
            
            // Re-initialize icons after content loads
            setTimeout(initializeIcons, 2000);
        }

        async function loadUsersData() {
            try {
                // Use cookie-based authentication
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const users = response.ok ? (await response.json()).data || [] : [];
                usersData = users.length > 0 ? users.map(user => ({
                    user_id: user.id,
                    first_name: user.name ? user.name.split(' ')[0] : 'Unknown',
                    last_name: user.name ? user.name.split(' ').slice(1).join(' ') : '',
                    email: user.email,
                    role: user.role,
                    team: user.team || '',
                    status: user.status || 'active',
                    phone: user.phone || '',
                    notes: user.notes || '',
                    created_at: user.createdAt || new Date().toISOString(),
                    last_login: user.lastLogin || 'Never'
                })) : [];
                
                
                filteredUsers = [...usersData];
            } catch (error) {
                console.error('Error loading users data:', error);
                usersData = [];
                filteredUsers = [];
            }
        }

        async function loadTeamsData() {
            // Populate team filter dropdown
            const teamFilter = document.getElementById('teamFilter');
            const teamOptions = ['alpha', 'beta', 'management'];
            
            teamOptions.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team.charAt(0).toUpperCase() + team.slice(1) + ' Team';
                teamFilter.appendChild(option);
            });
        }

        function updateUI() {
            updateStatistics();
            updateUsersTable();
            updateTeamBoards();
        }

        function updateStatistics() {
            const totalUsers = usersData.length;
            const activeAgents = usersData.filter(u => u.role === 'agent' && u.status === 'active').length;
            const totalManagers = usersData.filter(u => u.role === 'manager').length;
            const pendingUsers = usersData.filter(u => u.status === 'pending').length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeAgents').textContent = activeAgents;
            document.getElementById('totalManagers').textContent = totalManagers;
            document.getElementById('pendingUsers').textContent = pendingUsers;
        }

        function updateUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';

            if (filteredUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
                return;
            }

            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                const performance = user.role === 'agent' ? (user.performance_score || 0) + '%' : 'N/A';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="user-checkbox" value="${user.user_id}" onchange="handleUserSelection()">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${user.first_name.charAt(0)}${user.last_name.charAt(0)}
                            </div>
                            <div>
                                <div style="font-weight: bold;">${user.first_name} ${user.last_name}</div>
                                <div style="font-size: 0.8rem; opacity: 0.7;">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-${user.role}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; background: rgba(124, 58, 237, 0.8); color: white;">
                            ${user.role.replace('_', ' ').toUpperCase()}
                        </span>
                    </td>
                    <td>${user.team || 'Unassigned'}</td>
                    <td>
                        <span class="status-${user.status}">
                            ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                        </span>
                    </td>
                    <td>${lastLogin}</td>
                    <td>${performance}</td>
                    <td>
                        <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editUser('${user.user_id}')">
                            <i data-lucide="edit" style="width: 14px; height: 14px; margin-right: 4px;"></i>Edit
                        </button>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="deleteUser('${user.user_id}', '${user.first_name} ${user.last_name}')">
                            <i data-lucide="trash" style="width: 14px; height: 14px; margin-right: 4px;"></i>Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update table info
            document.getElementById('tableInfo').textContent = `Showing ${filteredUsers.length} of ${usersData.length} users`;
            
            // Re-initialize icons for new content
            lucide.createIcons();
        }

        function updateTeamBoards() {
            const teams = {
                alpha: usersData.filter(u => u.team === 'alpha'),
                beta: usersData.filter(u => u.team === 'beta'),
                management: usersData.filter(u => u.team === 'management'),
                unassigned: usersData.filter(u => !u.team || u.team === '')
            };

            Object.keys(teams).forEach(teamKey => {
                const container = document.getElementById(`team${teamKey.charAt(0).toUpperCase() + teamKey.slice(1)}`);
                if (!container) return;

                if (teams[teamKey].length === 0) {
                    container.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">No users assigned</p>';
                    return;
                }

                let html = '';
                teams[teamKey].forEach(user => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="width: 24px; height: 24px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                ${user.first_name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; font-weight: 500;">${user.first_name} ${user.last_name}</div>
                                <div style="font-size: 0.7rem; opacity: 0.7;">${user.role}</div>
                            </div>
                            <span class="status-${user.status}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">
                                ${user.status}
                            </span>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        // Filter and Search Functions
        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;

            filteredUsers = usersData.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.first_name.toLowerCase().includes(searchTerm) ||
                    user.last_name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.user_id.toLowerCase().includes(searchTerm);

                const matchesRole = roleFilter === 'all' || user.role === roleFilter;
                const matchesStatus = statusFilter === 'all' || user.status === statusFilter;
                const matchesTeam = teamFilter === 'all' || user.team === teamFilter;

                return matchesSearch && matchesRole && matchesStatus && matchesTeam;
            });

            updateUsersTable();
        }

        // User Selection Functions
        function selectAllUsers() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            handleUserSelection();
        }

        function handleUserSelection() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            selectedUsers = Array.from(checkboxes).map(cb => cb.value);
            
            // Update select all checkbox state
            const selectAll = document.getElementById('selectAll');
            const allCheckboxes = document.querySelectorAll('.user-checkbox');
            selectAll.indeterminate = selectedUsers.length > 0 && selectedUsers.length < allCheckboxes.length;
            selectAll.checked = selectedUsers.length === allCheckboxes.length && allCheckboxes.length > 0;
        }

        // Modal Functions
        function showCreateUserModal() {
            document.getElementById('userModalTitle').textContent = 'Create New User';
            document.getElementById('submitUserBtn').textContent = 'Create User';
            document.getElementById('userForm').reset();
            editingUserId = null;
            document.getElementById('userModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function editUser(userId) {
            const user = usersData.find(u => u.user_id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('submitUserBtn').textContent = 'Update User';
            
            // Populate form with user data
            document.getElementById('firstName').value = user.first_name;
            document.getElementById('lastName').value = user.last_name;
            document.getElementById('email').value = user.email;
            document.getElementById('role').value = user.role;
            document.getElementById('team').value = user.team || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('status').value = user.status;
            document.getElementById('licenseNumber').value = user.license_number || '';
            document.getElementById('licenseExpiry').value = user.license_expiry || '';
            document.getElementById('notes').value = user.notes || '';
            
            editingUserId = userId;
            handleRoleChange();
            
            document.getElementById('userModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('userForm').reset();
            editingUserId = null;
        }

        function handleRoleChange() {
            const role = document.getElementById('role').value;
            const licenseGroup = document.getElementById('licenseGroup');
            
            if (role === 'agent') {
                licenseGroup.style.display = 'block';
            } else {
                licenseGroup.style.display = 'none';
            }
        }

        async function submitUser(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const role = document.getElementById('role').value;
            const team = document.getElementById('team').value;
            const status = document.getElementById('status').value;
            
            if (!firstName || !lastName || !email || !role) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const currentUser = JSON.parse(sessionStorage.getItem('syncedup:user') || '{}');
                const userData = {
                    id: editingUserId || `u-${Date.now()}`,
                    name: `${firstName} ${lastName}`,
                    email,
                    role,
                    team: team || null,
                    phone: document.getElementById('phone').value || null,
                    status: status,
                    agencyId: currentUser.agencyId,
                    isDemoAccount: currentUser.isDemoAccount || false,
                    notes: document.getElementById('notes').value || null,
                    createdAt: new Date().toISOString()
                };

                let response;
                if (editingUserId) {
                    // Use cookie-based authentication
                    response = await fetch(`/api/admin/users/${editingUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // Use cookie-based authentication
                    response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                }

                if (response.ok) {
                    alert(editingUserId ? 'User updated successfully!' : 'User created successfully!');
                    closeUserModal();
                    await loadUsersData();
                    updateUI();
                } else {
                    alert('Failed to save user');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Failed to save user. Please try again.');
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                // Use cookie-based authentication
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showSuccessMessage('User deleted successfully!');
                    await loadUsersData();
                    updateUI();
                } else {
                    throw new Error('Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showErrorMessage('Failed to delete user. Please try again.');
            }
        }

        // Bulk Actions
        function showBulkActionsModal() {
            if (selectedUsers.length === 0) {
                showErrorMessage('Please select users first.');
                return;
            }
            
            document.getElementById('selectedCount').textContent = selectedUsers.length;
            document.getElementById('bulkModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeBulkModal() {
            document.getElementById('bulkModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function bulkActivateUsers() {
            if (selectedUsers.length === 0) return;
            
            try {
                // Use cookie-based authentication
                const response = await fetch('/api/admin/users/bulk', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        user_ids: selectedUsers,
                        action: 'activate'
                    })
                });

                if (response.ok) {
                    showSuccessMessage(`${selectedUsers.length} users activated successfully!`);
                    closeBulkModal();
                    await loadUsersData();
                    updateUI();
                } else {
                    throw new Error('Failed to activate users');
                }
            } catch (error) {
                console.error('Error activating users:', error);
                showErrorMessage('Failed to activate users. Please try again.');
            }
        }

        async function bulkDeactivateUsers() {
            if (selectedUsers.length === 0) return;
            
            try {
                // Use cookie-based authentication
                const response = await fetch('/api/admin/users/bulk', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        user_ids: selectedUsers,
                        action: 'deactivate'
                    })
                });

                if (response.ok) {
                    showSuccessMessage(`${selectedUsers.length} users deactivated successfully!`);
                    closeBulkModal();
                    await loadUsersData();
                    updateUI();
                } else {
                    throw new Error('Failed to deactivate users');
                }
            } catch (error) {
                console.error('Error deactivating users:', error);
                showErrorMessage('Failed to deactivate users. Please try again.');
            }
        }

        // Export Functions
        async function exportUsersData() {
            try {
                const csvContent = generateUsersCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showSuccessMessage('Users data exported successfully!');
            } catch (error) {
                console.error('Error exporting users:', error);
                showErrorMessage('Failed to export users data.');
            }
        }

        function generateUsersCSV() {
            let csv = 'User ID,First Name,Last Name,Email,Role,Team,Status,Phone,License Number,License Expiry,Last Login,Notes\n';
            
            usersData.forEach(user => {
                const row = [
                    user.user_id,
                    user.first_name,
                    user.last_name,
                    user.email,
                    user.role,
                    user.team || '',
                    user.status,
                    user.phone || '',
                    user.license_number || '',
                    user.license_expiry || '',
                    user.last_login || '',
                    (user.notes || '').replace(/"/g, '""')
                ].map(field => `"${field}"`).join(',');
                
                csv += row + '\n';
            });
            
            return csv;
        }

        // Refresh Function
        async function refreshUsersList() {
            document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" class="text-center loading"><div class="spinner"></div>Refreshing users...</td></tr>';
            
            await loadUsersData();
            updateUI();
            showSuccessMessage('Users list refreshed!');
        }


        // Utility Functions
        function showSuccessMessage(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '1000';
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        function showErrorMessage(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '1000';
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        // Logout function now handled by AdminHeader.logout()
        // function logout() {
        //     clearAuthCookies();
        //     window.location.href = '/login';
        // }

        // Modal styling
        const modalStyles = `
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                animation: modalAppear 0.3s ease;
            }
            @keyframes modalAppear {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = modalStyles;
        document.head.appendChild(styleSheet);
    </script>
    
    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
</body>
</html>