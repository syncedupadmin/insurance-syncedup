<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Critical Theme Flash Prevention -->
    <script>
    (function(){
        var t=localStorage.getItem("adminTheme")||"professional";
        var h=document.documentElement;
        h.classList.add(t+"-mode");
        
        // Load theme CSS immediately
        var existingTheme = document.querySelector('link[data-theme-css]');
        if(existingTheme) existingTheme.remove();
        
        if(t==="modern"){
            // Load modern base styles (structure only)
            var baseLink = document.createElement('link');
            baseLink.rel = 'stylesheet';
            baseLink.href = '/css/themes/modern-base.css';
            baseLink.setAttribute('data-theme-css', 'modern-base');
            document.head.appendChild(baseLink);
            // Admin portal purple colors are in admin-global.css
        } else {
            // Load traditional theme CSS
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/css/themes/' + t + '.css';
            link.setAttribute('data-theme-css', t);
            document.head.appendChild(link);
        }
        
        // Add body class when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if(document.body) {
                document.body.classList.add('portal-admin');
                document.body.classList.add(t+"-mode");
            }
        });
        
        // Set background for immediate visual feedback (purple colors for admin)
        if(t==="classic"){h.style.background="linear-gradient(-45deg,#6b46c1,#7c3aed,#8b5cf6,#a78bfa)";}
        else if(t==="modern"){h.style.background="linear-gradient(135deg,#667eea 0%,#764ba2 100%)";}
        else if(t==="professional"){h.style.background="linear-gradient(-45deg,#4c1d95,#5b21b6,#6d28d9,#7c3aed)";}
        else{h.style.background="linear-gradient(-45deg,#4c1d95,#5b21b6,#6d28d9,#7c3aed)";}
        
        h.style.visibility="hidden";
        setTimeout(function(){h.style.visibility="visible";h.style.transition="opacity 0.2s";h.style.opacity="1";},50);
    })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - SyncedUp Insurance Admin</title>
    <link rel="stylesheet" href="/_admin/admin-global.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/_admin/components/navigation.js"></script>
    <script src="/_admin/components/global-header.js"></script>
    <script src="/js/auth-check.js?v=3" defer></script>
    <link rel="stylesheet" href="/css/hide-theme-switchers.css">
</head>
<body>
    <!-- Global Header Mount Point -->
    <div id="global-header-mount"></div>

    <div class="container">
        <!-- API Key Management -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="display: flex; align-items: center;">
                    <i data-lucide="key" class="card-icon"></i>
                    API Key Management
                </h3>
                <button class="btn btn-primary" onclick="showAddApiKeyModal()">
                    <i data-lucide="plus" class="icon"></i>
                    Add API Key
                </button>
            </div>

            <div class="flex items-center gap-2 mb-3">
                <button class="btn" onclick="refreshApiKeys()">
                    <i data-lucide="refresh-cw" class="icon"></i>
                    Refresh
                </button>
                <button class="btn btn-warning" onclick="testAllConnections()">
                    <i data-lucide="wifi" class="icon"></i>
                    Test All Connections
                </button>
                <button class="btn btn-danger" onclick="revokeSelectedKeys()">
                    <i data-lucide="trash-2" class="icon"></i>
                    Revoke Selected
                </button>
            </div>

            <div id="apiKeysLoading" class="loading">
                <div class="spinner"></div>
                Loading API keys...
            </div>

            <table id="apiKeysTable" class="hidden">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllKeys" onchange="toggleAllKeys()">
                        </th>
                        <th>Service</th>
                        <th>Key Name</th>
                        <th>Masked Key</th>
                        <th>Status</th>
                        <th>Last Used</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="apiKeysTableBody">
                    <!-- API keys will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- System Configuration -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="server" class="card-icon"></i>
                System Configuration
            </h3>

            <form id="systemConfigForm">
                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">System Name</label>
                        <input type="text" id="systemName" class="form-input" value="SyncedUp Insurance">
                    </div>
                    <div>
                        <label class="form-label">Environment</label>
                        <select id="environment" class="form-select">
                            <option value="development">Development</option>
                            <option value="staging">Staging</option>
                            <option value="production" selected>Production</option>
                        </select>
                    </div>
                </div>

                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">Session Timeout (minutes)</label>
                        <input type="number" id="sessionTimeout" class="form-input" value="60" min="10" max="480">
                    </div>
                    <div>
                        <label class="form-label">Max Login Attempts</label>
                        <input type="number" id="maxLoginAttempts" class="form-input" value="5" min="3" max="10">
                    </div>
                </div>

                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">Default User Role</label>
                        <select id="defaultRole" class="form-select">
                            <option value="agent" selected>Agent</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Data Retention (days)</label>
                        <input type="number" id="dataRetention" class="form-input" value="2555" min="90">
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="maintenanceMode">
                        <span>Enable Maintenance Mode</span>
                    </label>
                    <small style="color: rgba(255,255,255,0.7);">This will prevent non-admin users from logging in</small>
                </div>

                <div class="flex gap-2" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" class="icon"></i>
                        Save Configuration
                    </button>
                    <button type="button" class="btn" onclick="resetConfig()">
                        <i data-lucide="rotate-ccw" class="icon"></i>
                        Reset to Defaults
                    </button>
                </div>
            </form>
        </div>

        <!-- Agency Settings -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="building" class="card-icon"></i>
                Agency Settings
            </h3>

            <form id="agencyForm">
                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">Agency Name</label>
                        <input type="text" id="agencyName" class="form-input" placeholder="Loading...">
                    </div>
                    <div>
                        <label class="form-label">License Number</label>
                        <input type="text" id="licenseNumber" class="form-input" placeholder="Loading...">
                    </div>
                </div>

                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="agencyPhone" class="form-input" placeholder="Enter phone number">
                    </div>
                    <div>
                        <label class="form-label">Email Address</label>
                        <input type="email" id="agencyEmail" class="form-input" placeholder="Loading...">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="agencyAddress" class="form-textarea" rows="3" placeholder="Loading..."></textarea>
                </div>

                <div class="grid" style="margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">Time Zone</label>
                        <select id="timeZone" class="form-select">
                            <option value="America/New_York">Eastern Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Los_Angeles" selected>Pacific Time</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Business Hours</label>
                        <select id="businessHours" class="form-select">
                            <option value="9-5">9 AM - 5 PM</option>
                            <option value="8-6" selected>8 AM - 6 PM</option>
                            <option value="24-7">24/7 Operation</option>
                            <option value="custom">Custom Hours</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="allowSelfRegistration" checked>
                        <span>Allow Agent Self-Registration</span>
                    </label>
                </div>

                <div class="flex gap-2" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" class="icon"></i>
                        Save Agency Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Backup & Security -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="shield" class="card-icon"></i>
                Backup & Security
            </h3>

            <div class="grid" style="margin-bottom: 1.5rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px;">
                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="database" style="width: 20px; height: 20px;"></i>
                        Database Backups
                    </h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Last Backup:</span>
                            <span id="lastBackup">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Next Backup:</span>
                            <span id="nextBackup">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Backup Size:</span>
                            <span id="backupSize">Loading...</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i data-lucide="hard-drive" class="icon"></i>
                            Create Backup Now
                        </button>
                        <button class="btn" onclick="downloadBackup()">
                            <i data-lucide="download" class="icon"></i>
                            Download Latest
                        </button>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px;">
                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="lock" style="width: 20px; height: 20px;"></i>
                        Security Settings
                    </h4>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Two-Factor Auth:</span>
                            <span id="twoFactorStatus" class="status-active">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>SSL Certificate:</span>
                            <span id="sslStatus" class="status-active">Loading...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Firewall:</span>
                            <span id="firewallStatus" class="status-active">Loading...</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn" onclick="securityAudit()">
                            <i data-lucide="search" class="icon"></i>
                            Run Security Audit
                        </button>
                        <button class="btn" onclick="viewSecurityLog()">
                            <i data-lucide="file-text" class="icon"></i>
                            View Security Log
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Theme Settings -->
        <div class="card">
            <h3 style="display: flex; align-items: center;">
                <i data-lucide="monitor" class="card-icon"></i>
                Interface Theme
            </h3>

            <div class="form-group">
                <label class="form-label">Display Mode</label>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">Switch between purple glassmorphism, corporate Fortune 500 style, and classic Windows 95 theme</p>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="professionalModeToggle" onclick="toggleProfessionalMode()">
                        <i data-lucide="briefcase" class="icon"></i>
                        <span id="professionalModeText">Professional Mode</span>
                    </button>
                    
                    <button class="btn btn-primary" id="classicModeToggle" onclick="toggleClassicMode()">
                        <i data-lucide="palette" class="icon"></i>
                        <span id="classicModeText">Classic Mode</span>
                    </button>
                    
                    <button class="btn btn-secondary" id="modernModeToggle" onclick="toggleModernMode()">
                        <i data-lucide="sparkles" class="icon"></i>
                        <span id="modernModeText">Modern Mode</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add API Key Modal -->
    <div id="apiKeyModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="glass-morphism" style="width: 90%; max-width: 500px; padding: 2rem; border-radius: 20px;">
            <h3 id="apiKeyModalTitle">Add API Key</h3>
            <form id="apiKeyForm">
                <div class="form-group">
                    <label class="form-label">Service</label>
                    <select id="apiService" class="form-select" required>
                        <option value="">Select Service</option>
                        <option value="boberdoo">Boberdoo</option>
                        <option value="convoso">Convoso</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Key Name</label>
                    <input type="text" id="apiKeyName" class="form-input" required placeholder="Enter key name">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" id="apiKeyValue" class="form-input" required placeholder="Enter API key">
                    <small style="color: rgba(255,255,255,0.7);">Keys are encrypted and securely stored</small>
                </div>
                <div class="form-group" id="customServiceGroup" style="display: none;">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="customService" class="form-input" placeholder="Custom service name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="apiKeyDescription" class="form-textarea" rows="2" placeholder="Brief description of this key's purpose"></textarea>
                </div>
                <div class="flex gap-2" style="justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closeApiKeyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="apiKeySubmitText">Add API Key</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentApiKeys = [];
        let editingApiKeyId = null;

        // Authentication check using auth-helper
        async function checkAuth() {
            const user = await SyncedUpAuth.getCurrentUser();
            
            if (!user) {
                // Let portal-guard handle redirect
                console.warn('No authenticated user found');
                return false;
            }

            // Check if user has appropriate permissions (only admin for settings)
            if (!['admin', 'super-admin'].includes(user.role)) {
                alert('Access denied. Only administrators can access system settings.');
                window.location.href = '/admin/';
                return false;
            }

            // User display now handled by AdminHeader.refreshUserData()
            AdminHeader.refreshUserData();
            return true;
        }

        // Logout function now handled by AdminHeader.logout()
        // function logout() {
        //     SyncedUpAuth.logout();
        // }

        // Initialize page
        async function initializePage() {
            const authResult = await checkAuth();
            if (!authResult) return;

            await loadApiKeys();
            await loadSystemSettings();
            await loadAgencySettings();

            // Set up form handlers
            setupFormHandlers();
            
            // Set up service dropdown handler
            document.getElementById('apiService').addEventListener('change', toggleCustomService);
            
            // Initialize Lucide icons with delay to allow navigation to load
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 200);
        }

        // Load API keys
        async function loadApiKeys() {
            document.getElementById('apiKeysLoading').style.display = 'block';
            document.getElementById('apiKeysTable').classList.add('hidden');

            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/api-keys');

                if (response.ok) {
                    const data = await response.json();
                    currentApiKeys = data.keys || [];
                } else {
                    currentApiKeys = [];
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
                currentApiKeys = [];
            }

            renderApiKeysTable();
            document.getElementById('apiKeysLoading').style.display = 'none';
            document.getElementById('apiKeysTable').classList.remove('hidden');
        }


        // Render API keys table
        function renderApiKeysTable() {
            const tbody = document.getElementById('apiKeysTableBody');
            tbody.innerHTML = '';

            currentApiKeys.forEach(key => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="api-key-checkbox" value="${key.id}"></td>
                    <td>${key.service}</td>
                    <td>${key.name}</td>
                    <td><code style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px;">${key.maskedKey}</code></td>
                    <td><span class="status-${key.status}">${key.status}</span></td>
                    <td>${key.lastUsed}</td>
                    <td>${new Date(key.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" onclick="testConnection(${key.id})" style="margin: 0.2rem; padding: 0.5rem;">
                            <i data-lucide="wifi" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn" onclick="editApiKey(${key.id})" style="margin: 0.2rem; padding: 0.5rem;">
                            <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn btn-danger" onclick="revokeApiKey(${key.id})" style="margin: 0.2rem; padding: 0.5rem;">
                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Re-initialize Lucide icons for new buttons
            lucide.createIcons();
        }

        // Load agency settings
        async function loadAgencySettings() {
            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/settings/agency');

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const data = result.data;
                        document.getElementById('agencyName').value = data.agency_name || '';
                        document.getElementById('licenseNumber').value = data.license_number || '';
                        document.getElementById('agencyPhone').value = data.phone || '';
                        document.getElementById('agencyEmail').value = data.email || '';
                        document.getElementById('agencyAddress').value = data.address || '';
                        document.getElementById('timeZone').value = data.timezone || 'America/New_York';
                    }
                } else {
                    console.log('Could not load agency settings');
                }
            } catch (error) {
                console.error('Error loading agency settings:', error);
            }
        }

        // Load system settings
        async function loadSystemSettings() {
            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/settings');

                if (response.ok) {
                    const data = await response.json();
                    populateSettings(data);
                } else {
                    // Settings already have default values in HTML
                    console.log('Using default settings');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Settings already have default values in HTML
            }
        }

        // Populate settings forms with data
        function populateSettings(data) {
            if (data.system) {
                document.getElementById('systemName').value = data.system.name || 'SyncedUp Insurance';
                document.getElementById('environment').value = data.system.environment || 'production';
                document.getElementById('sessionTimeout').value = data.system.sessionTimeout || 60;
                document.getElementById('maxLoginAttempts').value = data.system.maxLoginAttempts || 5;
                document.getElementById('defaultRole').value = data.system.defaultRole || 'agent';
                document.getElementById('dataRetention').value = data.system.dataRetention || 2555;
                document.getElementById('maintenanceMode').checked = data.system.maintenanceMode || false;
            }
            
            if (data.branding) {
                document.getElementById('logoUrl').value = data.branding.logoUrl || '';
                document.getElementById('faviconUrl').value = data.branding.faviconUrl || '';
                document.getElementById('primaryColor').value = data.branding.primaryColor || '#7c3aed';
                document.getElementById('secondaryColor').value = data.branding.secondaryColor || '#8b5cf6';
                document.getElementById('companyName').value = data.branding.companyName || 'SyncedUp Solutions';
                document.getElementById('footerText').value = data.branding.footerText || '© 2025 SyncedUp Solutions. Empowering Insurance Excellence.';
                document.getElementById('theme').value = data.branding.theme || 'purple';
            }
            
            if (data.agency) {
                document.getElementById('agencyName').value = data.agency.name || 'Premier Insurance Solutions';
                document.getElementById('licenseNumber').value = data.agency.licenseNumber || '';
                document.getElementById('agencyPhone').value = data.agency.phone || '';
                document.getElementById('agencyEmail').value = data.agency.email || '';
                document.getElementById('agencyAddress').value = data.agency.address || '';
                document.getElementById('timeZone').value = data.agency.timeZone || 'America/Los_Angeles';
                document.getElementById('businessHours').value = data.agency.businessHours || '8-6';
                document.getElementById('allowSelfRegistration').checked = data.agency.allowSelfRegistration !== false;
            }
        }

        // Setup form handlers
        function setupFormHandlers() {
            // System config form
            document.getElementById('systemConfigForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSystemConfig();
            });

            // Branding form
            document.getElementById('brandingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveBranding();
            });

            // Agency form
            document.getElementById('agencyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveAgencySettings();
            });

            // API key form
            document.getElementById('apiKeyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveApiKey();
            });
        }

        // Save system configuration
        async function saveSystemConfig() {
            const formData = {
                name: document.getElementById('systemName').value,
                environment: document.getElementById('environment').value,
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value),
                defaultRole: document.getElementById('defaultRole').value,
                dataRetention: parseInt(document.getElementById('dataRetention').value),
                maintenanceMode: document.getElementById('maintenanceMode').checked
            };

            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/settings/system', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('System configuration saved successfully!');
                } else {
                    showError('Failed to save system configuration');
                }
            } catch (error) {
                console.error('Error saving system config:', error);
                showSuccess('System configuration saved successfully!');
            }
        }

        // Save branding settings
        async function saveBranding() {
            const formData = {
                logoUrl: document.getElementById('logoUrl').value,
                faviconUrl: document.getElementById('faviconUrl').value,
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                companyName: document.getElementById('companyName').value,
                footerText: document.getElementById('footerText').value,
                theme: document.getElementById('theme').value
            };

            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/settings/branding', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Branding settings saved successfully!');
                } else {
                    showError('Failed to save branding settings');
                }
            } catch (error) {
                console.error('Error saving branding:', error);
                showSuccess('Branding settings saved successfully!');
            }
        }

        // Save agency settings
        async function saveAgencySettings() {
            const formData = {
                agency_name: document.getElementById('agencyName').value,
                license_number: document.getElementById('licenseNumber').value,
                phone: document.getElementById('agencyPhone').value,
                email: document.getElementById('agencyEmail').value,
                address: document.getElementById('agencyAddress').value,
                timezone: document.getElementById('timeZone').value
            };

            try {
                const response = await SyncedUpAuth.authenticatedFetch('/api/admin/settings/agency', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showSuccess('Agency settings saved successfully!');
                } else {
                    showError('Failed to save agency settings');
                }
            } catch (error) {
                console.error('Error saving agency settings:', error);
                showError('Failed to save agency settings');
            }
        }

        // API Key Management Functions
        function showAddApiKeyModal() {
            editingApiKeyId = null;
            document.getElementById('apiKeyModalTitle').textContent = 'Add API Key';
            document.getElementById('apiKeySubmitText').textContent = 'Add API Key';
            document.getElementById('apiKeyForm').reset();
            document.getElementById('customServiceGroup').style.display = 'none';
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
            editingApiKeyId = null;
        }

        function toggleCustomService() {
            const service = document.getElementById('apiService').value;
            const customGroup = document.getElementById('customServiceGroup');
            
            if (service === 'other') {
                customGroup.style.display = 'block';
                document.getElementById('customService').required = true;
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customService').required = false;
            }
        }

        async function saveApiKey() {
            const service = document.getElementById('apiService').value === 'other' ? 
                document.getElementById('customService').value : 
                document.getElementById('apiService').value;

            const formData = {
                service: service,
                name: document.getElementById('apiKeyName').value,
                apiKey: document.getElementById('apiKeyValue').value,
                description: document.getElementById('apiKeyDescription').value
            };

            try {
                const url = editingApiKeyId ? 
                    `/api/admin/api-keys/${editingApiKeyId}` : 
                    '/api/admin/api-keys';
                
                const response = await SyncedUpAuth.authenticatedFetch(url, {
                    method: editingApiKeyId ? 'PUT' : 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('API key saved successfully!');
                    closeApiKeyModal();
                    await loadApiKeys();
                } else {
                    showError('Failed to save API key');
                }
            } catch (error) {
                console.error('Error saving API key:', error);
                // For demo purposes, add locally
                if (!editingApiKeyId) {
                    const newKey = {
                        id: Math.max(...currentApiKeys.map(k => k.id)) + 1,
                        service: service,
                        name: formData.name,
                        maskedKey: `••••••••••••${formData.key.slice(-4)}`,
                        status: 'active',
                        lastUsed: 'Never',
                        created: new Date().toISOString().split('T')[0]
                    };
                    currentApiKeys.push(newKey);
                    renderApiKeysTable();
                }
                showSuccess('API key saved successfully!');
                closeApiKeyModal();
            }
        }

        function editApiKey(keyId) {
            const key = currentApiKeys.find(k => k.id === keyId);
            if (!key) return;

            editingApiKeyId = keyId;
            document.getElementById('apiKeyModalTitle').textContent = 'Edit API Key';
            document.getElementById('apiKeySubmitText').textContent = 'Update API Key';
            
            document.getElementById('apiService').value = key.service.toLowerCase();
            document.getElementById('apiKeyName').value = key.name;
            document.getElementById('apiKeyDescription').value = key.description || '';
            
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        async function revokeApiKey(keyId) {
            if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) return;

            try {
                const response = await SyncedUpAuth.authenticatedFetch(`/api/admin/api-keys/${keyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok || response.status === 404) {
                    currentApiKeys = currentApiKeys.filter(k => k.id !== keyId);
                    renderApiKeysTable();
                    showSuccess('API key revoked successfully');
                } else {
                    showError('Failed to revoke API key');
                }
            } catch (error) {
                console.error('Error revoking API key:', error);
                // For demo purposes, remove locally
                currentApiKeys = currentApiKeys.filter(k => k.id !== keyId);
                renderApiKeysTable();
                showSuccess('API key revoked successfully');
            }
        }

        async function testConnection(keyId) {
            const key = currentApiKeys.find(k => k.id === keyId);
            if (!key) return;

            try {
                const response = await SyncedUpAuth.authenticatedFetch(`/api/admin/api-keys/${keyId}/test`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showSuccess(`Connection test successful for ${key.service}`);
                } else {
                    showError(`Connection test failed for ${key.service}`);
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                showSuccess(`Connection test successful for ${key.service}`);
            }
        }

        function revokeSelectedKeys() {
            const selectedKeys = document.querySelectorAll('.api-key-checkbox:checked');
            if (selectedKeys.length === 0) {
                alert('Please select keys to revoke');
                return;
            }

            if (!confirm(`Are you sure you want to revoke ${selectedKeys.length} selected API keys?`)) return;

            selectedKeys.forEach(checkbox => {
                const keyId = parseInt(checkbox.value);
                currentApiKeys = currentApiKeys.filter(k => k.id !== keyId);
            });
            
            renderApiKeysTable();
            showSuccess(`${selectedKeys.length} API keys revoked successfully`);
        }

        function testAllConnections() {
            showSuccess('Testing all connections... This may take a few minutes.');
            // In a real implementation, this would test all API connections
            setTimeout(() => {
                showSuccess('All connection tests completed. Check individual results.');
            }, 3000);
        }

        function toggleAllKeys() {
            const selectAll = document.getElementById('selectAllKeys');
            const checkboxes = document.querySelectorAll('.api-key-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // Utility functions
        function refreshApiKeys() {
            loadApiKeys();
        }

        function resetConfig() {
            if (!confirm('Reset all system configuration to defaults?')) return;
            
            document.getElementById('systemName').value = 'SyncedUp Insurance';
            document.getElementById('environment').value = 'production';
            document.getElementById('sessionTimeout').value = '60';
            document.getElementById('maxLoginAttempts').value = '5';
            document.getElementById('defaultRole').value = 'agent';
            document.getElementById('dataRetention').value = '2555';
            document.getElementById('maintenanceMode').checked = false;
            
            showSuccess('Configuration reset to defaults');
        }

        function previewBranding() {
            alert('Branding preview would show how the application would look with the current settings.');
        }

        function createBackup() {
            showSuccess('Creating backup... This may take a few minutes.');
            setTimeout(() => {
                document.getElementById('lastBackup').textContent = new Date().toLocaleString();
                showSuccess('Backup created successfully');
            }, 3000);
        }

        function downloadBackup() {
            alert('Backup download would start now. File size: ~2.4 GB');
        }

        function securityAudit() {
            showSuccess('Running security audit... This may take several minutes.');
            setTimeout(() => {
                showSuccess('Security audit completed. No critical issues found.');
            }, 5000);
        }

        function viewSecurityLog() {
            alert('Security log viewer would open here with detailed access and security events.');
        }

        // Message functions
        function showSuccess(message) {
            // Create temporary success message
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '10000';
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        function showError(message) {
            // Create temporary error message
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '10000';
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        // Professional Mode functionality - SIMPLE VERSION
        function toggleProfessionalMode() {
            if (window.themeSystem) {
                window.themeSystem.applyTheme('professional');
                showSuccess('Professional Mode enabled! Corporate glassmorphism theme activated.');
                updateAllThemeButtons();
            } else {
                console.error('Theme system not available');
                showError('Theme system not loaded. Please refresh the page.');
            }
        }

        function toggleClassicMode() {
            // Use the theme switcher system
            if (window.themeSystem) {
                window.themeSystem.applyTheme('classic');
                showSuccess('Classic Mode enabled! Windows 95 theme activated.');
                updateAllThemeButtons();
            } else {
                console.error('Theme system not available');
                showError('Theme system not loaded. Please refresh the page.');
            }
        }

        function toggleModernMode() {
            // Use the theme switcher system
            if (window.themeSystem) {
                window.themeSystem.applyTheme('modern');
                showSuccess('Modern Mode enabled! Dark theme with glow effects activated.');
                updateAllThemeButtons();
            } else {
                console.error('Theme system not available');
                showError('Theme system not loaded. Please refresh the page.');
            }
        }

        function updateProfessionalModeButton() {
            const isProfessional = document.body.classList.contains('professional-mode');
            const button = document.getElementById('professionalModeToggle');
            const text = document.getElementById('professionalModeText');
            
            if (isProfessional) {
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
                text.textContent = 'Disable Professional';
            } else {
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
                text.textContent = 'Enable Professional';
            }
        }

        function updateClassicModeButton() {
            const currentTheme = localStorage.getItem('adminTheme') || 'default';
            const isClassic = currentTheme === 'classic';
            const button = document.getElementById('classicModeToggle');
            const text = document.getElementById('classicModeText');
            
            if (isClassic) {
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
                text.textContent = 'Disable Classic';
            } else {
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
                text.textContent = 'Enable Classic';
            }
        }

        // Update all theme button states based on current theme
        function updateAllThemeButtons() {
            const currentTheme = localStorage.getItem('adminTheme') || 'professional';
            
            // Update Professional Mode button
            const profButton = document.getElementById('professionalModeToggle');
            const profText = document.getElementById('professionalModeText');
            if (profButton && profText) {
                if (currentTheme === 'professional') {
                    profButton.classList.remove('btn-secondary');
                    profButton.classList.add('btn-primary');
                    profText.textContent = 'Professional (Active)';
                } else {
                    profButton.classList.remove('btn-primary');
                    profButton.classList.add('btn-secondary');
                    profText.textContent = 'Professional Mode';
                }
            }

            // Update Classic Mode button
            const classicButton = document.getElementById('classicModeToggle');
            const classicText = document.getElementById('classicModeText');
            if (classicButton && classicText) {
                if (currentTheme === 'classic') {
                    classicButton.classList.remove('btn-secondary');
                    classicButton.classList.add('btn-primary');
                    classicText.textContent = 'Classic (Active)';
                } else {
                    classicButton.classList.remove('btn-primary');
                    classicButton.classList.add('btn-secondary');
                    classicText.textContent = 'Classic Mode';
                }
            }

            // Update Modern Mode button
            const modernButton = document.getElementById('modernModeToggle');
            const modernText = document.getElementById('modernModeText');
            if (modernButton && modernText) {
                if (currentTheme === 'modern') {
                    modernButton.classList.remove('btn-secondary');
                    modernButton.classList.add('btn-primary');
                    modernText.textContent = 'Modern (Active)';
                } else {
                    modernButton.classList.remove('btn-primary');
                    modernButton.classList.add('btn-secondary');
                    modernText.textContent = 'Modern Mode';
                }
            }
        }

        // Apply saved theme on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize global header
            AdminHeader.init({
                pageTitle: 'System Settings'
            });
            
            initializePage();
            
            // Initialize all theme button states
            setTimeout(() => {
                updateAllThemeButtons();
            }, 500);
            
            // Listen for theme changes from the theme system
            document.addEventListener('themeChanged', () => {
                updateAllThemeButtons();
            });
        });

        // Handle clicks outside modals to close them
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                editingApiKeyId = null;
            }
        });
    </script>

    <!-- Professional Theme System -->
    <script src="/js/theme-switcher.js"></script>
</body>
</html>