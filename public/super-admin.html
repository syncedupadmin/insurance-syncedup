<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Administrator Console - SyncedUp Insurance</title>
    
    <!-- Enhanced Super Admin Security Check -->
    <script>
        (function () {
          const token = localStorage.getItem('syncedup_token');
          const u = JSON.parse(localStorage.getItem('syncedup_user') || '{}');
          const normalize = r => ({'super-admin':'super_admin','customer-service':'customer_service'}[r] || r);
          const role = normalize(u.role || '');
          
          // Only allow super_admin role
          if (!token || role !== 'super_admin') {
            alert('Unauthorized access. Super Admin privileges required.');
            window.location.href = '/login';
            return;
          }
          
          // Additional security check for production super admin
          const email = u.email || '';
          const isProductionSuperAdmin = email === 'admin@syncedupsolutions.com';
          const isDemoSuperAdmin = email.includes('demo.com');
          
          if (!isProductionSuperAdmin && !isDemoSuperAdmin) {
            console.warn('Non-standard super admin access attempt:', email);
            // Log the attempt but allow access for now
          }
          
          // Log super admin access
          console.log(`SUPER ADMIN ACCESS: ${email} at ${new Date().toISOString()}`);
          
          // Set security indicator
          sessionStorage.setItem('superAdminAccess', 'true');
          sessionStorage.setItem('superAdminUser', email);
        })();
    </script>
    
    <style>
        :root {
            --primary-dark: #0a0f1c;
            --secondary-dark: #141b2d;
            --accent-blue: #1e3a5f;
            --text-primary: #e0e6ed;
            --text-secondary: #a4a9b3;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(20, 27, 45, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .admin-console {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .console-header {
            grid-column: 1 / -1;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
        }

        .console-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .admin-navigation {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 2rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 2rem;
            padding: 0 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .nav-section a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-section a:hover {
            background: rgba(30, 58, 95, 0.5);
        }

        .nav-section a.active {
            background: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        }

        .dashboard-grid {
            padding: 2rem;
            overflow-y: auto;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .metric-card h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .metric-sub {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .system-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .health-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .health-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .health-status {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
        }

        .health-status.operational {
            background: var(--success);
            color: white;
        }

        .health-status.error {
            background: var(--danger);
            color: white;
        }

        .health-status.checking {
            background: var(--warning);
            color: white;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .perf-metric {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .perf-metric label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .perf-metric span {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .audit-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .audit-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .audit-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-operational { color: var(--success); font-weight: 600; }
        .status-error { color: var(--danger); font-weight: 600; }
        .status-warning { color: var(--warning); font-weight: 600; }

        .critical-alert {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .alert-title {
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 0.5rem;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .loading {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .admin-console {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            
            .admin-navigation {
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 1rem;
                overflow-x: auto;
            }
            
            .nav-section {
                display: inline-block;
                margin-right: 2rem;
                margin-bottom: 0;
            }
        }

        @media (max-width: 768px) {
            .metrics-row {
                grid-template-columns: 1fr;
            }
            
            .health-grid, .performance-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-console">
        <header class="console-header">
            <h1>System Administrator Console</h1>
            <div class="header-meta">
                <div class="session-info">
                    <span>Administrator: <span id="admin-email" class="loading">Loading...</span></span>
                    <span>Session: <span id="session-time">00:00</span></span>
                    <span>System Status: <span id="system-status">CHECKING</span></span>
                </div>
            </div>
        </header>

        <nav class="admin-navigation">
            <div class="nav-section">
                <h3>System Overview</h3>
                <a href="#" class="active" onclick="loadDashboard()">Executive Dashboard</a>
                <a href="#" onclick="loadAnalytics()">Business Intelligence</a>
                <a href="#" onclick="loadMonitoring()">System Monitoring</a>
                <a href="#" onclick="loadFullAuditLog()">Complete Audit Trail</a>
            </div>
            
            <div class="nav-section">
                <h3>User Administration</h3>
                <a href="#" onclick="loadUserManagement()">User Management</a>
                <a href="#" onclick="loadAgencyControl()">Agency Control</a>
                <a href="#" onclick="loadAccessControl()">Access Control</a>
                <a href="#" onclick="loadActiveSessions()">Active Sessions</a>
            </div>
            
            <div class="nav-section">
                <h3>Financial Control</h3>
                <a href="#" onclick="loadCommissionManagement()">Commission Management</a>
                <a href="#" onclick="loadTransactionLedger()">Transaction Ledger</a>
                <a href="#" onclick="loadReconciliation()">Reconciliation</a>
                <a href="#" onclick="loadFinancialReports()">Financial Reports</a>
            </div>
            
            <div class="nav-section">
                <h3>System Configuration</h3>
                <a href="#" onclick="loadSystemSettings()">System Settings</a>
                <a href="#" onclick="loadIntegrations()">API Integrations</a>
                <a href="#" onclick="loadDatabaseManagement()">Database Management</a>
                <a href="#" onclick="loadSecurityConfiguration()">Security Configuration</a>
            </div>
            
            <div class="nav-section">
                <h3>Operations</h3>
                <a href="#" onclick="loadBackupManagement()">Backup Management</a>
                <a href="#" onclick="loadMaintenanceMode()">Maintenance Mode</a>
                <a href="#" onclick="loadEmergencyProcedures()">Emergency Procedures</a>
                <a href="#" onclick="loadSystemLogs()">System Logs</a>
                <a href="#" onclick="logout()">Secure Logout</a>
            </div>
        </nav>

        <main class="dashboard-grid">
            <!-- Critical System Alerts -->
            <div class="critical-alert" id="critical-alert">
                <div class="alert-title">CRITICAL SYSTEM ALERT</div>
                <div id="alert-message"></div>
            </div>

            <!-- Critical Business Metrics -->
            <section class="metrics-row">
                <div class="metric-card">
                    <h4>Total System Users</h4>
                    <div class="metric-value" id="total-users" class="loading">--</div>
                    <div class="metric-sub">Across all agencies</div>
                </div>
                <div class="metric-card">
                    <h4>Active Sessions</h4>
                    <div class="metric-value" id="active-sessions" class="loading">--</div>
                    <div class="metric-sub">Current connections</div>
                </div>
                <div class="metric-card">
                    <h4>System Uptime</h4>
                    <div class="metric-value" id="system-uptime" class="loading">--</div>
                    <div class="metric-sub">Availability percentage</div>
                </div>
                <div class="metric-card">
                    <h4>Total Revenue Processed</h4>
                    <div class="metric-value" id="total-revenue" class="loading">--</div>
                    <div class="metric-sub">Lifetime processed</div>
                </div>
            </section>

            <!-- System Health Monitoring -->
            <section class="system-section">
                <h3 class="section-title">Critical System Health</h3>
                <div class="health-grid">
                    <div class="health-item">
                        <span class="health-label">Database Cluster</span>
                        <span class="health-status checking" id="db-health">CHECKING</span>
                    </div>
                    <div class="health-item">
                        <span class="health-label">API Gateway</span>
                        <span class="health-status checking" id="api-health">CHECKING</span>
                    </div>
                    <div class="health-item">
                        <span class="health-label">Convoso Integration</span>
                        <span class="health-status checking" id="convoso-health">CHECKING</span>
                    </div>
                    <div class="health-item">
                        <span class="health-label">Email Service</span>
                        <span class="health-status checking" id="email-health">CHECKING</span>
                    </div>
                    <div class="health-item">
                        <span class="health-label">Authentication Service</span>
                        <span class="health-status checking" id="auth-health">CHECKING</span>
                    </div>
                    <div class="health-item">
                        <span class="health-label">File Storage</span>
                        <span class="health-status checking" id="storage-health">CHECKING</span>
                    </div>
                </div>
            </section>

            <!-- Performance Metrics -->
            <section class="system-section">
                <h3 class="section-title">Performance Metrics (24 Hour Average)</h3>
                <div class="performance-grid">
                    <div class="perf-metric">
                        <label>API Response Time</label>
                        <span id="api-response-time" class="loading">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <label>Database Query Time</label>
                        <span id="db-query-time" class="loading">-- ms</span>
                    </div>
                    <div class="perf-metric">
                        <label>Error Rate</label>
                        <span id="error-rate" class="loading">--%</span>
                    </div>
                    <div class="perf-metric">
                        <label>Request Volume</label>
                        <span id="request-volume" class="loading">--</span>
                    </div>
                    <div class="perf-metric">
                        <label>CPU Utilization</label>
                        <span id="cpu-usage" class="loading">--%</span>
                    </div>
                    <div class="perf-metric">
                        <label>Memory Usage</label>
                        <span id="memory-usage" class="loading">--%</span>
                    </div>
                </div>
            </section>

            <!-- Administrator Audit Trail -->
            <section class="system-section">
                <h3 class="section-title">Recent Administrator Actions (Audit Trail)</h3>
                <table class="audit-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Target Resource</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="recent-audit-logs">
                        <tr><td colspan="6" class="loading">Loading audit trail...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        // ENTERPRISE SUPER ADMIN CONSOLE - COMPLETE AUDIT LOGGING
        const API_BASE = '/api/super-admin';
        let sessionStartTime = Date.now();
        let auditWebSocket = null;
        let currentUser = null;

        // Initialize the entire admin console
        async function initializeAdminConsole() {
            try {
                // Verify super admin authentication
                const token = localStorage.getItem('syncedup_token');
                const user = JSON.parse(localStorage.getItem('syncedup_user') || '{}');
                
                if (!token || !user.email) {
                    await logSecurityEvent('UNAUTHORIZED_ACCESS_ATTEMPT', 'No valid token found');
                    window.location.href = '/login';
                    return;
                }

                if (user.role !== 'super-admin' && user.role !== 'super_admin') {
                    await logSecurityEvent('INSUFFICIENT_PRIVILEGES', `User ${user.email} attempted super admin access with role: ${user.role}`);
                    window.location.href = '/login';
                    return;
                }

                currentUser = user;
                document.getElementById('admin-email').textContent = user.email;

                // Log successful console access
                await logAdminAction('CONSOLE_ACCESS', 'Super Admin Console accessed successfully');

                // Start session timer and security monitoring
                startSessionTimer();
                
                // Load all critical system data
                await Promise.all([
                    loadSystemMetrics(),
                    loadSystemHealth(),
                    loadPerformanceMetrics(),
                    loadRecentAuditLogs()
                ]);

                // Establish real-time monitoring
                establishRealTimeMonitoring();
                
                // Set up periodic health checks
                setInterval(loadSystemHealth, 30000);
                setInterval(loadPerformanceMetrics, 60000);
                setInterval(loadRecentAuditLogs, 120000);

                document.getElementById('system-status').textContent = 'OPERATIONAL';
                
            } catch (error) {
                console.error('Console initialization error:', error);
                await logAdminAction('CONSOLE_INIT_ERROR', `Failed to initialize console: ${error.message}`);
            }
        }

        // CRITICAL: Log every administrator action with complete audit trail
        async function logAdminAction(action, details, targetResource = null) {
            const auditEntry = {
                admin_id: currentUser?.id,
                admin_email: currentUser?.email,
                action,
                details,
                target_resource: targetResource,
                ip_address: await getClientIP(),
                user_agent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                session_id: sessionStartTime.toString(),
                screen_resolution: `${window.screen.width}x${window.screen.height}`,
                browser_language: navigator.language,
                referrer: document.referrer
            };

            try {
                const response = await fetch(`${API_BASE}/audit/log`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(auditEntry)
                });

                if (!response.ok) {
                    throw new Error(`Audit logging failed: ${response.status}`);
                }
            } catch (error) {
                console.error('CRITICAL: Audit logging failed:', error);
                // Store failed logs locally for manual review
                const failedLogs = JSON.parse(localStorage.getItem('failed_audit_logs') || '[]');
                failedLogs.push(auditEntry);
                localStorage.setItem('failed_audit_logs', JSON.stringify(failedLogs));
            }
        }

        // Log security events (separate from admin actions)
        async function logSecurityEvent(eventType, details) {
            try {
                await fetch(`${API_BASE}/security/log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        details,
                        ip_address: await getClientIP(),
                        user_agent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Security logging failed:', error);
            }
        }

        // Get client IP address for security logging
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        // Load real system metrics from APIs
        async function loadSystemMetrics() {
            await logAdminAction('METRICS_VIEWED', 'System metrics dashboard accessed');
            
            try {
                const response = await fetch(`${API_BASE}/metrics/system`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}`
                    }
                });
                
                if (response.ok) {
                    const metrics = await response.json();
                    document.getElementById('total-users').textContent = metrics.totalUsers?.toLocaleString() || '0';
                    document.getElementById('active-sessions').textContent = metrics.activeSessions?.toLocaleString() || '0';
                    document.getElementById('system-uptime').textContent = `${metrics.uptime || 0}%`;
                    document.getElementById('total-revenue').textContent = `$${(metrics.totalRevenue || 0).toLocaleString()}`;
                } else {
                    throw new Error(`API responded with status ${response.status}`);
                }
            } catch (error) {
                await logAdminAction('METRICS_LOAD_ERROR', `Failed to load system metrics: ${error.message}`);
                // Show error state, no fake data
                document.getElementById('total-users').textContent = 'ERROR';
                document.getElementById('active-sessions').textContent = 'ERROR';
                document.getElementById('system-uptime').textContent = 'ERROR';
                document.getElementById('total-revenue').textContent = 'ERROR';
            }
        }

        // Monitor critical system health
        async function loadSystemHealth() {
            const healthChecks = [
                { id: 'db-health', endpoint: '/health/database', name: 'Database' },
                { id: 'api-health', endpoint: '/health/api', name: 'API Gateway' },
                { id: 'convoso-health', endpoint: '/health/convoso', name: 'Convoso' },
                { id: 'email-health', endpoint: '/health/email', name: 'Email Service' },
                { id: 'auth-health', endpoint: '/health/auth', name: 'Authentication' },
                { id: 'storage-health', endpoint: '/health/storage', name: 'Storage' }
            ];
            
            for (const check of healthChecks) {
                try {
                    const response = await fetch(`${API_BASE}${check.endpoint}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}`
                        }
                    });
                    
                    const element = document.getElementById(check.id);
                    if (response.ok) {
                        element.textContent = 'OPERATIONAL';
                        element.className = 'health-status operational';
                    } else {
                        element.textContent = 'ERROR';
                        element.className = 'health-status error';
                        await logAdminAction('HEALTH_CHECK_FAILED', `${check.name} health check failed with status ${response.status}`);
                    }
                    
                } catch (error) {
                    const element = document.getElementById(check.id);
                    element.textContent = 'OFFLINE';
                    element.className = 'health-status error';
                    await logAdminAction('HEALTH_CHECK_ERROR', `${check.name} health check error: ${error.message}`);
                }
            }
        }

        // Load performance metrics
        async function loadPerformanceMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics/performance`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}`
                    }
                });
                
                if (response.ok) {
                    const perf = await response.json();
                    document.getElementById('api-response-time').textContent = `${perf.avgResponseTime || 0} ms`;
                    document.getElementById('db-query-time').textContent = `${perf.avgQueryTime || 0} ms`;
                    document.getElementById('error-rate').textContent = `${perf.errorRate || 0}%`;
                    document.getElementById('request-volume').textContent = (perf.requestVolume || 0).toLocaleString();
                    document.getElementById('cpu-usage').textContent = `${perf.cpuUsage || 0}%`;
                    document.getElementById('memory-usage').textContent = `${perf.memoryUsage || 0}%`;
                } else {
                    throw new Error(`Performance API failed with status ${response.status}`);
                }
            } catch (error) {
                await logAdminAction('PERFORMANCE_METRICS_ERROR', `Failed to load performance metrics: ${error.message}`);
                // Show error state
                document.getElementById('api-response-time').textContent = 'ERROR';
                document.getElementById('db-query-time').textContent = 'ERROR';
                document.getElementById('error-rate').textContent = 'ERROR';
                document.getElementById('request-volume').textContent = 'ERROR';
                document.getElementById('cpu-usage').textContent = 'ERROR';
                document.getElementById('memory-usage').textContent = 'ERROR';
            }
        }

        // Load recent audit logs for display
        async function loadRecentAuditLogs() {
            try {
                const response = await fetch(`${API_BASE}/audit/recent?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('syncedup_token')}`
                    }
                });
                
                if (response.ok) {
                    const logs = await response.json();
                    const tbody = document.getElementById('recent-audit-logs');
                    
                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6">No recent administrator actions</td></tr>';
                    } else {
                        tbody.innerHTML = logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td>${log.action}</td>
                                <td>${log.target_resource || 'N/A'}</td>
                                <td>${log.ip_address || 'Unknown'}</td>
                                <td class="status-${log.status ? log.status.toLowerCase() : 'operational'}">
                                    ${log.status || 'SUCCESS'}
                                </td>
                                <td>${log.details || ''}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    throw new Error(`Audit API failed with status ${response.status}`);
                }
            } catch (error) {
                await logAdminAction('AUDIT_LOG_ERROR', `Failed to load audit logs: ${error.message}`);
                document.getElementById('recent-audit-logs').innerHTML = 
                    '<tr><td colspan="6">Error loading audit trail</td></tr>';
            }
        }

        // Session timer with auto-logout for security
        function startSessionTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('session-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Auto-logout after 30 minutes for security
                if (minutes >= 30) {
                    logAdminAction('AUTO_LOGOUT', 'Session timeout after 30 minutes - security policy');
                    localStorage.removeItem('syncedup_token');
                    localStorage.removeItem('syncedup_user');
                    window.location.href = '/login';
                }
            }, 1000);
        }

        // Real-time monitoring via WebSocket
        function establishRealTimeMonitoring() {
            try {
                const wsUrl = window.location.protocol === 'https:' 
                    ? `wss://${window.location.host}/ws/super-admin`
                    : `ws://${window.location.host}/ws/super-admin`;
                
                auditWebSocket = new WebSocket(wsUrl);
                
                auditWebSocket.onopen = () => {
                    logAdminAction('WEBSOCKET_CONNECTED', 'Real-time monitoring established');
                };
                
                auditWebSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'audit_log') {
                        prependAuditLog(data.log);
                    } else if (data.type === 'critical_alert') {
                        showCriticalAlert(data.message, data.severity);
                    }
                };
                
                auditWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    logAdminAction('WEBSOCKET_ERROR', `Real-time monitoring error: ${error.message || 'Connection failed'}`);
                };
                
            } catch (error) {
                console.error('WebSocket setup failed:', error);
            }
        }

        // Navigation functions (all with audit logging)
        async function loadDashboard() {
            await logAdminAction('NAVIGATION', 'Navigated to Executive Dashboard');
            // Dashboard already loaded - this is the main view
        }

        async function loadAnalytics() {
            await logAdminAction('NAVIGATION', 'Accessed Business Intelligence Analytics');
            alert('Business Intelligence module will be loaded here');
        }

        async function loadMonitoring() {
            await logAdminAction('NAVIGATION', 'Accessed System Monitoring');
            alert('System Monitoring module will be loaded here');
        }

        async function loadFullAuditLog() {
            await logAdminAction('NAVIGATION', 'Accessed Complete Audit Trail');
            alert('Complete Audit Trail will be loaded here');
        }

        async function loadUserManagement() {
            await logAdminAction('NAVIGATION', 'Accessed User Management');
            alert('User Management module will be loaded here');
        }

        async function loadAgencyControl() {
            await logAdminAction('NAVIGATION', 'Accessed Agency Control');
            alert('Agency Control module will be loaded here');
        }

        async function loadAccessControl() {
            await logAdminAction('NAVIGATION', 'Accessed Access Control');
            alert('Access Control module will be loaded here');
        }

        async function loadActiveSessions() {
            await logAdminAction('NAVIGATION', 'Accessed Active Sessions');
            alert('Active Sessions module will be loaded here');
        }

        async function loadCommissionManagement() {
            await logAdminAction('NAVIGATION', 'Accessed Commission Management');
            alert('Commission Management module will be loaded here');
        }

        async function loadTransactionLedger() {
            await logAdminAction('NAVIGATION', 'Accessed Transaction Ledger');
            alert('Transaction Ledger module will be loaded here');
        }

        async function loadReconciliation() {
            await logAdminAction('NAVIGATION', 'Accessed Reconciliation');
            alert('Reconciliation module will be loaded here');
        }

        async function loadFinancialReports() {
            await logAdminAction('NAVIGATION', 'Accessed Financial Reports');
            alert('Financial Reports module will be loaded here');
        }

        async function loadSystemSettings() {
            await logAdminAction('NAVIGATION', 'Accessed System Settings');
            alert('System Settings module will be loaded here');
        }

        async function loadIntegrations() {
            await logAdminAction('NAVIGATION', 'Accessed API Integrations');
            alert('API Integrations module will be loaded here');
        }

        async function loadDatabaseManagement() {
            await logAdminAction('NAVIGATION', 'Accessed Database Management');
            alert('Database Management module will be loaded here');
        }

        async function loadSecurityConfiguration() {
            await logAdminAction('NAVIGATION', 'Accessed Security Configuration');
            alert('Security Configuration module will be loaded here');
        }

        async function loadBackupManagement() {
            await logAdminAction('NAVIGATION', 'Accessed Backup Management');
            alert('Backup Management module will be loaded here');
        }

        async function loadMaintenanceMode() {
            await logAdminAction('NAVIGATION', 'Accessed Maintenance Mode');
            alert('Maintenance Mode module will be loaded here');
        }

        async function loadEmergencyProcedures() {
            await logAdminAction('NAVIGATION', 'Accessed Emergency Procedures');
            alert('Emergency Procedures module will be loaded here');
        }

        async function loadSystemLogs() {
            await logAdminAction('NAVIGATION', 'Accessed System Logs');
            alert('System Logs module will be loaded here');
        }

        // Secure logout with audit trail
        async function logout() {
            if (confirm('Are you sure you want to end your administrator session?')) {
                await logAdminAction('LOGOUT', 'Administrator logged out voluntarily');
                
                if (auditWebSocket) {
                    auditWebSocket.close();
                }
                
                localStorage.removeItem('syncedup_token');
                localStorage.removeItem('syncedup_user');
                window.location.href = '/login';
            } else {
                await logAdminAction('LOGOUT_CANCELLED', 'Administrator cancelled logout');
            }
        }

        // Show critical system alerts
        function showCriticalAlert(message, severity) {
            const alertDiv = document.getElementById('critical-alert');
            const messageDiv = document.getElementById('alert-message');
            messageDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            logAdminAction('CRITICAL_ALERT', `System alert displayed: ${message} (${severity})`);
            
            // Auto-hide after 10 seconds unless it's critical
            if (severity !== 'critical') {
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Prepend new audit log to table
        function prependAuditLog(log) {
            const tbody = document.getElementById('recent-audit-logs');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${new Date(log.timestamp).toLocaleString()}</td>
                <td>${log.action}</td>
                <td>${log.target_resource || 'N/A'}</td>
                <td>${log.ip_address || 'Unknown'}</td>
                <td class="status-${log.status ? log.status.toLowerCase() : 'operational'}">
                    ${log.status || 'SUCCESS'}
                </td>
                <td>${log.details || ''}</td>
            `;
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Keep only latest 10 rows
            while (tbody.children.length > 10) {
                tbody.removeChild(tbody.lastChild);
            }
        }

        // Initialize console when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeAdminConsole);

        // Log navigation away from console
        window.addEventListener('beforeunload', () => {
            logAdminAction('CONSOLE_EXIT', `Administrator navigated away from console to: ${window.location.pathname}`);
        });

        // Security: Detect developer tools
        let devtools = {open: false};
        setInterval(function() {
            if (window.outerHeight - window.innerHeight > 150 || window.outerWidth - window.innerWidth > 150) {
                if (!devtools.open) {
                    devtools.open = true;
                    logSecurityEvent('DEVELOPER_TOOLS_OPENED', 'Developer tools detected during admin session');
                }
            } else {
                devtools.open = false;
            }
        }, 500);
    </script>
</body>
</html>