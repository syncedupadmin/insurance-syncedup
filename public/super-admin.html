<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - SyncedUp Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/global-styles.css">
    <style>
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #ffffff; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 0.75rem; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px; 
            color: white;
        }
        .form-group input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .status-active { color: #48bb78; font-weight: 500; }
        .status-inactive { color: #f56565; font-weight: 500; }
        .actions { display: flex; gap: 0.5rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 2rem; border-radius: 8px; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: #718096; }
        .alert { padding: 1rem; margin: 1rem 0; border-radius: 6px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .search-bar { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        .search-bar input, .search-bar select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; }
    </style>
</head>
<body>
    <!-- Luxury overlay pattern -->
    <div class="luxury-overlay"></div>

    <!-- Floating orbs -->
    <div class="floating-orb w-96 h-96 bg-purple-500 -top-48 -left-48"></div>
    <div class="floating-orb w-64 h-64 bg-pink-500 top-1/2 -right-32" style="animation-delay: 5s;"></div>
    <div class="floating-orb w-80 h-80 bg-blue-500 -bottom-40 left-1/4" style="animation-delay: 10s;"></div>

    <div class="glass-card-dark p-6 mb-6">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white glow-text">Super Admin Dashboard</h1>
            <div class="flex items-center gap-4">
                <span class="text-white/80">Welcome, Super Admin</span>
                <button class="btn-glass px-4 py-2 rounded-lg" onclick="logout()">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6">
        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="stat-number" id="totalAgencies">0</div>
                <div class="text-sm opacity-70 uppercase tracking-wider">Total Agencies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAgencies">0</div>
                <div class="text-sm opacity-70 uppercase tracking-wider">Active Agencies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="text-sm opacity-70 uppercase tracking-wider">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div class="text-sm opacity-70 uppercase tracking-wider">Active Users</div>
            </div>
        </div>

        <!-- Create Agency Form -->
        <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Create New Agency</h2>
                <button class="btn-luxury px-6 py-3 rounded-lg" onclick="openCreateModal()">
                    <i class="fas fa-plus mr-2"></i>
                    Create Agency
                </button>
            </div>
            <p style="color: #718096;">Create and manage insurance agencies with admin accounts and email notifications.</p>
        </div>

        <!-- Agencies Table -->
        <div class="glass-card rounded-2xl p-6 mb-8">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Agency Management</h2>
                <button class="btn-glass px-4 py-2 rounded-lg" onclick="loadAgencies()">ðŸ”„ Refresh</button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search agencies..." onkeyup="filterAgencies()">
                <select id="statusFilter" onchange="filterAgencies()">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <select id="planFilter" onchange="filterAgencies()">
                    <option value="">All Plans</option>
                    <option value="starter">Starter</option>
                    <option value="professional">Professional</option>
                    <option value="enterprise">Enterprise</option>
                </select>
            </div>

            <div class="glass-table rounded-2xl overflow-hidden">
                <table>
                    <thead>
                        <tr>
                            <th>Agency Name</th>
                            <th>Admin</th>
                            <th>Users</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="agenciesTableBody">
                        <tr><td colspan="7" style="text-align: center;">Loading agencies...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create/Edit Agency Modal -->
    <div id="agencyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Create New Agency</h3>
            <div id="modalAlert"></div>
            
            <form id="agencyForm">
                <input type="hidden" id="agencyId">
                
                <div class="form-group">
                    <label for="agencyName">Agency Name *</label>
                    <input type="text" id="agencyName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminName">Admin Name *</label>
                        <input type="text" id="adminName" required>
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Admin Email *</label>
                        <input type="email" id="adminEmail" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="agencyPhone">Phone</label>
                        <input type="tel" id="agencyPhone">
                    </div>
                    <div class="form-group">
                        <label for="agencyWebsite">Website</label>
                        <input type="url" id="agencyWebsite" placeholder="https://">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="agencyAddress">Address</label>
                    <textarea id="agencyAddress" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="subscriptionPlan">Subscription Plan</label>
                        <select id="subscriptionPlan">
                            <option value="starter">Starter - $29/month</option>
                            <option value="professional" selected>Professional - $99/month</option>
                            <option value="enterprise">Enterprise - $299/month</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="agencyStatus">Status</label>
                        <select id="agencyStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-success">Save Agency</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h3>Reset Admin Password</h3>
            <div id="resetAlert"></div>
            
            <p style="margin-bottom: 1rem;">This will generate a new temporary password for the agency admin.</p>
            
            <div class="form-group">
                <label>Agency</label>
                <input type="text" id="resetAgencyName" readonly style="background: #f7fafc;">
            </div>
            
            <div class="form-group">
                <label>Admin Email</label>
                <input type="email" id="resetAdminEmail" readonly style="background: #f7fafc;">
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-warning" onclick="confirmPasswordReset()">Reset Password & Send Email</button>
                <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token || user.role !== 'super_admin') {
            window.location.href = '/login.html';
        }

        let agencies = [];
        let currentEditingAgency = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadAgencies();
        });

        async function loadAgencies() {
            try {
                const response = await fetch('/api/super-admin/agencies', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load agencies');
                }
                
                const data = await response.json();
                agencies = data.agencies || [];
                
                displayAgencies();
                updateStats();
                
            } catch (error) {
                console.error('Error loading agencies:', error);
                document.getElementById('agenciesTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: #f56565;">Failed to load agencies</td></tr>';
            }
        }

        function displayAgencies(filteredAgencies = null) {
            const agenciesToShow = filteredAgencies || agencies;
            const tbody = document.getElementById('agenciesTableBody');
            
            if (agenciesToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No agencies found</td></tr>';
                return;
            }

            tbody.innerHTML = agenciesToShow.map(agency => {
                const adminUser = agency.profiles?.find(p => p.role === 'admin') || agency.admin_user;
                return `
                    <tr>
                        <td>
                            <strong>${agency.name}</strong>
                            ${agency.website ? `<br><small><a href="${agency.website}" target="_blank">${agency.website}</a></small>` : ''}
                        </td>
                        <td>
                            ${adminUser ? `
                                <div>${adminUser.name}</div>
                                <div style="font-size: 0.9rem; color: #718096;">${adminUser.email}</div>
                            ` : 'No admin'}
                        </td>
                        <td>
                            <span style="font-weight: bold;">${agency.user_count || 0}</span>
                            ${agency.active_users ? `<span style="color: #48bb78;"> (${agency.active_users} active)</span>` : ''}
                        </td>
                        <td>
                            <span style="text-transform: capitalize; font-weight: 500;">
                                ${agency.subscription_plan || 'starter'}
                            </span>
                        </td>
                        <td>
                            <span class="status-${agency.is_active ? 'active' : 'inactive'}">
                                ${agency.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${new Date(agency.created_at).toLocaleDateString()}</td>
                        <td class="actions">
                            <button class="btn-glass px-4 py-2 rounded-lg" style="padding: 0.5rem; font-size: 0.8rem;" onclick="editAgency('${agency.id}')">Edit</button>
                            <button class="btn btn-warning" style="padding: 0.5rem; font-size: 0.8rem;" onclick="resetPassword('${agency.id}')">Reset PW</button>
                            <button class="btn ${agency.is_active ? 'btn-danger' : 'btn-success'}" style="padding: 0.5rem; font-size: 0.8rem;" onclick="toggleAgencyStatus('${agency.id}', ${!agency.is_active})">
                                ${agency.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('totalAgencies').textContent = agencies.length;
            document.getElementById('activeAgencies').textContent = agencies.filter(a => a.is_active).length;
            
            const totalUsers = agencies.reduce((sum, agency) => sum + (agency.user_count || 0), 0);
            const activeUsersCount = agencies.reduce((sum, agency) => sum + (agency.active_users || 0), 0);
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsersCount;
        }

        function filterAgencies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const planFilter = document.getElementById('planFilter').value;
            
            const filtered = agencies.filter(agency => {
                const matchesSearch = !searchTerm || 
                    agency.name.toLowerCase().includes(searchTerm) ||
                    (agency.admin_user && agency.admin_user.email.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && agency.is_active) ||
                    (statusFilter === 'inactive' && !agency.is_active);
                
                const matchesPlan = !planFilter || agency.subscription_plan === planFilter;
                
                return matchesSearch && matchesStatus && matchesPlan;
            });
            
            displayAgencies(filtered);
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create New Agency';
            document.getElementById('agencyForm').reset();
            document.getElementById('agencyId').value = '';
            document.getElementById('modalAlert').innerHTML = '';
            document.getElementById('agencyModal').style.display = 'block';
            currentEditingAgency = null;
        }

        async function editAgency(agencyId) {
            try {
                const response = await fetch(`/api/super-admin/agencies?agency_id=${agencyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const agency = await response.json();
                const adminUser = agency.profiles?.find(p => p.role === 'admin');
                
                document.getElementById('modalTitle').textContent = 'Edit Agency';
                document.getElementById('agencyId').value = agency.id;
                document.getElementById('agencyName').value = agency.name;
                document.getElementById('adminName').value = adminUser?.name || '';
                document.getElementById('adminEmail').value = adminUser?.email || '';
                document.getElementById('agencyPhone').value = agency.phone || '';
                document.getElementById('agencyWebsite').value = agency.website || '';
                document.getElementById('agencyAddress').value = agency.address || '';
                document.getElementById('subscriptionPlan').value = agency.subscription_plan || 'starter';
                document.getElementById('agencyStatus').value = agency.is_active.toString();
                
                document.getElementById('modalAlert').innerHTML = '';
                document.getElementById('agencyModal').style.display = 'block';
                currentEditingAgency = agency;
                
            } catch (error) {
                console.error('Error loading agency details:', error);
                alert('Failed to load agency details');
            }
        }

        async function resetPassword(agencyId) {
            const agency = agencies.find(a => a.id === agencyId);
            if (!agency) return;
            
            const adminUser = agency.profiles?.find(p => p.role === 'admin') || agency.admin_user;
            
            document.getElementById('resetAgencyName').value = agency.name;
            document.getElementById('resetAdminEmail').value = adminUser?.email || '';
            document.getElementById('resetAlert').innerHTML = '';
            document.getElementById('resetModal').style.display = 'block';
            
            window.currentResetAgency = agency;
        }

        async function confirmPasswordReset() {
            const agency = window.currentResetAgency;
            if (!agency) return;
            
            const adminUser = agency.profiles?.find(p => p.role === 'admin') || agency.admin_user;
            
            try {
                const response = await fetch('/api/super-admin/reset-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: adminUser.id,
                        send_email: true
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('resetAlert').innerHTML = 
                        '<div class="alert alert-success">Password reset successfully! New credentials sent via email.</div>';
                    setTimeout(() => closeResetModal(), 2000);
                } else {
                    document.getElementById('resetAlert').innerHTML = 
                        `<div class="alert alert-error">Error: ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error('Error resetting password:', error);
                document.getElementById('resetAlert').innerHTML = 
                    '<div class="alert alert-error">Failed to reset password</div>';
            }
        }

        async function toggleAgencyStatus(agencyId, newStatus) {
            try {
                const response = await fetch(`/api/super-admin/agencies?agency_id=${agencyId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                if (response.ok) {
                    await loadAgencies();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
                
            } catch (error) {
                console.error('Error updating agency status:', error);
                alert('Failed to update agency status');
            }
        }

        // Form submission
        document.getElementById('agencyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const isEdit = !!currentEditingAgency;
            const agencyId = document.getElementById('agencyId').value;
            
            const formData = {
                name: document.getElementById('agencyName').value,
                admin_name: document.getElementById('adminName').value,
                admin_email: document.getElementById('adminEmail').value,
                phone: document.getElementById('agencyPhone').value,
                website: document.getElementById('agencyWebsite').value,
                address: document.getElementById('agencyAddress').value,
                subscription_plan: document.getElementById('subscriptionPlan').value,
                is_active: document.getElementById('agencyStatus').value === 'true'
            };
            
            try {
                const url = isEdit ? `/api/super-admin/agencies?agency_id=${agencyId}` : '/api/super-admin/agencies';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const alertType = isEdit ? 'Agency updated successfully!' : `Agency created successfully! Admin password: <strong>${result.temp_password}</strong>`;
                    document.getElementById('modalAlert').innerHTML = 
                        `<div class="alert alert-success">${alertType}</div>`;
                    
                    await loadAgencies();
                    
                    if (!isEdit) {
                        // Show password for 10 seconds, then close modal
                        setTimeout(() => closeModal(), 10000);
                    } else {
                        setTimeout(() => closeModal(), 2000);
                    }
                    
                } else {
                    document.getElementById('modalAlert').innerHTML = 
                        `<div class="alert alert-error">Error: ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error('Error saving agency:', error);
                document.getElementById('modalAlert').innerHTML = 
                    '<div class="alert alert-error">Failed to save agency</div>';
            }
        });

        function closeModal() {
            document.getElementById('agencyModal').style.display = 'none';
            currentEditingAgency = null;
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
            window.currentResetAgency = null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const agencyModal = document.getElementById('agencyModal');
            const resetModal = document.getElementById('resetModal');
            
            if (event.target === agencyModal) {
                closeModal();
            }
            if (event.target === resetModal) {
                closeResetModal();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
